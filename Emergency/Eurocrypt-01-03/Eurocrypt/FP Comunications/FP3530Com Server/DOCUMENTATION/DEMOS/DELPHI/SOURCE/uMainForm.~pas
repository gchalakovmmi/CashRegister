unit uMainForm;

interface

uses
	Windows,
	Messages,
	SysUtils,
	Variants,
	Classes,
	Graphics,
	Controls,
	Forms,
	Dialogs,
	ComCtrls,
	FP3530_TLB,
	StdCtrls, Buttons, ExtCtrls, AppEvnts;

const
	cNewLine = #13#10;
	MY_CAPTION = 'COM Server - Example';

type
	TDatecsFDevice = (
				dt_Unknown,
				dt_DP500PLUS_KL,
				dt_DP55_KL,
				dt_MP55_KL,
				dt_DP_50_KL,
				dt_FP_1000_KL,
				dt_FP_550_KL,
				dt_FMP10_KL,
				dt_FP60_KL,
				dt_FP1000_DV,
				dt_FP300_DV,
				dt_FP550_DV,
				dt_FP60_DV,
				dt_FP2000_KL,
				dt_FP_550D_KL
			);

	TfmMainForm = class(
		TForm)
		PageControl1: TPageControl;
		tsInit: TTabSheet;
    ts_DEVICE_STATUS: TTabSheet;
    btn_INIT_EX1: TButton;
		lb_COMPORT: TLabel;
		lb_Baudrate: TLabel;
		cbx_Baudrate: TComboBox;
		cbx_COMPORT: TComboBox;
    GroupBox13: TGroupBox;
    chbx_S0_7: TCheckBox;
    chbx_S0_6: TCheckBox;
    chbx_S0_5: TCheckBox;
    chbx_S0_4: TCheckBox;
    chbx_S0_3: TCheckBox;
    chbx_S0_2: TCheckBox;
    chbx_S0_1: TCheckBox;
    chbx_S0_0: TCheckBox;
    GroupBox15: TGroupBox;
    chbx_S3_7: TCheckBox;
    chbx_S3_6: TCheckBox;
    chbx_S3_5: TCheckBox;
    chbx_S3_4: TCheckBox;
    chbx_S3_3: TCheckBox;
    chbx_S3_2: TCheckBox;
    chbx_S3_1: TCheckBox;
    chbx_S3_0: TCheckBox;
    GroupBox21: TGroupBox;
    chbx_S1_7: TCheckBox;
    chbx_S1_6: TCheckBox;
    chbx_S1_5: TCheckBox;
    chbx_S1_4: TCheckBox;
    chbx_S1_3: TCheckBox;
    chbx_S1_2: TCheckBox;
    chbx_S1_1: TCheckBox;
    chbx_S1_0: TCheckBox;
    GroupBox22: TGroupBox;
    chbx_S4_7: TCheckBox;
    chbx_S4_6: TCheckBox;
    chbx_S4_5: TCheckBox;
    chbx_S4_4: TCheckBox;
    chbx_S4_3: TCheckBox;
    chbx_S4_2: TCheckBox;
    chbx_S4_1: TCheckBox;
    chbx_S4_0: TCheckBox;
    GroupBox23: TGroupBox;
    chbx_S2_7: TCheckBox;
    chbx_S2_6: TCheckBox;
    chbx_S2_5: TCheckBox;
    chbx_S2_4: TCheckBox;
    chbx_S2_3: TCheckBox;
    chbx_S2_2: TCheckBox;
    chbx_S2_1: TCheckBox;
    chbx_S2_0: TCheckBox;
    GroupBox24: TGroupBox;
    chbx_S5_7: TCheckBox;
    chbx_S5_6: TCheckBox;
    chbx_S5_5: TCheckBox;
    chbx_S5_4: TCheckBox;
    chbx_S5_3: TCheckBox;
    chbx_S5_2: TCheckBox;
    chbx_S5_1: TCheckBox;
    chbx_S5_0: TCheckBox;
    cbx_TRGT_METHOD: TComboBox;
    btn_EXECUTE_THIS: TBitBtn;
    Label1: TLabel;
    Panel1: TPanel;
    mem_LOG: TMemo;
    ApplicationEvents1: TApplicationEvents;
    Label2: TLabel;
    cbx_PrinterModel: TComboBox;
    lb_IPADDR: TLabel;
    ed_IPADDR: TEdit;
    lb_PORT: TLabel;
    ed_PORT: TEdit;
		procedure btn_INIT_EX1Click(Sender: TObject);
		procedure FormCreate(Sender: TObject);
		procedure btn_EXECUTE_THISClick(Sender: TObject);
    procedure ApplicationEvents1SettingChange(Sender: TObject;
      Flag: Integer; const Section: String; var Result: Integer);
    procedure cbx_PrinterModelChange(Sender: TObject);
	private
		TRANSTAT_MSG : String;
		FBON_OPENED,SBON_OPENED : Boolean;
		CURRENT_TENDER : WideString;
		LAST_AMOUNT : WideString;
		CURRENT_SALESCOUNT : WideString;

		function GET_COM_EX: TStringList;
		function CALC_COMNUM: Integer;
		function GetParam(src : WideString;INDX: Byte; MySep : Char = ';'): WideString;

		procedure SHOW_MYINFO(TRGT_MESSAGE : String);
		procedure SHOW_MYALERT(TRGT_MESSAGE : String);
		function SHOW_MYQUESTION (TRGT_QUESTION : string) : Integer;

		procedure ADD_LOG(TRGT_LOG : String);
		function GET_MY_DEVICE : TDatecsFDevice;

		//SAMPLES -BEGIN

		//ERROR HANDLING
		procedure ERROR_HANDLING;
		function CHECK_AND_RESOLVE : Boolean;
		function CAN_OPEN : Boolean;
		function EMERGENSY_SITUATION : Boolean;
		function FEMERGENSY_SITUATION : Boolean;
		function SEMERGENSY_SITUATION : Boolean;
		function CHECK_ASSIGNED : Boolean;
		function CALC_ERROR(TRGT_ERRCODE : Integer) : String;

		//STATUS OF THE FISCAL DEVICE
		procedure CALC_SWITCHES;
		procedure REFRESH_SWITCHES;
		procedure INIT_SWITCHES_EX(TRGT_LANG : Integer);

		//FISCAL TRANSACTIONS
		function OPEN_FISCAL_BON : Boolean;
		function SELL_SOMETHING : Boolean;
		function SELL_CMD_49(MAJOR_VERS,MINOR_VERS : Integer;MY_PARAMS : WideString):Boolean;
		function CMD_49_0(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function CMD_49_1(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function CMD_49_2(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function CMD_49_3(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function CMD_49_4(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function CMD_49_5(MINOR_VERS: Integer;MY_PARAMS: WideString): Integer;
		function PRINT_DELIMITER : Boolean;
		function MAKE_SUBTOTAL(TRGT_PERCENT : Real) : Boolean;
		function MAKE_TOTAL : Boolean;
		function GET_LAST_DOCNUM : Boolean;
		function CLOSE_FISCAL_BON : Boolean;
		function PRINT_FISCAL_TEXT(TRGT_TEXT : WideString) : Boolean;
		function MAKE_FISCAL_TRANSACTION : Boolean;
		function CMD_70_0_0(Amount : WideString) : Integer;
		function CMD_88_0_0 : Boolean;
		function CMD_49_5_0 : Boolean;



		//NONFISCAL TRANSACTIONS
		function OPEN_NONFISCAL : Boolean;
		function PRINT_NONFISCAL_TEXT(TRGT_TEXT : WideString) : Boolean;
		function CLOSE_NONFISCAL_BON : Boolean;
		function MAKE_NONFISCAL_TRANSACTION : Boolean;

		//REPORTS
		function ZX_REPORT(TRGT_OPTION : WideString) : Boolean;
		function ZXDEP_REPORT(TRGT_OPTION : WideString) : Boolean;

		//SAMPLES - END
	public
		MyFiscDevice : TDatecsFDevice;
		//...
		FPDP55_KL: ICS_BGR_DP55_KL;
		FP2000_KL : ICS_BGR_FP2000_KL;
		FP60_KL : ICS_BGR_FP60_KL;
		FP550_KL : ICS_BGR_FP550_KL;
		FP550D_KL : ICS_BGR_FP550_D_KL;
		//...
	end;

var
	fmMainForm  : TfmMainForm;



	tmp_Bol : Boolean;
	tmp_Str : string;
	tmp_Int : Integer;
	tmp_Ext : Extended;

	S0, S1, S2, S3, S4, S5: WideString;

implementation

{$R *.dfm}

function TfmMainForm.GetParam(src: WideString; INDX: Byte; MySep: Char): WideString;
var
	i, ParEnd: Byte;
	tmpS : WideString;
begin
	tmpS:=src;
	for i := 0 to INDX - 1 do
	begin
		ParEnd := pos(MySep, tmpS);
		if ParEnd = 0 then
		begin
			Result := '';
			Exit;
		end;
		Result := Copy(tmpS, 1, ParEnd - 1);
		Delete(tmpS, 1, ParEnd);
	end;
end;

function TfmMainForm.SHOW_MYQUESTION(TRGT_QUESTION: string): Integer;
begin
	Result:= MessageBox(fmMainForm.Handle,PChar(TRGT_QUESTION),PChar(MY_CAPTION),$124);
	ADD_LOG(tmp_Str);
end;

procedure TfmMainForm.SHOW_MYALERT(TRGT_MESSAGE: string);
begin
	MessageBox(fmMainForm.Handle,PChar(TRGT_MESSAGE),PChar(MY_CAPTION),$30);
	ADD_LOG(tmp_Str);
end;

procedure TfmMainForm.SHOW_MYINFO(TRGT_MESSAGE: String);
begin
	MessageBox(fmMainForm.Handle,PChar(TRGT_MESSAGE),PChar(MY_CAPTION),$40);
	ADD_LOG(tmp_Str);
end;


function TfmMainForm.GET_MY_DEVICE: TDatecsFDevice;
begin
	//Result:=dt_Unknown;
	try
		//GET FROM YOUR PROGRAM SETTINGS the type of used device
		//from registry or ini files or ...
		case cbx_PrinterModel.ItemIndex of
			0 : Result:=dt_DP55_KL;//for example
			1 : Result:=dt_FP2000_KL;
			2 : Result:=dt_FP2000_KL;
			3 : Result:=dt_FP60_KL;
			4 : Result:=dt_FP_550_KL;
			5 : Result:=dt_FP_550D_KL;
		end;
	except
		Result:=dt_Unknown;
	end;
end;

procedure TfmMainForm.btn_INIT_EX1Click(Sender: TObject);


	function INITIALISATION_OF_DEVICE_SITUATION : boolean;
	var
		NewInstanceCreated : boolean;
	begin
		NewInstanceCreated:=false;
		try
			MyFiscDevice := GET_MY_DEVICE;
			case MyFiscDevice of
				dt_DP500PLUS_KL,
				dt_DP55_KL,
				dt_MP55_KL,
				dt_DP_50_KL:
				begin
					//CREATE INSTANCE OF ICS_BGR_DP55_KL

					//written on Delphi this is something like:
					if FPDP55_KL<>nil then FPDP55_KL:=nil;
					FPDP55_KL := CoCS_BGR_DP55_KL.Create;
					FPDP55_KL.INIT_Ex1(CALC_COMNUM, StrToInt(cbx_Baudrate.Text));
					NewInstanceCreated:= (FPDP55_KL<>nil);
					if NewInstanceCreated then
					begin
						fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_DP55_KL"';
					end;
				end;
				dt_FP_1000_KL:
				begin
					//CREATE INSTANCE OF ICS_BGR_FP1000_KL
				end;
				dt_FP_550_KL:
				begin
					//CREATE INSTANCE OF ICS_BGR_FP550_KL

					//written on Delphi this is something like:
							if FP550_KL<>nil then FP550_KL:=nil;
							FP550_KL := CoCS_BGR_FP550_KL.Create;
							FP550_KL.INIT_EX3(				 //
								CALC_COMNUM				,//:
								StrToInt(cbx_Baudrate.Text)	,//:
								3000						,//:ReadIntervalTimeout
								0						,//:ReadTotalTimeoutMultiplier
								3200						,//:ReadTotalTimeoutConstant
								3000						,//:WriteTotalTimeoutMultiplier
								3000						,//:WriteTotalTimeoutConstant
								8						,//: REPEAT_COUNT
								False					,//:MoreInstances
								False					,//:WithInputCheck
								True						,//:WithOutpCheck
								True						,//:AlwaysGetOutput
								True						//:AutoCutText
								);
							NewInstanceCreated:= (FP550_KL<>nil);
							if NewInstanceCreated then
							begin
								fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_FP550_KL"';
							end;
				end;
				dt_FMP10_KL:
				begin
					//CREATE INSTANCE OF ICS_BGR_FMP10_KL
				end;
				dt_FP1000_DV,
				dt_FP300_DV,
				dt_FP550_DV,
				dt_FP60_DV:
				begin
					//CREATE INSTANCE OF ICSFP3530
				end;
				dt_FP60_KL:
				begin
					//CREATE INSTANCE OF ICS...

					//written on Delphi this is something like:
							if FP60_KL<>nil then FP60_KL:=nil;
							FP60_KL := CoCS_BGR_FP60_KL.Create;
							FP60_KL.INIT_EX3(				 //
								CALC_COMNUM				,//:
								StrToInt(cbx_Baudrate.Text)	,//:
								3000						,//:ReadIntervalTimeout
								0						,//:ReadTotalTimeoutMultiplier
								3200						,//:ReadTotalTimeoutConstant
								3000						,//:WriteTotalTimeoutMultiplier
								3000						,//:WriteTotalTimeoutConstant
								8						,//: REPEAT_COUNT
								False					,//:MoreInstances
								False					,//:WithInputCheck
								True						,//:WithOutpCheck
								True						,//:AlwaysGetOutput
								True						//:AutoCutText
								);
							NewInstanceCreated:= (FP60_KL<>nil);
							if NewInstanceCreated then
							begin
								fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_FP60_KL"';
							end;

				end;
				dt_FP2000_KL:
				begin
					//CREATE INSTANCE OF ICS...

					//written on Delphi this is something like:
					case cbx_PrinterModel.ItemIndex of
						1:
						begin
							if FP2000_KL<>nil then FP2000_KL:=nil;
							FP2000_KL := CoCS_BGR_FP2000_KL.Create;
							//FP2000_KL.INIT_Ex1(CALC_COMNUM, StrToInt(cbx_Baudrate.Text));
							FP2000_KL.INIT_EX3(				 //
								CALC_COMNUM				,//:
								StrToInt(cbx_Baudrate.Text)	,//:
								3000						,//:ReadIntervalTimeout
								0						,//:ReadTotalTimeoutMultiplier
								3200						,//:ReadTotalTimeoutConstant
								3000						,//:WriteTotalTimeoutMultiplier
								3000						,//:WriteTotalTimeoutConstant
								8						,//: REPEAT_COUNT
								False					,//:MoreInstances
								False					,//:WithInputCheck
								True						,//:WithOutpCheck
								True						,//:AlwaysGetOutput
								True						//:AutoCutText
								);
							NewInstanceCreated:= (FP2000_KL<>nil);
							if NewInstanceCreated then
							begin
								fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_FP2000_KL"';
							end;
						end;
						2:
						begin
							if FP2000_KL<>nil then FP2000_KL:=nil;
							FP2000_KL := CoCS_BGR_FP2000_KL.Create;
							tmp_Str:=FP2000_KL.INIT_Ex2(Trim(ed_IPADDR.Text),Trim(ed_PORT.Text));
							NewInstanceCreated:= (FP2000_KL<>nil);
							if NewInstanceCreated then
							begin
								fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_FP2000_KL"(TCP/IP)';
								//ShowMessage(tmp_Str);
							end;
						end;
					end;
				end;
				dt_FP_550D_KL:
				begin
					//CREATE INSTANCE OF ICS_BGR_FP550_D_KL

					//written on Delphi this is something like:
							if FP550D_KL<>nil then FP550D_KL:=nil;
							FP550D_KL := CoCS_BGR_FP550_D_KL.Create;
							FP550D_KL.INIT_EX3(				 //
								CALC_COMNUM				,//:
								StrToInt(cbx_Baudrate.Text)	,//:
								3000						,//:ReadIntervalTimeout
								0						,//:ReadTotalTimeoutMultiplier
								3200						,//:ReadTotalTimeoutConstant
								3000						,//:WriteTotalTimeoutMultiplier
								3000						,//:WriteTotalTimeoutConstant
								8						,//: REPEAT_COUNT
								False					,//:MoreInstances
								False					,//:WithInputCheck
								True						,//:WithOutpCheck
								True						,//:AlwaysGetOutput
								True						//:AutoCutText
								);
							NewInstanceCreated:= (FP550D_KL<>nil);
							if NewInstanceCreated then
							begin
								fmMainForm.Caption:='œËÏÂ Á‡ ÛÔÓÚÂ·‡Ú‡ Ì‡ "ICS_BGR_FP550_KL"';
							end;
				end;
			end;
			Result := (MyFiscDevice<>dt_Unknown) and (NewInstanceCreated);
		except
			Result := false;
		end;
	end;

	function CHECK_SOME_ : Boolean;
	begin
		Result:=False;
		try
			case cbx_PrinterModel.ItemIndex of
				-1 :
				begin
					ShowMessage('Please set device model first !');
					PageControl1.ActivePage:=tsInit;
					if cbx_PrinterModel.Enabled then cbx_PrinterModel.SetFocus;
					Exit;
				end;
				2 :
				begin
					if cbx_PrinterModel.ItemIndex=2 then
					begin
						if (Trim(ed_IPADDR.Text)='') then
						begin
							ShowMessage('Please set ip address !');
							PageControl1.ActivePage:=tsInit;
							if ed_IPADDR.Enabled then ed_IPADDR.SetFocus;
							Exit;
						end;
						if (Trim(ed_PORT.Text)='') then
						begin
							ShowMessage('Please set port number !');
							PageControl1.ActivePage:=tsInit;
							if ed_PORT.Enabled then ed_PORT.SetFocus;
							Exit;
						end;
					end;
				end
				else
				begin
					if cbx_COMPORT.ItemIndex =-1 then
					begin
						ShowMessage('Please set comport!');
						PageControl1.ActivePage:=tsInit;
						if cbx_COMPORT.Enabled then cbx_COMPORT.SetFocus;
						Exit;
					end;
				end;
			end;
			//...
			Result:=True;
		except
			Result:=False;
		end;
	end;


begin
	if not CHECK_SOME_ then Exit;
	try
		try
			INITIALISATION_OF_DEVICE_SITUATION;
		except
			ShowMessage('TfmMainForm.btn_INIT_EX1Click - Exception');
		end;
	finally
		INIT_SWITCHES_EX(0);
		fmMainForm.Update;
	end;
end;

procedure TfmMainForm.FormCreate(Sender: TObject);

	procedure ADD_COMPORTS;
	var
		i: Integer;
	begin
		try
			try
				cbx_COMPORT.Items.Clear;
				cbx_COMPORT.Items := Get_COM_EX;
			except
				//
			end;
		finally
			if cbx_COMPORT.Items.Count = 0 then
				for i := 1 to 28 do cbx_COMPORT.Items.Add('COM ' + IntToStr(i));
		end;
	end;

begin
	ADD_COMPORTS;

	DateSeparator := '.';
	TimeSeparator := ':';
	DecimalSeparator := '.';
	ShortDateFormat := 'dd.mm.yyyy';
	ShortTimeFormat := 'hh:mm:ss';
end;

function TfmMainForm.GET_COM_EX: TStringList;
var
	ComLst : TStringList;
	max, i : integer;
	tempStr:string;
	VerInfo: TOSVersioninfo;

	procedure EnumerateDosDevices(List: TStrings);
	var
		Buffer: pChar;
		BufLen: Cardinal;
		len   : Cardinal;
		p     : PChar;
		sl    : TStringlist;
	begin
		Assert(Assigned(List));
		BufLen := High(Word);
		Buffer := AllocMem(BufLen);
		try
			repeat
				len := QueryDosDevice(nil, Buffer, Buflen - 1);
				if len = ERROR_INSUFFICIENT_BUFFER then
				begin
					BufLen := Buflen * 2;
					ReAllocMem(Buffer, BufLen);
				end;
			until len <> ERROR_INSUFFICIENT_BUFFER;
			Buffer[Len]:= #0;
			sl := TStringlist.Create;
			try
				p := Buffer;
				while p <@Buffer[Len]do
				begin
					sl.Add(p);
					p := StrEnd(p)+ 1;
				end;
				sl.Sorted := true;
				List.Assign(sl);
			finally
				sl.Free;
			end; { finally }
		finally
			FreeMem(Buffer);
		end; { finally }
	end;

	function FillCommList(List: Tstrings): integer;
	var
		Temp    : TStringlist;
		i, index: Integer;
	begin
		try
			Assert(Assigned(List));
			List.Clear;
			Temp := TStringlist.Create;
			try
				EnumerateDosDevices(Temp);
				i := 1;
				while i < 256 do
				begin
					if(Temp.Find('COM' + IntToStr(i), index))then
					begin
						List.Add('COM ' + IntToStr(i));
					end;
					inc(i);
				end;
			finally
				Temp.Free;
			end; { finally }
			Result := List.Count;

		except
			on E: Exception do raise Exception.Create('Exception in method "FillCommList":' + E.Message);
		end;

	end;

	function GET_WIN98_SERIAL(List: Tstrings): boolean;
	var
		i      : integer;
		portStr:String;
		portHND: THandle;
	begin
		Assert(Assigned(List));
		List.Clear;
		Result := false;
		try
			for i := 1 to 256 do
			begin
				portStr := Format('\\.\COM%d',[i]);
				portHND := CreateFile(PChar(portStr), GENERIC_READ or GENERIC_WRITE, 0,nil, OPEN_EXISTING, 0, 0);
				if portHND = INVALID_HANDLE_VALUE then
				begin
					// Error := GetLastError;
					// if (Error = ERROR_ACCESS_DENIED) or (Error = ERROR_ACCESS_DENIED)  then
					// Result:=1;
					CloseHandle(portHND);
				end
				else
				begin
					Result := true;
					CloseHandle(portHND);
					List.Add('COM ' + inttostr(i));
				end;
			end;
		except
			Result := False;
		end;

	end;

begin
	ComLst := TStringList.Create;
	Result := TStringList.Create;
	try
		try
			// dm_.JvCIE_.OS.OSVersion
			VerInfo.dwOSVersionInfoSize := SizeOf(TOSVersionInfo);
			GetVersionEx(VerInfo);

			if(VerInfo.dwPlatformId = VER_PLATFORM_WIN32_NT)then
			begin
				max := FillCommList(ComLst);
				if max > 0 then
					for i := 0 to max - 1 do
					begin
						tempStr := ComLst.Strings[i];
						// Delete(tempStr, 1, 3);
						Result.Add(tempStr);
					end;
			end
			else GET_WIN98_SERIAL(Result);
		except
			on E: Exception do raise Exception.Create('Exception in method "Get_COM_EX":' + E.Message);
		end;
	finally
		ComLst.Free;
	end;
end;

procedure TfmMainForm.REFRESH_SWITCHES;
begin
	if not CHECK_ASSIGNED then Exit;
	try
		try
			ADD_LOG('[CMD_74_0_1]: œŒÀ”◊¿¬¿Õ≈ Õ¿ —“¿“”—»“≈');
			case MyFiscDevice of
				dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_74_0_1(S0, S1, S2, S3, S4, S5);
				dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_74_0_1(S0, S1, S2, S3, S4, S5);
				dt_FP60_KL:tmp_Int:=FP60_KL.CMD_74_0_1(S0, S1, S2, S3, S4, S5);
				dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_74_0_1(S0, S1, S2, S3, S4, S5);
				dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_74_0_1(S0, S1, S2, S3, S4, S5);
			end;

			if tmp_Int<>0 then
			begin
				//TODO : Exception handler
				ShowMessage('Get status error... Check connection!');
				tmp_Str:=CALC_ERROR(tmp_Int);
				ShowMessage(tmp_Str);
			end
			else CALC_SWITCHES;
		except
			//TODO : Exception handler
		end;
	finally
		fmMainForm.Update;
	end;
end;



function TfmMainForm.OPEN_FISCAL_BON: Boolean;
var
	AllReceipt,FiscReceipt,OpCode ,OpPwd,TillNmb : WideString;

	procedure INIT;
	begin
		AllReceipt:='';
		FiscReceipt:='';
	end;

	function SET_PARAMS_FROM_DB : Boolean;
	begin
		try
			//GET THIS FROM YOUR DATABASE
			case MyFiscDevice of
				dt_DP55_KL:
				begin
					//This is default values for our ECR's
					OpCode:='1';
					OpPwd:='1';
					TillNmb:='1';
				end;
				dt_FP2000_KL:
				begin
					//This is default values for our printers
					OpCode:='1';
					OpPwd:='0000';
					//OpPwd:='0001'; For error example
					TillNmb:='1';
				end;
				dt_FP60_KL:
				begin
					//This is default values for our printers
					OpCode:='1';
					OpPwd:='0000';
					//OpPwd:='0001'; For error example
					TillNmb:='1';
				end;
				dt_FP_550_KL:
				begin
					//This is default values for our printers
					OpCode:='1';
					OpPwd:='0000';
					//OpPwd:='0001'; For error example
					TillNmb:='1';
				end;
				dt_FP_550D_KL:
				begin
					//This is default values for our printers
					OpCode:='1';
					OpPwd:='0000';
					//OpPwd:='0001'; For error example
					TillNmb:='1';
				end;
			end;
			Result:=True;
		except
			Result:=False;
		end;
	end;

begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		try
			INIT;
			if not SET_PARAMS_FROM_DB then Exit;
			ADD_LOG('[CMD_48_0_0]: Œ“¬¿–ﬂÕ≈ Õ¿ —À”∆≈¡≈Õ ¡ŒÕ');
			case MyFiscDevice of
				dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_48_0_0(OpCode,OpPwd,TillNmb,AllReceipt,FiscReceipt);
				dt_FP2000_KL: tmp_Int:=FP2000_KL.CMD_48_0_0(OpCode,OpPwd,TillNmb,AllReceipt,FiscReceipt);
				dt_FP60_KL: tmp_Int:=FP60_KL.CMD_48_0_0(OpCode,OpPwd,TillNmb,AllReceipt,FiscReceipt);
				dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_48_0_0(OpCode,OpPwd,TillNmb,AllReceipt,FiscReceipt);
				dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_48_0_0(OpCode,OpPwd,TillNmb,AllReceipt,FiscReceipt);
			end;

			if tmp_Int<>0 then
			begin
				tmp_Str:=CALC_ERROR(tmp_Int);
				SHOW_MYALERT(tmp_Str);
				//1. Analize this...
				//2. status bytes or/and CMD_76_0_0
				//3. programatically do something or...
				//4. ...call of administrator
				//...
			end
			else Result:=True;
		except
			Result:=False;
		end;
	finally
		CALC_SWITCHES;
		fmMainForm.Update;
	end;
end;


function TfmMainForm.SELL_CMD_49(MAJOR_VERS, MINOR_VERS: Integer;MY_PARAMS: WideString): Boolean;
begin
	Result:=False;
	try
		case MAJOR_VERS of
			0 : tmp_Int := CMD_49_0(MINOR_VERS,MY_PARAMS);
			1 : tmp_Int := CMD_49_1(MINOR_VERS,MY_PARAMS);
			2 : tmp_Int := CMD_49_2(MINOR_VERS,MY_PARAMS);
			3 : tmp_Int := CMD_49_3(MINOR_VERS,MY_PARAMS);
			4 : tmp_Int := CMD_49_4(MINOR_VERS,MY_PARAMS);
			5 : tmp_Int := CMD_49_5(MINOR_VERS,MY_PARAMS);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
				//1. Analize this ...
				//2. status bytes or/and CMD_76_0_0
				//3. programatically do something or...
				//4. ...call of administrator
				//...
			Exit;
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.PRINT_DELIMITER: Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_92_0_0]: œ≈◊¿“ Õ¿ –¿«ƒ≈À»“≈ÀÕ¿ À»Õ»ﬂ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_92_0_0('1');
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_92_0_0('1');
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_92_0_0('1');
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_92_0_0('1');
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_92_0_0('1');
		end;

		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			Exit;
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.SELL_SOMETHING: Boolean;
var
	MyInput : WideString;

	function GET_SELL_DATA (TRGT_EXAMPLE : Integer) : WideString;
	var
		TaxCd, Price, Qwan, Perc, L1, L2 : WideString;
	begin
		Result:='';
		case TRGT_EXAMPLE of
			0:
			begin
				//Get this data from your database
				L1:='“ÂÒÚ Ì‡ ÔÓ‰‡Ê·‡:Â‰ 1';
				//L2:='“ÂÒÚ Ì‡ ÔÓ‰‡Ê·‡:Â‰ 2';
				L2:='1234567890 1234567890 1234567890 1234567890 1234567890 1234567890';
				Price := FormatFloat('0.00', 0.10);
				Qwan := FormatFloat('0.000', 1.543);
				Perc := FormatFloat('0.00', 10.00);//
				TaxCd := '¡';
				Result:=L1+';'+L2+';'+TaxCd+';'+Price+';'+Qwan+';'+Perc+';';
			end;
			1:
			begin
				//Get this data from your database
				L1:='“ÂÒÚ Ì‡ ÔÓ‰‡Ê·‡:Â‰ 1';
				Price := FormatFloat('0.00', 0.20);
				Qwan := FormatFloat('0.000', 3.000);
				//Price := FormatFloat('0.00', 0.00);
				//Qwan := FormatFloat('0.000', 0.000);
				TaxCd := '¡';
				Result:=L1+';'+TaxCd+';'+Price+';'+Qwan+';';
			end;
			2:
			begin
				//Get this data from your database
				L1:='“ÂÒÚ Ì‡ ÔÓ‰‡Ê·‡:Â‰ 1';
				//L2:='“ÂÒÚ Ì‡ ÔÓ‰‡Ê·‡:Â‰ 2';
				L2:='1234567890 1234567890 1234567890 1234567890 1234567890 1234567890';
				Price := FormatFloat('0.00', -0.10);
				Qwan := FormatFloat('0.000', 1.543);
				Perc := FormatFloat('0.00', 10.00);
				TaxCd := '¡';
				Result:=L1+';'+L2+';'+TaxCd+';'+Price+';'+Qwan+';'+Perc+';';
			end;
		end;
	end;

begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		MyInput:=GET_SELL_DATA(0);
		if not SELL_CMD_49(0,0,MyInput) then Exit;

		MyInput:=GET_SELL_DATA(1);
		if not SELL_CMD_49(2,1,MyInput) then Exit;

		MyInput:=GET_SELL_DATA(2);
		if not SELL_CMD_49(0,0,MyInput) then Exit;

		Result:=True;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CHECK_ASSIGNED: Boolean;
begin
	Result:=False;
	try
		case MyFiscDevice of
			dt_DP55_KL : Result:= Assigned(FPDP55_KL);
			dt_FP2000_KL : Result:=Assigned(FP2000_KL); 
			dt_FP60_KL : Result:=Assigned(FP60_KL);
			dt_FP_550_KL : Result:=Assigned(FP550_KL);
			dt_FP_550D_KL : Result:=Assigned(FP550D_KL);
		end;
		if not Result then
		begin
			SHOW_MYALERT('Not assigned - check for new tlb file!');
			PageControl1.ActivePage:=tsInit;
			btn_INIT_EX1.SetFocus;
			Exit;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CMD_49_0(MINOR_VERS: Integer; MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_0_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_0_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_0_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP60_KL:Result := FP60_KL.CMD_49_0_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_0_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_0_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_0_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_0_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP2000_KL:Result := FP2000_KL.CMD_49_0_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP60_KL:Result := FP60_KL.CMD_49_0_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP_550_KL:Result := FP550_KL.CMD_49_0_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_0_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_0_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_0_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP2000_KL:Result := FP2000_KL.CMD_49_0_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP60_KL:Result := FP60_KL.CMD_49_0_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP_550_KL:Result := FP550_KL.CMD_49_0_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_0_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_0 method');
	end;
end;

function TfmMainForm.CMD_49_1(MINOR_VERS: Integer; MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_1_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_1_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_1_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP60_KL:Result := FP60_KL.CMD_49_1_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_1_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_1_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_1_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_1_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_1_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_1_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_1_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_1_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_1_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_1_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_1_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_1_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_1_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_1_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_1 method');
	end;
end;

function TfmMainForm.CMD_49_2(MINOR_VERS: Integer;
  MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_2_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_2_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_2_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_2_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_2_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_2_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_2_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_2_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_2_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP60_KL:Result := FP60_KL.CMD_49_2_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_2_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_2_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_2_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_2_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_2_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP60_KL:Result := FP60_KL.CMD_49_2_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_2_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_2_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_2 method');
	end;
end;

function TfmMainForm.CMD_49_3(MINOR_VERS: Integer;
  MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_3_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_3_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_3_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP60_KL:Result := FP60_KL.CMD_49_3_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_3_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_3_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_3_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_3_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_3_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_3_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_3_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_3_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_3_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_3_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_3_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_3_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_3_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5)); 

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_3_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_3 method');
	end;
end;

function TfmMainForm.CMD_49_4(MINOR_VERS: Integer;
  MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_4_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_4_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_4_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP60_KL:Result := FP60_KL.CMD_49_4_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_4_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_4_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5),
									GetParam(MY_PARAMS,6));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_4_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_4_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_4_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_4_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_4_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_4_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_4_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_4_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_4_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_4_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_4_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_4_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_4 method');
	end;
end;

function TfmMainForm.CMD_49_5(MINOR_VERS: Integer;
  MY_PARAMS: WideString): Integer;
begin
	Result:=-4;
	try
		case MINOR_VERS of
			0 :
				begin
					ADD_LOG('[CMD_49_5_0]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_5_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_5_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP60_KL:Result := FP60_KL.CMD_49_5_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_5_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_5_0(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4),
									GetParam(MY_PARAMS,5));
					end;
				end;
			1 :
				begin
					ADD_LOG('[CMD_49_5_1]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_5_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_5_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP60_KL:Result := FP60_KL.CMD_49_5_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_5_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_5_1(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));
					end;
				end;
			2 :
				begin
					ADD_LOG('[CMD_49_5_2]: –≈√»—“–»–¿Õ≈ (œ–Œƒ¿∆¡¿) Õ¿ —“Œ ¿');
					case MyFiscDevice of
						dt_DP55_KL:Result := FPDP55_KL.CMD_49_5_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP2000_KL:Result := FP2000_KL.CMD_49_5_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP60_KL:Result := FP60_KL.CMD_49_5_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550_KL:Result := FP550_KL.CMD_49_5_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));

						dt_FP_550D_KL:Result := FP550D_KL.CMD_49_5_2(
									GetParam(MY_PARAMS,1),
									GetParam(MY_PARAMS,2),
									GetParam(MY_PARAMS,3),
									GetParam(MY_PARAMS,4));
					end;
				end;
		end;
	except
		SHOW_MYALERT('Exception in CMD_49_5 method');
	end;
end;

function TfmMainForm.MAKE_SUBTOTAL(TRGT_PERCENT: Real): Boolean;
var
	Perc : WideString;
	ToPrint,ToDisplay, SubTotal,
	TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH: WideString;

	procedure INIT;
	begin
		ToPrint	:='1';
		ToDisplay :='0';
		Perc := FormatFloat('0.00', TRGT_PERCENT);
	end;

begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		INIT;
		if not TryStrToFloat(Perc,tmp_Ext) then Exit;
		if TRGT_PERCENT>0.00 then
		begin
			ADD_LOG('[CMD_51_0_1]: Ã≈∆ƒ»ÕÕ¿ —”Ã¿ - Õ¿ƒ¡¿¬ ¿');
			case MyFiscDevice of
				dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP60_KL:tmp_Int:=FP60_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
			end;
		end
		else
		begin
			ADD_LOG('[CMD_51_0_0]: Ã≈∆ƒ»ÕÕ¿ —”Ã¿ - Œ“—“⁄œ ¿');
			case MyFiscDevice of
				dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP60_KL:tmp_Int:=FP60_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
				dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_51_0_1(ToPrint,ToDisplay, Perc , SubTotal, TaxA, TaxB, TaxC, TaxD, TaxE, TaxF, TaxG, TaxH);
			end;
		end;

		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
				//1. Analize this...
				//2. status bytes or/and CMD_76_0_0
				//3. programatically do something or...
				//4. ...call of administrator
				//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.MAKE_TOTAL: Boolean;
var
	L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out : WideString;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		L1 := '“ÂÍÒÚ ÒÎÂ‰ ÚÓÚ‡Î:1';
		L2 := '“ÂÍÒÚ ÒÎÂ‰ ÚÓÚ‡Î:2';
		PaidMode:='P';
		Amount_In:=FormatFloat('0.00', 10.00);
		ADD_LOG('[CMD_53_0_0]: »«◊»—Àﬂ¬¿Õ≈ Õ¿ —¡Œ– (“Œ“¿À)');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_53_0_0(L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_53_0_0(L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_53_0_0(L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_53_0_0(L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_53_0_0(L1,L2,PaidMode,Amount_In,PaidCode,Amount_Out);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
				//1. Analize this...
				//2. status bytes or/and CMD_76_0_0
				//3. programatically do something or...
				//4. ...call of administrator
				//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CLOSE_FISCAL_BON: Boolean;
var
	AllReceipt,FiscReceipt : WideString;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_56_0_0]: «¿“¬¿–ﬂÕ≈ (œ–» Àﬁ◊¬¿Õ≈) Õ¿ ‘»— ¿À≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_56_0_0(AllReceipt,FiscReceipt);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_56_0_0(AllReceipt,FiscReceipt);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_56_0_0(AllReceipt,FiscReceipt);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_56_0_0(AllReceipt,FiscReceipt);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_56_0_0(AllReceipt,FiscReceipt);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.PRINT_FISCAL_TEXT(TRGT_TEXT: WideString): Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_54_0_0]: œ≈◊¿“¿Õ≈ Õ¿ ‘»— ¿À≈Õ —¬Œ¡Œƒ≈Õ “≈ —“');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_54_0_0(TRGT_TEXT);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_54_0_0(TRGT_TEXT);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_54_0_0(TRGT_TEXT);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_54_0_0(TRGT_TEXT);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_54_0_0(TRGT_TEXT);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CALC_COMNUM: Integer;
var
	i: Integer;
begin
	Result :=-1;
	try
		if Trim(cbx_COMPORT.Text)= '' then Exit;
		tmp_Str := Cbx_COMPORT.Text;
		i := Pos('COM ', tmp_Str);
		if i > 0 then
		begin
			i := i + 4;
			tmp_Str := copy(tmp_Str, i, length(tmp_Str));
			TryStrToInt(tmp_Str, Result);
		end
		else
		begin
			i := Pos('COM', tmp_Str);
			if i > 0 then
			begin
				i := i + 3;
				tmp_Str := copy(tmp_Str, i, length(tmp_Str));
				TryStrToInt(tmp_Str, Result);
			end
			else
			begin
				TryStrToInt(tmp_Str, Result);
			end;
		end;
	except
		Result :=-1;
	end;
end;

procedure TfmMainForm.CALC_SWITCHES;
var
	i, j: Integer;

	function GET_THIS : Boolean;
	begin
		case MyFiscDevice of
			dt_DP55_KL : Result:= FPDP55_KL.GET_BIT_STATE(i, j);
			dt_FP2000_KL : Result:= FP2000_KL.GET_BIT_STATE(i, j);
			dt_FP60_KL : Result:= FP60_KL.GET_BIT_STATE(i, j);
			dt_FP_550_KL : Result:= FP550_KL.GET_BIT_STATE(i, j);
			dt_FP_550D_KL : Result:= FP550D_KL.GET_BIT_STATE(i, j);
		end;
	end;
begin
	ADD_LOG(' ‡ÎÍÛÎË‡ÌÂ Ì‡ ÒÚ‡ÚÛÒ ·ËÚÓ‚ÂÚÂ.');
	for i := 0 to 5 do
	begin
		case i of
			0:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S0_0.Checked:=tmp_Bol;
					1: chbx_S0_1.Checked:=tmp_Bol;
					2: chbx_S0_2.Checked:=tmp_Bol;
					3: chbx_S0_3.Checked:=tmp_Bol;
					4: chbx_S0_4.Checked:=tmp_Bol;
					5: chbx_S0_5.Checked:=tmp_Bol;
					6: chbx_S0_6.Checked:=tmp_Bol;
					7: chbx_S0_7.Checked:=tmp_Bol;
				end;
			end;
			1:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S1_0.Checked:=tmp_Bol;
					1: chbx_S1_1.Checked:=tmp_Bol;
					2: chbx_S1_2.Checked:=tmp_Bol;
					3: chbx_S1_3.Checked:=tmp_Bol;
					4: chbx_S1_4.Checked:=tmp_Bol;
					5: chbx_S1_5.Checked:=tmp_Bol;
					6: chbx_S1_6.Checked:=tmp_Bol;
					7: chbx_S1_7.Checked:=tmp_Bol;
				end;
			end;
			2:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S2_0.Checked:=tmp_Bol;
					1: chbx_S2_1.Checked:=tmp_Bol;
					2: chbx_S2_2.Checked:=tmp_Bol;
					3: chbx_S2_3.Checked:=tmp_Bol;
					4: chbx_S2_4.Checked:=tmp_Bol;
					5: chbx_S2_5.Checked:=tmp_Bol;
					6: chbx_S2_6.Checked:=tmp_Bol;
					7: chbx_S2_7.Checked:=tmp_Bol;
				end;
			end;
			3:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S3_0.Checked:=tmp_Bol;
					1: chbx_S3_1.Checked:=tmp_Bol;
					2: chbx_S3_2.Checked:=tmp_Bol;
					3: chbx_S3_3.Checked:=tmp_Bol;
					4: chbx_S3_4.Checked:=tmp_Bol;
					5: chbx_S3_5.Checked:=tmp_Bol;
					6: chbx_S3_6.Checked:=tmp_Bol;
					7: chbx_S3_7.Checked:=tmp_Bol;
				end;
			end;
			4:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S4_0.Checked:=tmp_Bol;
					1: chbx_S4_1.Checked:=tmp_Bol;
					2: chbx_S4_2.Checked:=tmp_Bol;
					3: chbx_S4_3.Checked:=tmp_Bol;
					4: chbx_S4_4.Checked:=tmp_Bol;
					5: chbx_S4_5.Checked:=tmp_Bol;
					6: chbx_S4_6.Checked:=tmp_Bol;
					7: chbx_S4_7.Checked:=tmp_Bol;
				end;
			end;
			5:for j := 0 to 7 do
			begin
				tmp_Bol:= GET_THIS;
				case j of
					0: chbx_S5_0.Checked:=tmp_Bol;
					1: chbx_S5_1.Checked:=tmp_Bol;
					2: chbx_S5_2.Checked:=tmp_Bol;
					3: chbx_S5_3.Checked:=tmp_Bol;
					4: chbx_S5_4.Checked:=tmp_Bol;
					5: chbx_S5_5.Checked:=tmp_Bol;
					6: chbx_S5_6.Checked:=tmp_Bol;
					7: chbx_S5_7.Checked:=tmp_Bol;
				end;
			end;
		end;
	end;
		case MyFiscDevice of
			dt_DP55_KL :
			begin
				FBON_OPENED:=FPDP55_KL.GET_BIT_STATE(2, 3);
				SBON_OPENED:=FPDP55_KL.GET_BIT_STATE(2, 5);
			end;
			dt_FP2000_KL :
			begin
				FBON_OPENED:=FP2000_KL.GET_BIT_STATE(2, 3);
				SBON_OPENED:=FP2000_KL.GET_BIT_STATE(2, 5);
			end;
			dt_FP60_KL :
			begin
				FBON_OPENED:=FP60_KL.GET_BIT_STATE(2, 3);
				SBON_OPENED:=FP60_KL.GET_BIT_STATE(2, 5);
			end;
			dt_FP_550_KL :
			begin
				FBON_OPENED:=FP550_KL.GET_BIT_STATE(2, 3);
				SBON_OPENED:=FP550_KL.GET_BIT_STATE(2, 5);
			end;
			dt_FP_550D_KL :
			begin
				FBON_OPENED:=FP550D_KL.GET_BIT_STATE(2, 3);
				SBON_OPENED:=FP550D_KL.GET_BIT_STATE(2, 5);
			end;
		end;
end;

function TfmMainForm.CALC_ERROR(TRGT_ERRCODE : Integer) : String;
begin
	try
		Result:= 'Last error code: '+IntToStr(TRGT_ERRCODE)+cNewLine ;
		Result:=Result+'Last error: ';
		case MyFiscDevice of
			dt_DP55_KL:Result:=Result+FPDP55_KL.GET_LASTERROR(0);
			dt_FP2000_KL:Result:=Result+FP2000_KL.GET_LASTERROR(0);
			dt_FP60_KL:Result:=Result+FP60_KL.GET_LASTERROR(0);
			dt_FP_550_KL:Result:=Result+FP550_KL.GET_LASTERROR(0);
			dt_FP_550D_KL:Result:=Result+FP550D_KL.GET_LASTERROR(0);
		end;
		PageControl1.ActivePage:=ts_DEVICE_STATUS;
	finally
		CALC_SWITCHES;
		fmMainForm.Update;
	end;
end;

function TfmMainForm.CAN_OPEN: Boolean;
var
	FT_Opened : WideString;
begin
	Result:=False;
	TRANSTAT_MSG:='';
	if not CHECK_ASSIGNED then Exit;
	try
		try
			ADD_LOG('[CMD_76_0_0]: œÓ‚ÂÍ‡ Ì‡ ÒÚ‡ÚÛÒ‡ Ì‡ Ú‡ÌÁ‡ÍˆËˇÚ‡');
			case MyFiscDevice of
				dt_DP55_KL : tmp_Int:=FPDP55_KL.CMD_76_0_0(FT_Opened, CURRENT_SALESCOUNT, LAST_AMOUNT, CURRENT_TENDER);
				dt_FP2000_KL : tmp_Int:=FP2000_KL.CMD_76_0_0(FT_Opened, CURRENT_SALESCOUNT, LAST_AMOUNT, CURRENT_TENDER);
				dt_FP60_KL : tmp_Int:=FP60_KL.CMD_76_0_0(FT_Opened, CURRENT_SALESCOUNT, LAST_AMOUNT, CURRENT_TENDER);
				dt_FP_550_KL : tmp_Int:=FP550_KL.CMD_76_0_0(FT_Opened, CURRENT_SALESCOUNT, LAST_AMOUNT, CURRENT_TENDER);
				dt_FP_550D_KL : tmp_Int:=FP550D_KL.CMD_76_0_0(FT_Opened, CURRENT_SALESCOUNT, LAST_AMOUNT, CURRENT_TENDER);
			end;
			if tmp_Int<>0 then
			begin
				tmp_Str:=CALC_ERROR(tmp_Int);
				SHOW_MYALERT(tmp_Str);
			end
			else
			begin
				tmp_Int:=StrToInt(FT_Opened);
				CALC_SWITCHES;
				case tmp_Int of
					0 :
					begin
						Result:=True;
						TRANSTAT_MSG:='ÕˇÏ‡ ÓÚ‚ÓÂÌ ·ÓÌ.'+cNewLine;
					end;
					1 :
					begin
						TRANSTAT_MSG:='1. »Ï‡ ÓÚ‚ÓÂÌ ·ÓÌ Ë ÚÓÈ Â ';
						if FBON_OPENED then TRANSTAT_MSG:=TRANSTAT_MSG+'ÙËÒÍ‡ÎÂÌ.'+cNewLine+cNewLine;
						if SBON_OPENED then TRANSTAT_MSG:=TRANSTAT_MSG+'ÌÂÙËÒÍ‡ÎÂÌ.'+cNewLine+cNewLine;
					end;
				end;
				TRANSTAT_MSG:=TRANSTAT_MSG+'2. ¡ÓˇÚ Ì‡ ÔÓ‰‡Ê·ËÚÂ Â„ËÒÚË‡ÌË Ì‡ ÚÂÍÛ˘Ëˇ ËÎË Ì‡ ÔÓÒÎÂ‰ÌËˇ ÙËÒÍ‡ÎÂÌ ·ÓÌ: '+cNewLine;
				TRANSTAT_MSG:=TRANSTAT_MSG+CURRENT_SALESCOUNT+cNewLine+cNewLine;
				TRANSTAT_MSG:=TRANSTAT_MSG+'3. —ÛÏ‡Ú‡ ÓÚ ÔÓÒÎÂ‰ÌËˇ ÙËÒÍ‡ÎÂÌ ·ÓÌ: '+cNewLine;
				TRANSTAT_MSG:=TRANSTAT_MSG+LAST_AMOUNT+cNewLine+cNewLine;
				TRANSTAT_MSG:=TRANSTAT_MSG+'4. —ÛÏ‡Ú‡ ÔÎ‡ÚÂÌ‡ Ì‡ ÔÓÂ‰ÌËˇ ËÎË ÔÓÒÎÂ‰ÂÌ ·ÓÌ: '+cNewLine;
				TRANSTAT_MSG:=TRANSTAT_MSG+CURRENT_TENDER+cNewLine;
			end;
		except
			ShowMessage('TfmMainForm.CAN_OPEN:');
		end;
	finally
		fmMainForm.Update;
	end;
end;

function TfmMainForm.EMERGENSY_SITUATION: Boolean;
begin
	Result:=False;
	try
		if FBON_OPENED then Result:=FEMERGENSY_SITUATION;
		if SBON_OPENED then Result:=SEMERGENSY_SITUATION;
	except
		Result:=False;
	end;
end;

function TfmMainForm.FEMERGENSY_SITUATION: Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_60_0_0]: Œœ»“ «¿ Œ“ ¿«¬¿Õ≈(œ–≈ –¿“ﬂ¬¿Õ≈) Õ¿ ‘»— ¿À≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_60_0_0;
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_60_0_0;
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_60_0_0;
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_60_0_0;
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_60_0_0;
		end;
		if tmp_Int<>0 then
		begin
			//CURRENT_TENDER : WideString;
			//LAST_AMOUNT : WideString;
			//CURRENT_SALESCOUNT : WideString;
			SHOW_MYALERT('CURRENT_TENDER: '+CURRENT_TENDER);
			SHOW_MYALERT('LAST_AMOUNT: '+LAST_AMOUNT);
			SHOW_MYALERT('CURRENT_SALESCOUNT: '+CURRENT_SALESCOUNT);

			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
		end
		else
		begin
			Result:=CAN_OPEN;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.SEMERGENSY_SITUATION: Boolean;
var
	Allreceipt : WideString;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_39_0_0]: «¿“¬¿–ﬂÕ≈ Õ¿ —À”∆≈¡≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_39_0_0(Allreceipt);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_39_0_0(Allreceipt);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_39_0_0(Allreceipt);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_39_0_0(Allreceipt);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_39_0_0(Allreceipt);
		end;
		if tmp_Int<>0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
		end
		else
		begin
			Result:=CAN_OPEN;
		end;
	except
		Result:=False;
	end;
end;

procedure TfmMainForm.ADD_LOG(TRGT_LOG: String);
begin
	mem_LOG.Lines.Add(TRGT_LOG);
end;

function TfmMainForm.CHECK_AND_RESOLVE: Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		if not CAN_OPEN then
		begin
			if TRANSTAT_MSG<>'' then
			begin
				tmp_Str:='¬ÌËÏ‡ÌËÂ!'+cNewLine;
				tmp_Str:=tmp_Str+'—Ú‡ÚÛÒ‡ Ì‡ ÙËÒÍ‡ÎÌ‡Ú‡ Ú‡ÌÁ‡ÍˆËˇ Â ‰‡‰ÂÌ ÔÓ-‰ÓÎÛ:'+cNewLine+cNewLine;
				tmp_Str:=tmp_Str+TRANSTAT_MSG;
				SHOW_MYALERT(tmp_Str);
			end;
			tmp_Str:='∆ÂÎ‡ÂÚÂ ÎË ÔÓ„‡Ï‡Ú‡ ‰‡ ÒÂ ÓÔËÚ‡ ‰‡ ‡ÁÂ¯Ë ÒËÚÛ‡ˆËˇÚ‡?';
			if SHOW_MYQUESTION(tmp_Str)=IDYES then
			begin
				Result:=EMERGENSY_SITUATION;
				if not Result then
				begin
					tmp_Str:='‘ËÒÍ‡ÎÌÓÚÓ ÛÒÚÓÈÒÚ‚Ó ÒÂ Ì‡ÏË‡ ‚ Ò˙ÒÚÓˇÌËÂ, ÍÓÂÚÓ Ú‡ÁË ÔÓ„‡Ï‡ ÌÂ ÛÒÔˇ‚‡ ‰‡ ‡ÁÂ¯Ë.';
					SHOW_MYALERT(tmp_Str);
					Exit;
				end;
			end
			else Exit;
		end
		else Result:=True;
	except
		Result:=False;
	end;
end;

function TfmMainForm.OPEN_NONFISCAL: Boolean;
var
	AllReceipt, ErrCode: WideString;
begin
	Result:=False;
	try
		ADD_LOG('[CMD_38_0_0]: Œ“¬¿–ﬂÕ≈ Õ¿ —À”∆≈¡≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_38_0_0(AllReceipt, ErrCode);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_38_0_0(AllReceipt, ErrCode);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_38_0_0(AllReceipt, ErrCode);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_38_0_0(AllReceipt, ErrCode);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_38_0_0(AllReceipt, ErrCode);
		end;
		if tmp_Int<>0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else Result:=True;
	except
		Result:=False;
	end;
end;

procedure TfmMainForm.ERROR_HANDLING;
begin
	if not CHECK_ASSIGNED then Exit;
	try
		try
			mem_LOG.Clear;
			if not CHECK_AND_RESOLVE then Exit;
			if not OPEN_NONFISCAL then Exit;

			tmp_Str:='';
			tmp_Str:=tmp_Str+'¬ÌËÏ‡ÌËÂ!'+cNewLine;
			tmp_Str:=tmp_Str+'Õ‡Ó˜ÌÓ ÒÂ ÓÔËÚ‚‡ÏÂ ‰‡ ÓÚ‚ÓËÏ ÌÂÙËÒÍ‡ÎÌËˇ ·ÓÌ ÓÚÌÓ‚Ó - ˆÂÎÚ‡ ÌË Â ';
			tmp_Str:=tmp_Str+'‰‡ ÔÂ‰ËÁ‚ËÍ‡ÏÂ „Â¯Í‡.';
			ADD_LOG(tmp_Str);
			SHOW_MYINFO(tmp_Str);
			
			if not OPEN_NONFISCAL then
			begin
				CHECK_AND_RESOLVE;
			end;
		except
			SHOW_MYALERT('Exception in method TfmMainForm.ERROR_HANDLING.');
		end;
	finally
		fmMainForm.Update;
	end;
end;

procedure TfmMainForm.btn_EXECUTE_THISClick(Sender: TObject);
begin
	try
		try
			btn_EXECUTE_THIS.Enabled:=False;
			case cbx_TRGT_METHOD.ItemIndex of
				0 : REFRESH_SWITCHES;			//ŒÔÂÒÌˇ‚‡ÌÂ Ì‡ ÒÚ‡ÚÛÒ‡
				1 : MAKE_FISCAL_TRANSACTION;		//‘ËÒÍ‡ÎÌ‡ ·ÂÎÂÊÍ‡
				2 : MAKE_NONFISCAL_TRANSACTION;	//ÕÂÙËÒÍ‡ÎÌ‡ ·ÂÎÂÊÍ‡
				3 : ERROR_HANDLING;				//ƒÂÏÓÌÒÚË‡ÌÂ Ì‡ Ó·‡·ÓÚ‚‡ÌÂ Ì‡ „Â¯Í‡
				4 : CHECK_AND_RESOLVE;			//œÓ‚ÂÍ‡ Ì‡ ÒÚ‡ÚÛÒ‡ Ì‡ Ú‡ÌÁ‡ÍˆËˇÚ‡ Ë ‡‚‡ËÈÌÓ Á‡Ú‚‡ˇÌÂ
				5 : INIT_SWITCHES_EX(1);			//Get status bytes and switches initialisation(Englis)
				6 : INIT_SWITCHES_EX(0);			//œÓÎÛ˜‡‚‡ÌÂ Ì‡ ÒÚ‡ÚÛÒ ·‡ÈÚÓ‚ÂÚÂ Ë ÌËˆË‡ÎËÁ‡ˆËˇ Ì‡ ËÌÙÓÏ‡ˆËˇÚ‡ Á‡ Ò˙ÒÚÓˇÌËÂÚÓ ËÏ (Bulgarian)
				7 : ZX_REPORT('0');				//Z-ÓÚ˜ÂÚ
				8 : ZX_REPORT('2');				//X-ÓÚ˜ÂÚ
				9 : ZXDEP_REPORT('0');			//Z-ÓÚ˜ÂÚ ƒÕ≈¬≈Õ ‘»Õ¿Õ—Œ¬ Œ“◊≈“ — œ≈◊¿“ Õ¿ ƒ¿ÕÕ» œŒ ƒ≈œ¿–“¿Ã≈Õ“»
				10 : ZXDEP_REPORT('2');			//X-ÓÚ˜ÂÚ ƒÕ≈¬≈Õ ‘»Õ¿Õ—Œ¬ Œ“◊≈“ — œ≈◊¿“ Õ¿ ƒ¿ÕÕ» œŒ ƒ≈œ¿–“¿Ã≈Õ“»
				11 : CMD_70_0_0('1.00');			//—ÎÛÊÂ·ÂÌ ‚ÌÓÒ
				12 : CMD_70_0_0('-1.00');		//—ÎÛÊÂ·ÂÌ ËÁÌÓÒ
				13 : CMD_88_0_0;//œÓÎÛ˜‡‚‡ÌÂ Ì‡ ËÌÙÓÏ‡ˆËˇ Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ
				14 : CMD_49_5_0;//œÓ‰‡Ê·‡ ‚ ‰ÂÔ‡Ú‡ÏÂÌÚ
			end;
		except
			SHOW_MYALERT('Exception in method TfmMainForm.btn_EXECUTE_THISClick.');
		end;
	finally
		btn_EXECUTE_THIS.Enabled:=True;
	end;
end;

procedure TfmMainForm.ApplicationEvents1SettingChange(Sender: TObject;
  Flag: Integer; const Section: String; var Result: Integer);
begin
	DateSeparator := '.';
	TimeSeparator := ':';
	DecimalSeparator := '.';
	ShortDateFormat := 'dd.mm.yyyy';
	ShortTimeFormat := 'hh:mm:ss';
end;

function TfmMainForm.MAKE_FISCAL_TRANSACTION: Boolean;

begin
	Result:=False;
	try
		try
			mem_LOG.Clear;

			if not CHECK_AND_RESOLVE then Exit;
			if not OPEN_FISCAL_BON then Exit;
			if not SELL_SOMETHING then Exit;
			if not PRINT_DELIMITER then Exit;

			if not PRINT_FISCAL_TEXT('«‡ Ì‡Ò Â Û‰Ó‚ÓÎÒÚ‚ËÂ, ˜Â') then Exit;
			if not PRINT_FISCAL_TEXT('ÒÚÂ Ì‡¯ ÍÎËÂÌÚ Ë ÔÓ‡‰Ë ÚÓ‚‡') then Exit;
			if not PRINT_FISCAL_TEXT('¬Ë Ô‡‚ËÏ ÓÚÒÚ˙ÔÍ‡ 98% :)') then Exit;
			if not MAKE_SUBTOTAL(-98.00) then Exit;

			if not PRINT_DELIMITER then Exit;
			if not MAKE_TOTAL then Exit;

			Result:=CLOSE_FISCAL_BON;
			
			if Result then
			begin
				if GET_LAST_DOCNUM then
				begin
					//for example:
					//SAVE TO DATABASE
				end;
			end
			else
			begin
				//for example:
				//Do some interactive actions
			end;
		except
			Result:=False;
		end;
	finally
		fmMainForm.Update;
	end;
end;

function TfmMainForm.PRINT_NONFISCAL_TEXT(TRGT_TEXT: WideString): Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_42_0_0]: œ≈◊¿“¿Õ≈ Õ¿ —¬Œ¡Œƒ≈Õ “≈ —“ ¬ —À”∆≈¡≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_42_0_0(TRGT_TEXT);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_42_0_0(TRGT_TEXT);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_42_0_0(TRGT_TEXT);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_42_0_0(TRGT_TEXT);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_42_0_0(TRGT_TEXT);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CLOSE_NONFISCAL_BON: Boolean;
var
	AllReceipt : WideString;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_39_0_0]: «¿“¬¿–ﬂÕ≈ Õ¿ —À”∆≈¡≈Õ ¡ŒÕ');
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_39_0_0(AllReceipt);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_39_0_0(AllReceipt);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_39_0_0(AllReceipt);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_39_0_0(AllReceipt);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_39_0_0(AllReceipt);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.MAKE_NONFISCAL_TRANSACTION: Boolean;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		try
			mem_LOG.Lines.Clear;
			if not OPEN_NONFISCAL then Exit;
			if not PRINT_NONFISCAL_TEXT('œËÏÂ Á‡ ÌÂÙËÒÍ‡ÎÂÌ ÚÂÍÒÚ: [1]') then Exit;
			if not PRINT_NONFISCAL_TEXT('œËÏÂ Á‡ ÌÂÙËÒÍ‡ÎÂÌ ÚÂÍÒÚ: [2]') then Exit;
			if not PRINT_NONFISCAL_TEXT('œËÏÂ Á‡ ÌÂÙËÒÍ‡ÎÂÌ ÚÂÍÒÚ: [3]') then Exit;
			if not CLOSE_NONFISCAL_BON then Exit;
		except
			SHOW_MYALERT('TfmMainForm.MAKE_NONFISCAL_TRANSACTION');
		end;
	finally
		fmMainForm.Update;
	end;
end;

procedure TfmMainForm.INIT_SWITCHES_EX(TRGT_LANG : Integer);

	procedure SetNew_ChbxCaption(New_Caption  :String;TRGT_CheckBox: TCheckBox);
	var
		CaptionWidth: Integer;
	begin
		try
			try
				if Canvas.Font <> TRGT_CheckBox.Font then Canvas.Font := TRGT_CheckBox.Font;
				TRGT_CheckBox.Caption := New_Caption;
				CaptionWidth := Canvas.TextWidth(TRGT_CheckBox.Caption);
				TRGT_CheckBox.Width := CaptionWidth + 24;
			except
				//TODO : Exception handler
			end;
		finally
			TRGT_CheckBox.Update;
		end;
	end;

	procedure GET_DESCRIPTIONS;
	var
		i, j: Integer;

		function GET_STAT_DESCR : String;
		begin
			case MyFiscDevice of
				dt_DP55_KL : Result:=FPDP55_KL.GET_STATUS_DESCRIPTIONEX(i,j,TRGT_LANG);
				dt_FP2000_KL : Result:=FP2000_KL.GET_STATUS_DESCRIPTIONEX(i,j,TRGT_LANG);
				dt_FP60_KL : Result:=FP60_KL.GET_STATUS_DESCRIPTIONEX(i,j,TRGT_LANG);
				dt_FP_550_KL : Result:=FP550_KL.GET_STATUS_DESCRIPTIONEX(i,j,TRGT_LANG);
				dt_FP_550D_KL : Result:=FP550D_KL.GET_STATUS_DESCRIPTIONEX(i,j,TRGT_LANG);
			end;
		end;

		function GET_STAT_VALUE : Boolean;
		begin
			case MyFiscDevice of
				dt_DP55_KL : Result:=FPDP55_KL.GET_BIT_STATE(i, j);
				dt_FP2000_KL : Result:=FP2000_KL.GET_BIT_STATE(i, j);
				dt_FP60_KL : Result:=FP60_KL.GET_BIT_STATE(i, j);
				dt_FP_550_KL : Result:=FP550_KL.GET_BIT_STATE(i, j);
				dt_FP_550D_KL : Result:=FP550D_KL.GET_BIT_STATE(i, j);
			end;
		end;
	begin
		for i := 0 to 5 do
		begin
			case i of
				0:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S0_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S0_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S0_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S0_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S0_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S0_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S0_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S0_7);
					end;
				end;
				1:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S1_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S1_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S1_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S1_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S1_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S1_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S1_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S1_7);
					end;
				end;
				2:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S2_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S2_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S2_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S2_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S2_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S2_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S2_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S2_7);
					end;
				end;
				3:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S3_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S3_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S3_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S3_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S3_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S3_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S3_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S3_7);
					end;
				end;
				4:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S4_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S4_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S4_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S4_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S4_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S4_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S4_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S4_7);
					end;
				end;
				5:for j := 0 to 7 do
				begin
					tmp_Str:= GET_STAT_DESCR;
					tmp_Bol:= GET_STAT_VALUE;
					case j of
						0: SetNew_ChbxCaption(tmp_Str, chbx_S5_0);
						1: SetNew_ChbxCaption(tmp_Str, chbx_S5_1);
						2: SetNew_ChbxCaption(tmp_Str, chbx_S5_2);
						3: SetNew_ChbxCaption(tmp_Str, chbx_S5_3);
						4: SetNew_ChbxCaption(tmp_Str, chbx_S5_4);
						5: SetNew_ChbxCaption(tmp_Str, chbx_S5_5);
						6: SetNew_ChbxCaption(tmp_Str, chbx_S5_6);
						7: SetNew_ChbxCaption(tmp_Str, chbx_S5_7);
					end;
				end;
			end;
		end;
	end;
begin
	if not CHECK_ASSIGNED then Exit;
	try
		try
			CHECK_AND_RESOLVE;
			GET_DESCRIPTIONS;
			PageControl1.ActivePage:=ts_DEVICE_STATUS;
		except
			//TODO : Exception handler
		end;
	finally
		REFRESH_SWITCHES;
		fmMainForm.Update;
	end;
end;

function TfmMainForm.ZX_REPORT(TRGT_OPTION : WideString): Boolean;
var
	Option,
	N,
	Closure,
	FM_Total,
	TotA,
	TotB,
	TotC,
	TotD,
	TotE,
	TotF,
	TotG,
	TotH: WideString  ;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		try
			Option:=TRGT_OPTION;
			N:='';
			//Õ‡ÎË˜ËÂÚÓ Ì‡ ÚÓÁË ÒËÏ‚ÓÎ Á‡·‡Ìˇ‚‡ ËÁ˜ËÒÚ‚‡ÌÂÚÓ Ì‡ Ì‡ÚÛÔ‡ÌËÚÂ ‰‡ÌÌË ÔÓ
			//ÓÔÂ‡ÚÓË ÔË ÓÚ˜ÂÚ Ò ÌÛÎË‡ÌÂ.
			//N:='N';

			mem_LOG.Lines.Clear;
			ADD_LOG('[CMD_69_0_0]: Z-Œ“◊≈“');
			case MyFiscDevice of
				dt_DP500PLUS_KL,
				dt_DP55_KL,
				dt_MP55_KL,
				dt_DP_50_KL: tmp_Int:=FPDP55_KL.CMD_69_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP_1000_KL:
				begin
					//
				end;
				dt_FP_550_KL: tmp_Int:=FP550_KL.CMD_69_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP_550D_KL: tmp_Int:=FP550D_KL.CMD_69_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FMP10_KL:
				begin
					//
				end;
				dt_FP60_KL: tmp_Int:=FP60_KL.CMD_69_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP1000_DV,
				dt_FP300_DV,
				dt_FP550_DV,
				dt_FP60_DV:
				begin
					//
				end;
				dt_FP2000_KL: tmp_Int:=FP2000_KL.CMD_69_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
			end;
			
			if tmp_Int<>0 then
			begin
				tmp_Str:=CALC_ERROR(tmp_Int);
				SHOW_MYALERT(tmp_Str);
			end
		except
			SHOW_MYALERT('TfmMainForm.ZX_REPORT');
		end;
	finally
		fmMainForm.Update;
	end;
end;

function TfmMainForm.ZXDEP_REPORT(TRGT_OPTION: WideString): Boolean;
var
	Option,
	N,
	Closure,
	FM_Total,
	TotA,
	TotB,
	TotC,
	TotD,
	TotE,
	TotF,
	TotG,
	TotH: WideString  ;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		try
			Option:=TRGT_OPTION;
			N:='';
			//Õ‡ÎË˜ËÂÚÓ Ì‡ ÚÓÁË ÒËÏ‚ÓÎ Á‡·‡Ìˇ‚‡ ËÁ˜ËÒÚ‚‡ÌÂÚÓ Ì‡ Ì‡ÚÛÔ‡ÌËÚÂ ‰‡ÌÌË ÔÓ
			//ÓÔÂ‡ÚÓË ÔË ÓÚ˜ÂÚ Ò ÌÛÎË‡ÌÂ.
			//N:='N';

			mem_LOG.Lines.Clear;
			ADD_LOG('[CMD_117_0_0]: Z-Œ“◊≈“');
			case MyFiscDevice of
				dt_DP500PLUS_KL,
				dt_DP55_KL,
				dt_MP55_KL,
				dt_DP_50_KL: tmp_Int:=FPDP55_KL.CMD_117_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP_1000_KL:
				begin
					//
				end;
				dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_117_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_117_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FMP10_KL:
				begin
					//
				end;
				dt_FP60_KL: tmp_Int:=FP60_KL.CMD_117_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
				dt_FP1000_DV,
				dt_FP300_DV,
				dt_FP550_DV,
				dt_FP60_DV:
				begin
					//
				end;
				dt_FP2000_KL: tmp_Int:=FP2000_KL.CMD_117_0_0(Option,N,Closure,FM_Total,TotA,TotB,TotC,TotD,TotE,TotF,TotG,TotH);
			end;

			if tmp_Int<>0 then
			begin
				tmp_Str:=CALC_ERROR(tmp_Int);
				SHOW_MYALERT(tmp_Str);
			end
		except
			SHOW_MYALERT('TfmMainForm.ZXDEP_REPORT');
		end;
	finally
		fmMainForm.Update;
	end;
end;

function TfmMainForm.CMD_70_0_0(Amount: WideString): Integer;
var
	ExitCode: WideString;
	CashSum: WideString;
	ServIn: WideString;
	ServOut: WideString;
begin
	ExitCode:='';
	CashSum:='';
	ServIn:='';
	ServOut:='';
	Result:=-4;
	try
		if StrToFloat(Amount)>0.00 then ADD_LOG('[CMD_70_0_0]: —À”∆≈¡≈Õ ¬ÕŒ— Õ¿ œ¿–»: '+Amount)
		else ADD_LOG('[CMD_70_0_0]: —À”∆≈¡≈Õ »«ÕŒ— Õ¿ œ¿–»: '+Amount);
		case MyFiscDevice of
			dt_DP55_KL:Result := FPDP55_KL.CMD_70_0_0(Amount,ExitCode,CashSum,ServIn,ServOut);
			dt_FP2000_KL:Result := FP2000_KL.CMD_70_0_0(Amount,ExitCode,CashSum,ServIn,ServOut);
			dt_FP60_KL:Result := FP60_KL.CMD_70_0_0(Amount,ExitCode,CashSum,ServIn,ServOut);
			dt_FP_550_KL:Result := FP550_KL.CMD_70_0_0(Amount,ExitCode,CashSum,ServIn,ServOut);
			dt_FP_550D_KL:Result := FP550D_KL.CMD_70_0_0(Amount,ExitCode,CashSum,ServIn,ServOut);
		end;
		tmp_Str:='';
		if Result=0 then
		begin
			tmp_Str:='';
			tmp_Str:=tmp_Str+'—ÛÏ‡Ú‡ Á‡ Â„ËÒÚË‡ÌÂ:'+Amount+cNewLine;
			if ExitCode='P' then
			begin
				tmp_Str:=tmp_Str+'«‡ˇ‚Í‡Ú‡ Â ËÁÔ˙ÎÌÂÌ‡. '+cNewLine;
				tmp_Str:=tmp_Str+'¿ÍÓ Á‡ˇ‚ÂÌ‡Ú‡ ÒÛÏ‡ Â ÌÂÌÛÎÂ‚‡, ÔËÌÚÂ˙Ú ÓÚÔÂ˜‡Ú‚‡ ';
				tmp_Str:=tmp_Str+'ÒÎÛÊÂ·ÂÌ ·ÓÌ Á‡ Â„ËÒÚË‡ÌÂ Ì‡ ÓÔÂ‡ˆËˇÚ‡.'+cNewLine;
			end;
			tmp_Str:=tmp_Str+''+cNewLine;
			tmp_Str:=tmp_Str+' ‡ÒÓ‚‡ Ì‡ÎË˜ÌÓÒÚ: '+CashSum+cNewLine;
			tmp_Str:=tmp_Str+'ŒÒ‚ÂÌ ÓÚ Ú‡ÁË ÍÓÏ‡Ì‰‡ ÒÛÏ‡Ú‡ Ì‡‡ÒÚ‚‡ Ë ÔË ‚ÒˇÍÓ ÔÎ‡˘‡ÌÂ ‚ ·ÓÈ.'+cNewLine;
			tmp_Str:=tmp_Str+''+cNewLine;
			tmp_Str:=tmp_Str+'—ÛÏ‡Ú‡ ÓÚ ‚ÒË˜ÍË ÍÓÏ‡Ì‰Ë "—ÎÛÊÂ·ÂÌ ‚ÌÓÒ":'+ServIn+cNewLine;
			tmp_Str:=tmp_Str+''+cNewLine;
			tmp_Str:=tmp_Str+'—ÛÏ‡Ú‡ ÓÚ ‚ÒË˜ÍË ÍÓÏ‡Ì‰Ë "—ÎÛÊÂ·ÂÌ ËÁÌÓÒ":'+ServOut+cNewLine;
			tmp_Str:=tmp_Str+''+cNewLine;
			SHOW_MYINFO(tmp_Str);
		end;
	except
		SHOW_MYALERT('Exception in CMD_70_0_0 method');
	end;
end;

procedure TfmMainForm.cbx_PrinterModelChange(Sender: TObject);
begin
	case cbx_PrinterModel.ItemIndex of
		2 :
		begin
			lb_PORT.Enabled		:=True;
			ed_PORT.Enabled		:=True;
			lb_IPADDR.Enabled		:=True;
			ed_IPADDR.Enabled		:=True;

			lb_COMPORT.Enabled		:=False;
			cbx_COMPORT.Enabled		:=False;
			lb_Baudrate.Enabled		:=False;
			cbx_Baudrate.Enabled	:=False;
		end;
		else
		begin
			lb_PORT.Enabled		:=False;
			ed_PORT.Enabled		:=False;
			lb_IPADDR.Enabled		:=False;
			ed_IPADDR.Enabled		:=False;

			lb_COMPORT.Enabled		:=True;
			cbx_COMPORT.Enabled		:=True;
			lb_Baudrate.Enabled		:=True;
			cbx_Baudrate.Enabled	:=True;
		end;
	end;
end;

function TfmMainForm.GET_LAST_DOCNUM: Boolean;
var
	DocNum: WideString;
begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_113_0_0]: œŒÀ”◊¿¬¿Õ≈ ÕŒÃ≈–¿ Õ¿ œŒ—À≈ƒÕ»ﬂ Œ“œ≈◊¿“¿Õ ƒŒ ”Ã≈Õ“');
		DocNum:='';
		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_113_0_0(DocNum);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_113_0_0(DocNum);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_113_0_0(DocNum);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_113_0_0(DocNum);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_113_0_0(DocNum);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			ADD_LOG('ÕŒÃ≈–¿ Õ¿ œŒ—À≈ƒÕ»ﬂ Œ“œ≈◊¿“¿Õ ƒŒ ”Ã≈Õ“: '+DocNum);
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CMD_88_0_0: Boolean;
var
	Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2: WideString ;
begin
	//Dept		ÕÓÏÂ Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ. ÷ˇÎÓ ˜ËÒÎÓ ÓÚ 1 ‰Ó 60.
	//			œË ÒÚÓÈÌÓÒÚ 0 Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ ÒÂ ‚˙˘‡Ú ‰‡ÌÌËÚÂ Á‡ ÔÓ‰‡·ËÚÂ, ËÁ‚˙¯ÂÌË ·ÂÁ ÔÓÒÓ˜‚‡ÌÂ Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ.
	//			¬ ÚÓÁË ÒÎÛ˜‡È ÎËÔÒ‚‡ ‰‡Ì˙˜Ì‡Ú‡ „ÛÔ‡.
	//ExitCode	≈‰ËÌ ·‡ÈÚ Ò ‚˙ÁÏÓÊÌË ÒÚÓÈÌÓÒÚË:
	//			'P'		ƒÂÔ‡Ú‡ÏÂÌÚ˙Ú Â ÔÓ„‡ÏË‡Ì. —ÎÂ‰‚‡Ú ÓÔËÒ‡ÌËÚÂ ÔÓ-‰ÓÎÛ ‰‡ÌÌË Á‡ ÌÂ„Ó.
	//			'F'		ƒÂÔ‡Ú‡ÏÂÌÚ˙Ú ÌÂ Â ÔÓ„‡ÏË‡Ì. ÕˇÏ‡ ‰‡ÌÌË Á‡ ÌÂ„Ó.
	//TaxGr		ƒ‡Ì˙˜Ì‡ „ÛÔ‡ Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡.
	//RecSales	¡ÓÈ ÔÓ‰‡Ê·Ë Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ ‚ ·ÓÌ‡.
	//RecSum		Õ‡ÚÛÔ‡Ì‡ ÒÛÏ‡ Á‡ ÚÂÍÛ˘Ëˇ ËÎË ÔÓÒÎÂ‰ÌËˇ ÙËÒÍ‡ÎÂÌ ·ÓÌ Á‡ Ò˙ÓÚ‚ÂÚÌËˇ ‰ÂÔ‡Ú‡ÏÂÌÚ.
	//			œÎ‡‚‡˘Ó ˜ËÒÎÓ Ò ‰‚‡ ‰ÂÒÂÚË˜ÌË ÁÌ‡Í‡.
	//TotSales	¡ÓÈ ÔÓ‰‡Ê·Ë Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ Á‡ ‰ÂÌˇ.
	//TotSum		Õ‡ÚÛÔ‡Ì‡ ÒÛÏ‡ Á‡ ‰ÂÌˇ Á‡ Ò˙ÓÚ‚ÂÚÌËˇ ‰ÂÔ‡Ú‡ÏÂÌÚ. œÎ‡‚‡˘Ó ˜ËÒÎÓ Ò ‰‚‡ ‰ÂÒÂÚË˜ÌË ÁÌ‡Í‡.
	//Line1		»ÏÂ ËÎË ÔÓˇÒÌˇ‚‡˘ ÚÂÍÒÚ Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡. ƒÓ 28 ÒËÏ‚ÓÎ‡.
	//Line2		»ÏÂ ËÎË ÔÓˇÒÌˇ‚‡˘ ÚÂÍÒÚ Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ - ‚ÚÓË Â‰. ƒÓ 34 ÒËÏ‚ÓÎ‡.

	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		ADD_LOG('[CMD_88_0_0]: œŒÀ”◊¿¬¿Õ≈ ƒ¿ÕÕ» «¿ Õ¿“–”œ¿Õ»“≈ —”Ã» «¿ ƒ≈œ¿–“¿Ã≈Õ“');

		if MyFiscDevice=dt_FP_550D_KL then Dept:='1200'
		else Dept:='1';

		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_88_0_0(Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_88_0_0(Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_88_0_0(Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_88_0_0(Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_88_0_0(Dept,ExitCode,TaxGr,RecSales,RecSum,TotSales,TotSum,Line1,Line2);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			tmp_Str:='';
			tmp_Str:=tmp_Str+'ÕÓÏÂ Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ: '+Dept+cNewLine;
			tmp_Str:=tmp_Str+'ExitCode: '+ExitCode+cNewLine;
			if ExitCode='F' then
			begin
				tmp_Str:=tmp_Str+'ƒÂÔ‡Ú‡ÏÂÌÚ˙Ú ÌÂ Â ÔÓ„‡ÏË‡Ì. ÕˇÏ‡ ‰‡ÌÌË Á‡ ÌÂ„Ó.'+cNewLine;
			end
			else
			begin
				tmp_Str:=tmp_Str+'ƒ‡Ì˙˜Ì‡ „ÛÔ‡ Ì‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡: '+TaxGr+cNewLine;
				tmp_Str:=tmp_Str+'¡ÓÈ ÔÓ‰‡Ê·Ë Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ ‚ ·ÓÌ‡: '+RecSales+cNewLine;
				tmp_Str:=tmp_Str+'Õ‡ÚÛÔ‡Ì‡ ÒÛÏ‡ Á‡ ÚÂÍÛ˘Ëˇ ËÎË ÔÓÒÎÂ‰ÌËˇ ÙËÒÍ‡ÎÂÌ ·ÓÌ Á‡ Ò˙ÓÚ‚ÂÚÌËˇ ‰ÂÔ‡Ú‡ÏÂÌÚ: '+RecSum+cNewLine;
				tmp_Str:=tmp_Str+'¡ÓÈ ÔÓ‰‡Ê·Ë Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡ Á‡ ‰ÂÌˇ: '+TotSales+cNewLine;
				tmp_Str:=tmp_Str+'Õ‡ÚÛÔ‡Ì‡ ÒÛÏ‡ Á‡ ‰ÂÌˇ Á‡ Ò˙ÓÚ‚ÂÚÌËˇ ‰ÂÔ‡Ú‡ÏÂÌÚ: '+TotSum+cNewLine;
				tmp_Str:=tmp_Str+'»ÏÂ ËÎË ÔÓˇÒÌˇ‚‡˘ ÚÂÍÒÚ Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡(Line1): '+Line1+cNewLine;
				tmp_Str:=tmp_Str+'»ÏÂ ËÎË ÔÓˇÒÌˇ‚‡˘ ÚÂÍÒÚ Á‡ ‰ÂÔ‡Ú‡ÏÂÌÚ‡(Line2): '+Line2+cNewLine;
			end;
			ShowMessage(tmp_Str);
			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

function TfmMainForm.CMD_49_5_0: Boolean;
var
	L1	: WideString;
	L2	: WideString;
	Dept	: WideString;
	Price: WideString;
	Qwan	: WideString;

begin
	Result:=False;
	if not CHECK_ASSIGNED then Exit;
	try
		if not OPEN_FISCAL_BON then Exit;

		if not PRINT_FISCAL_TEXT(' ‡ÒËÂ:') then Exit;
		if not PRINT_FISCAL_TEXT('1 : ¿ƒÃ»Õ') then Exit;
		if not PRINT_FISCAL_TEXT('¿¡.ÕŒÃ≈– 5094636') then Exit;
		if not PRINT_FISCAL_TEXT('¬¿—»À √–»√Œ–Œ¬ ¿À≈ —»≈¬') then Exit;

		ADD_LOG('[CMD_49_5_0]: œ–Œƒ¿∆¡¿ ¬ ƒ≈œ¿–“¿Ã≈Õ“');
		L1	:='¬Ó‰‡;';
		L2	:='—ÓÙËÈÒÍ‡ ‚Ó‰‡ ¿ƒ';
		Dept	:='8';
		Price:='0.7';
		Qwan	:='1';

		case MyFiscDevice of
			dt_DP55_KL:tmp_Int:=FPDP55_KL.CMD_49_5_0(L1,L2,Dept,Price,Qwan);
			dt_FP2000_KL:tmp_Int:=FP2000_KL.CMD_49_5_0(L1,L2,Dept,Price,Qwan);
			dt_FP60_KL:tmp_Int:=FP60_KL.CMD_49_5_0(L1,L2,Dept,Price,Qwan);
			dt_FP_550_KL:tmp_Int:=FP550_KL.CMD_49_5_0(L1,L2,Dept,Price,Qwan);
			dt_FP_550D_KL:tmp_Int:=FP550D_KL.CMD_49_5_0(L1,L2,Dept,Price,Qwan);
		end;
		if tmp_Int <> 0 then
		begin
			tmp_Str:=CALC_ERROR(tmp_Int);
			SHOW_MYALERT(tmp_Str);
			//1. Analize this...
			//2. status bytes or/and CMD_76_0_0
			//3. programatically do something or...
			//4. ...call of administrator
			//...
		end
		else
		begin
			if not MAKE_SUBTOTAL(-99.00) then Exit;
			if not MAKE_TOTAL then Exit;
			if not CLOSE_FISCAL_BON then Exit;

			Result:=True;
			CALC_SWITCHES;
		end;
	except
		Result:=False;
	end;
end;

end.
