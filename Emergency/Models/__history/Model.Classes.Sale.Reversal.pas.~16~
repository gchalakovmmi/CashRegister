unit Model.Classes.Sale.Reversal;

interface

uses
  System.JSON,
  FireDAC.Comp.DataSet,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Reversal;

  function CreateModelClassSaleReversal: IModelClassSaleReversal;
  function CreateFromJSONModelClassSaleReversal(const AJSONObject: TJSONObject): IModelClassSaleReversal;
  function CreateFromDataSetModelClassSaleReversal: IModelClassSaleReversal;
  procedure AssignDataSetModelClassSaleReversal(const ADataSet: TFDDataSet);

implementation

uses
  System.DateUtils,
  System.IOUtils,
  System.SysUtils,
  System.Math,
  Helper.MyFuncs,
  Globals,
  Model.Generator.GIDs,
  Interfaces.Model.Classes.Sale.Cancellation,
  Model.Classes.Sale.Cancellation,
  View.Message;

type
  TModelClassSaleReversal = class(TInterfacedObject, IModelClassSaleReversal)

  {$REGION 'Class Properties'}
  private class var
    FDataSet: TFDDataSet;
  public
    class property DataSet: TFDDataSet read FDataSet write FDataSet;
  {$ENDREGION}


  {$REGION 'Private Methods'}
  private

  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FGID: String;
    FParentGID: String;
    FSaleUniqueID: String;
    FFiscalDeviceID: String;
    FUserGID: String;
    FCompletedDate: String;
    FCompletedTime: String;
    FReversalDate: String;
    FReversalTime: String;
    FItemGID: String;
    FBarCode: String;
    FBaseItemName: String;
    FPackCoeff: String;
    FItemName: String;
    FMeasure: String;
    FQuantity: String;
    FVendorPrice: String;
    FClientSurcharge: String;
    FClientPrice: String;
    FPackDiscount: String;
    FClientPriceBase: String;
    FPrice: String;
    FDiscountValue: String;
    FDiscountType: String;
    FTotalBase: String;
    FVATRate: String;
    FTotalVAT: String;
    FTotal: String;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}


  {$REGION 'Private Properties'}
  private

  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetGID: String;
    procedure SetGID(const AValue: String);
    function GetParentGID: String;
    procedure SetParentGID(const AValue: String);
    function GetSaleUniqueID: String;
    procedure SetSaleUniqueID(const AValue: String);
    function GetFiscalDeviceID: String;
    procedure SetFiscalDeviceID(const AValue: String);
    function GetUserGID: String;
    procedure SetUserGID(const AValue: String);
    function GetCompletedDate: String;
    procedure SetCompletedDate(const AValue: String);
    function GetCompletedTime: String;
    procedure SetCompletedTime(const AValue: String);
    function GetReversalDate: String;
    procedure SetReversalDate(const AValue: String);
    function GetReversalTime: String;
    procedure SetReversalTime(const AValue: String);
    function GetItemGID: String;
    procedure SetItemGID(const AValue: String);
    function GetBarCode: String;
    procedure SetBarCode(const AValue: String);
    function GetBaseItemName: String;
    procedure SetBaseItemName(const AValue: String);
    function GetPackCoeff: String;
    procedure SetPackCoeff(const AValue: String);
    function GetItemName: String;
    procedure SetItemName(const AValue: String);
    function GetMeasure: String;
    procedure SetMeasure(const AValue: String);
    function GetQuantity: String;
    procedure SetQuantity(const AValue: String);
    function GetVendorPrice: String;
    procedure SetVendorPrice(const AValue: String);
    function GetClientSurcharge: String;
    procedure SetClientSurcharge(const AValue: String);
    function GetClientPrice: String;
    procedure SetClientPrice(const AValue: String);
    function GetPackDiscount: String;
    procedure SetPackDiscount(const AValue: String);
    function GetClientPriceBase: String;
    procedure SetClientPriceBase(const AValue: String);
    function GetPrice: String;
    procedure SetPrice(const AValue: String);
    function GetDiscountValue: String;
    procedure SetDiscountValue(const AValue: String);
    function GetDiscountType: String;
    procedure SetDiscountType(const AValue: String);
    function GetTotalBase: String;
    procedure SetTotalBase(const AValue: String);
    function GetVATRate: String;
    procedure SetVATRate(const AValue: String);
    function GetTotalVAT: String;
    procedure SetTotalVAT(const AValue: String);
    function GetTotal: String;
    procedure SetTotal(const AValue: String);
  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public
    ///<sumarry>системен номер на продажбата, присвоен от софтуера</summary>
    property GID: String read GetGID write SetGID;
    ///<sumarry>системен номер на продажбата, присвоен от софтуера</summary>
    property ParentGID: String read GetParentGID write SetParentGID;
    ///<sumarry>уникален номер на продажба - съгласно т. 9</summary>
    property SaleUniqueID: String read GetSaleUniqueID write SetSaleUniqueID;
    ///<sumarry>номер на фискалното устройство, на което е издаден Сторно-ФБ</summary>
    property FiscalDeviceID: String read GetFiscalDeviceID write SetFiscalDeviceID;
    ///<sumarry>номер на оператор, извършил сторнирането</summary>
    property UserGID: String read GetUserGID write SetUserGID;
    ///<sumarry>дата на приключване на продажбата</summary>
    property CompletedDate: String read GetCompletedDate write SetCompletedDate;
    ///<sumarry>време на приключване на продажбата (час, минута, секунда)</summary>
    property CompletedTime: String read GetCompletedTime write SetCompletedTime;
    ///<sumarry>дата на сторниране на продажбата</summary>
    property ReversalDate: String read GetReversalDate write SetReversalDate;
    ///<sumarry>време на сторниране на продажбата (час, минута, секунда)</summary>
    property ReversalTime: String read GetReversalTime write SetReversalTime;
    ///<sumarry>код на стоката/услугата</summary>
    property ItemGID: String read GetItemGID write SetItemGID;
    ///<sumarry>баркод на стоката/услугата</summary>
    property BarCode: String read GetBarCode write SetBarCode;
    ///<sumarry>основно наименование на стоката/услугата</summary>
    property BaseItemName: String read GetBaseItemName write SetBaseItemName;
    ///<sumarry>коефициент количество за групажни стоки</summary>
    property PackCoeff: String read GetPackCoeff write SetPackCoeff;
    ///<sumarry>наименование на стоката/услугата</summary>
    property ItemName: String read GetItemName write SetItemName;
    ///<sumarry>мярка</summary>
    property Measure: String read GetMeasure write SetMeasure;
    ///<sumarry>количество</summary>
    property Quantity: String read GetQuantity write SetQuantity;
    ///<sumarry>доставна цена - с ДДС в лв.</summary>
    property VendorPrice: String read GetVendorPrice write SetVendorPrice;
    ///<sumarry>процент надценка над доставната цена (за VIP клиенти)</summary>
    property ClientSurcharge: String read GetClientSurcharge write SetClientSurcharge;
    ///<sumarry>клиентска цена - с ДДС в лв.</summary>
    property ClientPrice: String read GetClientPrice write SetClientPrice;
    ///<sumarry>процент отстъпка за групажни стоки</summary>
    property PackDiscount: String read GetPackDiscount write SetPackDiscount;
    ///<sumarry>единична цена (без отстъпка) - без ДДС, в лв.</summary>
    property ClientPriceBase: String read GetClientPriceBase write SetClientPriceBase;
    ///<sumarry>продажна цена (с отстъпка) - с ДДС, в лв.</summary>
    property Price: String read GetPrice write SetPrice;
    ///<sumarry>отстъпка (сума) - в лв.</summary>
    property DiscountValue: String read GetDiscountValue write SetDiscountValue;
    ///<sumarry>вид изменение на основната цена (0 - няма, 4 - отстъпка сума)</summary>
    property DiscountType: String read GetDiscountType write SetDiscountType;
    ///<sumarry>обща сума - без ДДС, в лв.</summary>
    property TotalBase: String read GetTotalBase write SetTotalBase;
    ///<sumarry>ДДС ставка</summary>
    property VATRate: String read GetVATRate write SetVATRate;
    ///<sumarry>ДДС - сума - в лв.</summary>
    property TotalVAT: String read GetTotalVAT write SetTotalVAT;
    ///<sumarry>обща сума - в лв.</summary>
    property Total: String read GetTotal write SetTotal;
  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    procedure UpdateFromDataSet;
    procedure UpdateInDataSet;

    function ToJSON: TJSONObject;
    procedure ToFile;
  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public
    constructor CreateFromJSON(const AJSONObject: TJSONObject);
  {$ENDREGION}
  end;

function CreateModelClassSaleReversal: IModelClassSaleReversal;
begin
  Result := TModelClassSaleReversal.Create;
  Result.GID := TGeneratorGIDs.NewGIDByName('SaleReversalGID').ToString;
end;

function CreateFromJSONModelClassSaleReversal(const AJSONObject: TJSONObject): IModelClassSaleReversal;
begin
  Result := TModelClassSaleReversal.CreateFromJSON(AJSONObject);
end;

function CreateFromDataSetModelClassSaleReversal: IModelClassSaleReversal;
begin
  Result := TModelClassSaleReversal.Create;
  Result.UpdateFromDataSet;
end;

procedure AssignDataSetModelClassSaleReversal(const ADataSet: TFDDataSet);
begin
  TModelClassSaleReversal.DataSet := ADataSet;
end;

{ TModelClassSaleReversal }

{$REGION 'Private Methods'}

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TModelClassSaleReversal.GetGID: String;
begin
  Result := FGID;
end;

procedure TModelClassSaleReversal.SetGID(const AValue: String);
begin
  FGID := AValue;
end;

function TModelClassSaleReversal.GetParentGID: String;
begin
  Result := FParentGID;
end;

procedure TModelClassSaleReversal.SetParentGID(const AValue: String);
begin
  FParentGID := AValue;
end;

function TModelClassSaleReversal.GetSaleUniqueID: String;
begin
  Result := FSaleUniqueID;
end;

procedure TModelClassSaleReversal.SetSaleUniqueID(const AValue: String);
begin
  FSaleUniqueID := AValue;
end;

function TModelClassSaleReversal.GetFiscalDeviceID: String;
begin
  Result := FFiscalDeviceID;
end;

procedure TModelClassSaleReversal.SetFiscalDeviceID(const AValue: String);
begin
  FFiscalDeviceID := AValue;
end;

function TModelClassSaleReversal.GetUserGID: String;
begin
  Result := FUserGID;
end;

procedure TModelClassSaleReversal.SetUserGID(const AValue: String);
begin
  FUserGID := AValue;
end;

function TModelClassSaleReversal.GetCompletedDate: String;
begin
  Result := FCompletedDate;
end;

procedure TModelClassSaleReversal.SetCompletedDate(const AValue: String);
begin
  FCompletedDate := AValue;
end;

function TModelClassSaleReversal.GetCompletedTime: String;
begin
  Result := FCompletedTime;
end;

procedure TModelClassSaleReversal.SetCompletedTime(const AValue: String);
begin
  FCompletedTime := AValue;
end;

function TModelClassSaleReversal.GetReversalDate: String;
begin
  Result := FReversalDate;
end;

procedure TModelClassSaleReversal.SetReversalDate(const AValue: String);
begin
  FReversalDate := AValue;
end;

function TModelClassSaleReversal.GetReversalTime: String;
begin
  Result := FReversalTime;
end;

procedure TModelClassSaleReversal.SetReversalTime(const AValue: String);
begin
  FReversalTime := AValue;
end;

function TModelClassSaleReversal.GetItemGID: String;
begin
  Result := FItemGID;
end;

procedure TModelClassSaleReversal.SetItemGID(const AValue: String);
begin
  FItemGID := AValue;
end;

function TModelClassSaleReversal.GetBarCode: String;
begin
  Result := FBarCode;
end;

procedure TModelClassSaleReversal.SetBarCode(const AValue: String);
begin
  FBarCode := AValue;
end;

function TModelClassSaleReversal.GetBaseItemName: String;
begin
  Result := FBaseItemName;
end;

procedure TModelClassSaleReversal.SetBaseItemName(const AValue: String);
begin
  FBaseItemName := AValue;
end;

function TModelClassSaleReversal.GetPackCoeff: String;
begin
  Result := FPackCoeff;
end;

procedure TModelClassSaleReversal.SetPackCoeff(const AValue: String);
begin
  FPackCoeff := AValue;
end;

function TModelClassSaleReversal.GetItemName: String;
begin
  Result := FItemName;
end;

procedure TModelClassSaleReversal.SetItemName(const AValue: String);
begin
  FItemName := AValue;
end;

function TModelClassSaleReversal.GetMeasure: String;
begin
  Result := FMeasure;
end;

procedure TModelClassSaleReversal.SetMeasure(const AValue: String);
begin
  FMeasure := AValue;
end;

function TModelClassSaleReversal.GetQuantity: String;
begin
  Result := FQuantity;
end;

procedure TModelClassSaleReversal.SetQuantity(const AValue: String);
begin
  FQuantity := AValue;
end;

function TModelClassSaleReversal.GetVendorPrice: String;
begin
  Result := FVendorPrice;
end;

procedure TModelClassSaleReversal.SetVendorPrice(const AValue: String);
begin
  FVendorPrice := AValue;
end;

function TModelClassSaleReversal.GetClientSurcharge: String;
begin
  Result := FClientSurcharge;
end;

procedure TModelClassSaleReversal.SetClientSurcharge(const AValue: String);
begin
  FClientSurcharge := AValue;
end;

function TModelClassSaleReversal.GetClientPrice: String;
begin
  Result := FClientPrice;
end;

procedure TModelClassSaleReversal.SetClientPrice(const AValue: String);
begin
  FClientPrice := AValue;
end;

function TModelClassSaleReversal.GetPackDiscount: String;
begin
  Result := FPackDiscount;
end;

procedure TModelClassSaleReversal.SetPackDiscount(const AValue: String);
begin
  FPackDiscount := AValue;
end;

function TModelClassSaleReversal.GetClientPriceBase: String;
begin
  Result := FClientPriceBase;
end;

procedure TModelClassSaleReversal.SetClientPriceBase(const AValue: String);
begin
  FClientPriceBase := AValue;
end;

function TModelClassSaleReversal.GetPrice: String;
begin
  Result := FPrice;
end;

procedure TModelClassSaleReversal.SetPrice(const AValue: String);
begin
  FPrice := AValue;
end;

function TModelClassSaleReversal.GetDiscountValue: String;
begin
  Result := FDiscountValue;
end;

procedure TModelClassSaleReversal.SetDiscountValue(const AValue: String);
begin
  FDiscountValue := AValue;
end;

function TModelClassSaleReversal.GetDiscountType: String;
begin
  Result := FDiscountType;
end;

procedure TModelClassSaleReversal.SetDiscountType(const AValue: String);
begin
  FDiscountType := AValue;
end;

function TModelClassSaleReversal.GetTotalBase: String;
begin
  Result := FTotalBase;
end;

procedure TModelClassSaleReversal.SetTotalBase(const AValue: String);
begin
  FTotalBase := AValue;
end;

function TModelClassSaleReversal.GetVATRate: String;
begin
  Result := FVATRate;
end;

procedure TModelClassSaleReversal.SetVATRate(const AValue: String);
begin
  FVATRate := AValue;
end;

function TModelClassSaleReversal.GetTotalVAT: String;
begin
  Result := FTotalVAT;
end;

procedure TModelClassSaleReversal.SetTotalVAT(const AValue: String);
begin
  FTotalVAT := AValue;
end;

function TModelClassSaleReversal.GetTotal: String;
begin
  Result := FTotal;
end;

procedure TModelClassSaleReversal.SetTotal(const AValue: String);
begin
  FTotal := AValue;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TModelClassSaleReversal.UpdateFromDataSet;
begin
  GID := DataSet.FieldByName('GID').AsString;
  ParentGID := DataSet.FieldByName('ParentGID').AsString;
  SaleUniqueID := DataSet.FieldByName('SaleUniqueID').AsString;
  FiscalDeviceID := DataSet.FieldByName('FiscalDeviceID').AsString;
  UserGID := DataSet.FieldByName('UserGID').AsString;
  CompletedDate := DataSet.FieldByName('CompletedDate').AsString;
  CompletedTime := DataSet.FieldByName('CompletedTime').AsString;
  ReversalDate := DataSet.FieldByName('ReversalDate').AsString;
  ReversalTime := DataSet.FieldByName('ReversalTime').AsString;
  ItemGID := DataSet.FieldByName('ItemGID').AsString;
  BarCode := DataSet.FieldByName('BarCode').AsString;
  BaseItemName := DataSet.FieldByName('BaseItemName').AsString;
  PackCoeff := DataSet.FieldByName('PackCoeff').AsString;
  ItemName := DataSet.FieldByName('ItemName').AsString;
  Measure := DataSet.FieldByName('Measure').AsString;
  Quantity := DataSet.FieldByName('Quantity').AsString;
  VendorPrice := DataSet.FieldByName('VendorPrice').AsString;
  ClientSurcharge := DataSet.FieldByName('ClientSurcharge').AsString;
  ClientPrice := DataSet.FieldByName('ClientPrice').AsString;
  PackDiscount := DataSet.FieldByName('PackDiscount').AsString;
  ClientPriceBase := DataSet.FieldByName('ClientPriceBase').AsString;
  Price := DataSet.FieldByName('Price').AsString;
  DiscountValue := DataSet.FieldByName('DiscountValue').AsString;
  DiscountType := DataSet.FieldByName('DiscountType').AsString;
  TotalBase := DataSet.FieldByName('TotalBase').AsString;
  VATRate := DataSet.FieldByName('VATRate').AsString;
  TotalVAT := DataSet.FieldByName('TotalVAT').AsString;
  Total := DataSet.FieldByName('Total').AsString;
end;

procedure TModelClassSaleReversal.UpdateInDataSet;
begin
  if DataSet.Locate('GID', GID) then begin
    DataSet.Edit;
  end else begin
    DataSet.Append;
  end;

  DataSet.FieldByName('GID').AsString := GID;
  DataSet.FieldByName('ParentGID').AsString := ParentGID;
  DataSet.FieldByName('SaleUniqueID').AsString := SaleUniqueID;
  DataSet.FieldByName('FiscalDeviceID').AsString := FiscalDeviceID;
  DataSet.FieldByName('UserGID').AsString := UserGID;
  DataSet.FieldByName('CompletedDate').AsString := CompletedDate;
  DataSet.FieldByName('CompletedTime').AsString := CompletedTime;
  DataSet.FieldByName('ReversalDate').AsString := ReversalDate;
  DataSet.FieldByName('ReversalTime').AsString := ReversalTime;
  DataSet.FieldByName('ItemGID').AsString := ItemGID;
  DataSet.FieldByName('BarCode').AsString := BarCode;
  DataSet.FieldByName('BaseItemName').AsString := BaseItemName;
  DataSet.FieldByName('PackCoeff').AsString := PackCoeff;
  DataSet.FieldByName('ItemName').AsString := ItemName;
  DataSet.FieldByName('Measure').AsString := Measure;
  DataSet.FieldByName('Quantity').AsString := Quantity;
  DataSet.FieldByName('VendorPrice').AsString := VendorPrice;
  DataSet.FieldByName('ClientSurcharge').AsString := ClientSurcharge;
  DataSet.FieldByName('ClientPrice').AsString := ClientPrice;
  DataSet.FieldByName('PackDiscount').AsString := PackDiscount;
  DataSet.FieldByName('ClientPriceBase').AsString := ClientPriceBase;
  DataSet.FieldByName('Price').AsString := Price;
  DataSet.FieldByName('DiscountValue').AsString := DiscountValue;
  DataSet.FieldByName('DiscountType').AsString := DiscountType;
  DataSet.FieldByName('TotalBase').AsString := TotalBase;
  DataSet.FieldByName('VATRate').AsString := VATRate;
  DataSet.FieldByName('TotalVAT').AsString := TotalVAT;
  DataSet.FieldByName('Total').AsString := Total;

  DataSet.Post;
end;

function TModelClassSaleReversal.ToJSON: TJSONObject;
begin
  Result := TJSONObject.Create;
  Result.AddPair('GID', GID);
  Result.AddPair('ParentGID', ParentGID);
  Result.AddPair('SaleUniqueID', SaleUniqueID);
  Result.AddPair('FiscalDeviceID', FiscalDeviceID);
  Result.AddPair('UserGID', UserGID);
  Result.AddPair('CompletedDate', CompletedDate);
  Result.AddPair('CompletedTime', CompletedTime);
  Result.AddPair('ReversalDate', ReversalDate);
  Result.AddPair('ReversalTime', ReversalTime);
  Result.AddPair('ItemGID', ItemGID);
  Result.AddPair('BarCode', BarCode);
  Result.AddPair('BaseItemName', BaseItemName);
  Result.AddPair('PackCoeff', PackCoeff);
  Result.AddPair('ItemName', ItemName);
  Result.AddPair('Measure', Measure);
  Result.AddPair('Quantity', Quantity);
  Result.AddPair('VendorPrice', VendorPrice);
  Result.AddPair('ClientSurcharge', ClientSurcharge);
  Result.AddPair('ClientPrice', ClientPrice);
  Result.AddPair('PackDiscount', PackDiscount);
  Result.AddPair('ClientPriceBase', ClientPriceBase);
  Result.AddPair('Price', Price);
  Result.AddPair('DiscountValue', DiscountValue);
  Result.AddPair('DiscountType', DiscountType);
  Result.AddPair('TotalBase', TotalBase);
  Result.AddPair('VATRate', VATRate);
  Result.AddPair('TotalVAT', TotalVAT);
  Result.AddPair('Total', Total);
end;

procedure TModelClassSaleReversal.ToFile;
var
  LTemplateFileName: String;
  LTempFileName: String;
  LResultFileName: String;

  LSQL: String;
  LCashPayment: String;
begin
  LTemplateFileName := TPath.Combine(G.TempFolder,'details.db');
  LTempFileName := TPath.Combine(G.TempFolder, 't'+GID+'_'+FormatDateTime('yyyy.mm', Date)+'_'+StoreID+'_3002.tmp');
  LResultFileName := TPath.Combine(G.TempFolder, 't'+GID+'_'+FormatDateTime('yyyy.mm', Date)+'_'+StoreID+'_3002.db');
  // Copy template
  TFile.Copy(LTemplateFileName, LTempFileName);

// Store Details
  LSQL :=
    // OPERATIONID
    GID+', '''+
    // OPNUMBER
    SaleID+''', '''+
    // ONDATE
    DateToStr(Date)+''', '''+
    // ONTIME
    TimeToStr(TimeOf(Now))+''', '+
    // OPGROUP
    '2001, '+
    // OPTYPE
    '3002, '+
    // FROMCONTRAGENTID
    StoreID+', '+
    // TOCONTRAGENTID
    ClientGID+', '''+
    // VIP
    ClientVIPStatus+''', '+
    // MARKUP
    ClientSurcharge+', '+
    // ITEMID
    ItemGID+', '''+
    // BARCODE
    BarCode+''', '''+
    // DESCRIPTION
    ItemName+''', '''+
    // MEASURE
    Measure+''', '+
    // COEFF
    PackCoeff+', '+
    // QUANTITY
    Quantity+', '+
    // TOTALQUANTITY
    FormatFloat('0.000', _Round(Quantity.ToDouble * PackCoeff.ToDouble, 0.001))+', '+
    // PRICE
    FormatFloat('0.00', _Round(ClientPrice.ToDouble / PackCoeff.ToDouble, 0.01))+', '+
    // DISCOUNT
    PackDiscount+', '+
    // VENDORPRICE
    FormatFloat('0.0000', _Round(VendorPrice.ToDouble / PackCoeff.ToDouble, 0.0001))+', '+
    // TOTAL
    FormatFloat('0.00', _Round(Total.ToDouble, 0.01))+', '+
    // ACT
    '''*'', '+
    // USERID
    UserGID+', '+
    // MACHINEID
    WorkstationID+', '''+
    // TYPED
    Typed+'''';

  LSQL := 'INSERT INTO "'+LTempFileName+'" (OPERATIONID,OPNUMBER,ONDATE,ONTIME,OPGROUP,OPTYPE,FROMCONTRAGENTID,TOCONTRAGENTID,VIP,MARKUP,ITEMID,BARCODE,DESCRIPTION,MEASURE,COEFF,QUANTITY,TOTALQUANTITY,PRICE,DISCOUNT,VENDORPRICE,TOTAL,ACT,USERID,MACHINEID,TYPED) VALUES ('+LSQL+')';

  // Store to Temp File
  ExecSQL(LSQL);


  // Store Payments
  LCashPayment := FormatFloat('0.00', _Round(CashPayment.ToDouble - Returned.ToDouble, 0.01));
  LSQL :=
    GID+', '''+                     // OPERATIONID
    SaleID+''', '''+                // OPNUMBER
    DateToStr(Date)+''', '''+       // ONDATE
    TimeToStr(TimeOf(Now))+''', '+  // ONTIME
    '2001, '+                       // OPGROUP
    '3009, '+                       // OPTYPE
    StoreID+', '+                   // FROMCONTRAGENTID
    ClientGID+', '+                 // TOCONTRAGENTID
    '1000'+', '''+                  // ITEMID
    ''+''', '''+                    // BARCODE
    'ПАРИ В БРОЙ'+''', '''+         // DESCRIPTION
    'ЛЕВА'+''', '+                  // MEASURE
    '1, '+                          // COEFF
    LCashPayment+', '+              // QUANTITY
    LCashPayment+', '+              // TOTALQUANTITY
    '1'+', '+                       // PRICE
    '1'+', '+                       // VENDORPRICE
    LCashPayment+', '+              // TOTAL
    '''*'', '+                      // ACT
    UserGID+', '+                   // USERID
    WorkstationID+', '''+           // MACHINEID
    ' '+'''';                       // TYPED

  LSQL := 'INSERT INTO "'+LTempFileName+'" (OPERATIONID, OPNUMBER, ONDATE, ONTIME, OPGROUP, OPTYPE, FROMCONTRAGENTID, TOCONTRAGENTID, ITEMID, BARCODE, DESCRIPTION, MEASURE, COEFF, QUANTITY, TOTALQUANTITY, PRICE, VENDORPRICE, TOTAL, ACT, USERID, MACHINEID, TYPED) VALUES ('+LSQL+')';
  ExecSQL(LSQL);

  // Rename template to result
  TFile.Move(LTempFileName, LResultFileName);
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

constructor TModelClassSaleReversal.CreateFromJSON(const AJSONObject: TJSONObject);
begin
  GID := (AJSONObject.GetValue('GID') as TJSONString).Value;
  ParentGID := (AJSONObject.GetValue('ParentGID') as TJSONString).Value;
  SaleUniqueID := (AJSONObject.GetValue('SaleUniqueID') as TJSONString).Value;
  FiscalDeviceID := (AJSONObject.GetValue('FiscalDeviceID') as TJSONString).Value;
  UserGID := (AJSONObject.GetValue('UserGID') as TJSONString).Value;
  CompletedDate := (AJSONObject.GetValue('CompletedDate') as TJSONString).Value;
  CompletedTime := (AJSONObject.GetValue('CompletedTime') as TJSONString).Value;
  ReversalDate := (AJSONObject.GetValue('ReversalDate') as TJSONString).Value;
  ReversalTime := (AJSONObject.GetValue('ReversalTime') as TJSONString).Value;
  ItemGID := (AJSONObject.GetValue('ItemGID') as TJSONString).Value;
  BarCode := (AJSONObject.GetValue('BarCode') as TJSONString).Value;
  BaseItemName := (AJSONObject.GetValue('BaseItemName') as TJSONString).Value;
  PackCoeff := (AJSONObject.GetValue('PackCoeff') as TJSONString).Value;
  ItemName := (AJSONObject.GetValue('ItemName') as TJSONString).Value;
  Measure := (AJSONObject.GetValue('Measure') as TJSONString).Value;
  Quantity := (AJSONObject.GetValue('Quantity') as TJSONString).Value;
  VendorPrice := (AJSONObject.GetValue('VendorPrice') as TJSONString).Value;
  ClientSurcharge := (AJSONObject.GetValue('ClientSurcharge') as TJSONString).Value;
  ClientPrice := (AJSONObject.GetValue('ClientPrice') as TJSONString).Value;
  PackDiscount := (AJSONObject.GetValue('PackDiscount') as TJSONString).Value;
  ClientPriceBase := (AJSONObject.GetValue('ClientPriceBase') as TJSONString).Value;
  Price := (AJSONObject.GetValue('Price') as TJSONString).Value;
  DiscountValue := (AJSONObject.GetValue('DiscountValue') as TJSONString).Value;
  DiscountType := (AJSONObject.GetValue('DiscountType') as TJSONString).Value;
  TotalBase := (AJSONObject.GetValue('TotalBase') as TJSONString).Value;
  VATRate := (AJSONObject.GetValue('VATRate') as TJSONString).Value;
  TotalVAT := (AJSONObject.GetValue('TotalVAT') as TJSONString).Value;
  Total := (AJSONObject.GetValue('Total') as TJSONString).Value;
end;

{$ENDREGION}

end.

