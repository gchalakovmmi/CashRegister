unit Model.Sale;

interface

uses
  Interfaces.Model.Sale;

  function CreateModelSale: IModelSale;

implementation

uses
  System.SysUtils,
  System.IOUtils,
  Vcl.Dialogs,
  Globals,
  Helper.MyFuncs,
  Device.FP700X,
  DataModule.Sale,
  DataModule.Items,
  DataModule.Clients,
  View.Message,
  Interfaces.Model.Classes.Sale,
  Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Cancellation, Model.AppSettings;

type
  TModelSale = class(TInterfacedObject, IModelSale)

  {$REGION 'Private Methods'}
  private
    function ItemIsValidForSale(const ASaleDetail: IModelClassSaleDetail): Boolean;
    function ItemIsValidForCancellation(const ASaleCancellation: IModelClassSaleCancellation): Boolean;
  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FSale: IModelClassSale;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}


  {$REGION 'Private Properties'}
  private

  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetSale: IModelClassSale;
  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public
    property Sale: IModelClassSale read GetSale;
  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    // Setup/Teardown
    procedure SetupSale;
    procedure UpdateSaleClient;
    procedure TeardownSale;

    // Sale Actions
    procedure OpenSale;
    procedure RegistrationOfSale;
    procedure RegistrationOfCancellation;
    procedure Totals;
    procedure DiscardSale;
    procedure CloseSale;
    procedure DuplicateReceipt;

    // Sale's Payments Updates
    procedure UpdateSaleCashPayment(const ACashPayment: String);
    procedure UpdateSaleVoucherPayment(const AVoucherPayment: String);
    procedure UpdateSaleCardPayment(const ACardPayment: String);
  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}
  end;

function CreateModelSale: IModelSale;
begin
  Result := TModelSale.Create;
end;

{ TModelSale }

{$REGION 'Private Methods'}

function TModelSale.ItemIsValidForSale(const ASaleDetail: IModelClassSaleDetail): Boolean;
begin
  Result := False;

  // Check for positive Due
  if (FSale.Due.ToDouble + ASaleDetail.Total.ToDouble) < -0.009 then begin
    ViewMessage.ShowBadMessagePlus('САЛДОТО ПО ОПЕРАЦИЯТА НЕ ТРЯБВА ДА Е ОТРИЦАТЕЛНО!');
    Exit;
  end;

  Result := True;
end;

function TModelSale.ItemIsValidForCancellation(const ASaleCancellation: IModelClassSaleCancellation): Boolean;
begin
  Result := False;

  if not (ASaleCancellation.Quantity.ToDouble < 0) then begin
    ViewMessage.ShowBadMessagePlus('КОЛИЧЕСТВОТО ТРЯБВА ДА Е ОТРИЦАТЕЛНО ЧИСЛО! ('+ASaleCancellation.Quantity+')');
    Exit;
  end;

  // Check for positive Due
  if (FSale.Due.ToDouble + ASaleCancellation.Total.ToDouble) < -0.009 then begin
    ViewMessage.ShowBadMessagePlus('САЛДОТО ПО ОПЕРАЦИЯТА НЕ ТРЯБВА ДА Е ОТРИЦАТЕЛНО!');
    Exit;
  end;

  Result := True;
end;

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TModelSale.GetSale: IModelClassSale;
begin
  Result := FSale;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

// Setup/Teardown

procedure TModelSale.SetupSale;
var
  LLastSaleFileName: String;
  LLastReceiptID: String;
  LOpenReceiptNumber: WideString;
  LOpenReceiptMissingPayment: WideString;

  procedure SetupNewSale;
  begin
    FSale := CreateModelClassSale;

    FSale.SetupSale;

    DeviceFP700X.SetupSale(FSale);

    DataModuleSale.SetupSale(FSale);
  end;

begin

  if TFile.Exists(TPath.Combine(G.ItemsFolder, 'start.txt')) or TFile.Exists(TPath.Combine(G.ItemsFolder, 'SelectItems.dat')) then begin
    DataModuleItems.RefreshData;

    DataModuleClients.RefreshData;

    if TFile.Exists(TPath.Combine(G.ItemsFolder, 'new.txt')) then begin
      TFile.Delete(TPath.Combine(G.ItemsFolder, 'new.txt'));
    end;

    if TFile.Exists(TPath.Combine(G.ItemsFolder, 'start.txt')) then begin
      TFile.Delete(TPath.Combine(G.ItemsFolder, 'start.txt'));
    end;

    if TFile.Exists(TPath.Combine(G.ItemsFolder, 'SelectItems.dat')) then begin
      TFile.Delete(TPath.Combine(G.ItemsFolder, 'SelectItems.dat'));
    end;
  end;

  DataModuleClients.SelectCommonClient;

  LLastSaleFileName := TAppSettings.GetSetting('LastSaleFileName');
  if LLastSaleFileName = '' then begin
    FSale := CreateModelClassSale;
  end else begin
    ViewMessage.ShowBadMessage('Зарежда данни за неприключена продажба . . .');
    FSale := CreateFromFileModelClassSale(LLastSaleFileName);
    FSale.CloseSale;
    Halt;
  end;
  LLastReceiptID := TAppSettings.GetSetting('LastReceiptID');

  if (LLastSaleFileName = '') and DeviceFP700X.ReceiptIsClosed then begin
    // No open sale in database. No open receipt in fiscal device
    SetupNewSale;
    Exit;
  end;

  if Assigned(FSale) then begin
    if FSale.Stage = 'подготвена' then begin
      if DeviceFP700X.ReceiptIsClosed then begin
        SetupNewSale;
        Exit;
      end else begin
        raise Exception.Create('Има подготвена продажба, но има и отворена бележка!');
      end;
    end;
    if FSale.Stage = 'отворена' then begin
      if not DeviceFP700X.ReceiptIsClosed then begin
        if DeviceFP700X.FiscalReceiptIsOpen then begin
          if not DeviceFP700X.OpenReceiptWithoutItems then begin
            if FSale.ReceiptID = DeviceFP700X.OpenReceiptNumber then begin
              Exit;
            end else begin
              raise Exception.Create('Има отворена продажба и започната бележка, но са с различни номера!');
            end;
          end else begin
            raise Exception.Create('Има отворена продажба, но има бележка с продажби!');
          end;
        end else begin
          raise Exception.Create('Има отворена продажба, но отворената бележка не е фискална!');
        end;
      end else begin
        raise Exception.Create('Има отворена продажба, но няма отворена бележка!');
      end;
    end;
    if FSale.Stage = 'налични продажби' then begin
      if not DeviceFP700X.ReceiptIsClosed then begin
        if DeviceFP700X.FiscalReceiptIsOpen then begin
          if FSale.ReceiptID = DeviceFP700X.OpenReceiptNumber then begin
            if (FSale.Details.List.Count - FSale.Cancellations.List.Count).ToString = DeviceFP700X.OpenReceiptItems then begin
              if FSale.Due = DeviceFP700X.OpenReceiptAmount then begin
                if DeviceFP700X.OpenReceiptWithNoPayment then begin
                  DataModuleSale.ReloadSale(FSale);
                  Exit;
                end else begin
                  ViewMessage.ShowBadMessagePlus('Открите е започната продажба с частично плащане. Ще бъде автоматично приключена!');
                  DataModuleSale.ReloadSale(FSale);
                  Totals;
                  CloseSale;
                  SetupNewSale;
                  Exit;
//                  raise Exception.Create('Има продажба с налични продажби, но бележката е с направени плащания!');
                end;
              end else begin
                raise Exception.Create('Има продажба с налични продажби, но бележката е с различна сума!');
              end;
            end else begin
              raise Exception.Create('Има продажба с налични продажби, но бележката е с различен брой продажби!');
            end;
          end else begin
            raise Exception.Create('Има продажба с налични продажби и започната бележка, но са с различни номера!');
          end;
        end else begin
          raise Exception.Create('Има продажба с налични продажби, но отворената бележка не е фискална!');
        end;
      end else begin
        raise Exception.Create('Има продажба с налични продажби, но няма отворена бележка!');
      end;
    end;
    if FSale.Stage = 'налични плащания' then begin
      if not DeviceFP700X.ReceiptIsClosed then begin
        if DeviceFP700X.FiscalReceiptIsOpen then begin
          if FSale.ReceiptID = DeviceFP700X.OpenReceiptNumber then begin
            if (FSale.Details.List.Count - FSale.Cancellations.List.Count).ToString = DeviceFP700X.OpenReceiptItems then begin
              if FSale.Due = DeviceFP700X.OpenReceiptAmount then begin
                ViewMessage.ShowBadMessagePlus('Открите е започната продажба с частично плащане. Ще бъде автоматично приключена!');
                DataModuleSale.ReloadSale(FSale);
                Totals;
                CloseSale;
                SetupNewSale;
                Exit;
              end else begin
                raise Exception.Create('Има продажба с налични плащания, но бележката е с различна сума!');
              end;
            end else begin
              raise Exception.Create('Има продажба с налични плащания, но бележката е с различен брой продажби!');
            end;
          end else begin
            raise Exception.Create('Има продажба с налични плащания и започната бележка, но са с различни номера!');
          end;
        end else begin
          raise Exception.Create('Има продажба с налични плащания, но отворената бележка не е фискална!');
        end;
      end else begin
        raise Exception.Create('Има продажба с налични плащания, но няма отворена бележка!');
      end;
    end;
    if FSale.Stage = 'приключена' then begin
      if DeviceFP700X.ReceiptIsClosed then begin
        SetupNewSale;
        Exit;
      end else begin
        raise Exception.Create('Има приключена продажба, но има и отворена бележка!');
      end;
    end;
  end;


  if DeviceFP700X.FiscalReceiptIsOpen then begin
    if DeviceFP700X.OpenReceiptWithFullPayment then begin
      DeviceFP700X.CloseSale(nil);
      SetupNewSale;
      Exit;
    end;
    if DeviceFP700X.OpenReceiptWithPartialPayment then begin
      DeviceFP700X.CloseSale(nil);
      SetupNewSale;
      Exit;
    end;
  end;


//  if LLastSaleFileName = '' then begin
//    if DeviceFP700X.NonFiscalReceiptIsOpen then begin
//      // No open sale in database. Non fiscal receipt is open
//      DeviceFP700X.CloseNonFiscalReceipt;
//
//      FSale := CreateModelClassSale;
//
//      FSale.SetupSale;
//
//      DeviceFP700X.SetupSale(FSale);
//
//      DataModuleSale.SetupSale(FSale);
//
//      Exit;
//    end;
//  end;
//
//  if LLastSaleFileName = '' then begin
//    if DeviceFP700X.OpenReceiptWithoutDue then begin
//      // No open sale in database. Fiscal/reversal receipt is open without due
//
//      {TODO -oOwner -cGeneral : ActionItem}
//
//      Exit;
//    end;
//  end;
//
//  if LLastSaleFileName = '' then begin
//    if DeviceFP700X.OpenReceiptWithNoPayment then begin
//      // No open sale in database. Fiscal/reversal receipt is open with no payment
//
//      {TODO -oOwner -cGeneral : ActionItem}
//
//      Exit;
//    end;
//  end;
//
//  if LLastSaleFileName = '' then begin
//    if DeviceFP700X.OpenReceiptWithPartialPayment then begin
//      // No open sale in database. Fiscal/reversal receipt is open with partial payment
//
//      {TODO -oOwner -cGeneral : ActionItem}
//
//      Exit;
//    end;
//  end;
//
//  if LLastSaleFileName = '' then begin
//    if DeviceFP700X.OpenReceiptWithFullPayment then begin
//      // No open sale in database. Fiscal/reversal receipt is open with full payment
//
//      {TODO -oOwner -cGeneral : ActionItem}
//
//      Exit;
//    end;
//  end;
//
//
//
//  FSale := CreateFromFileModelClassSale(LLastSaleFileName);
//
//  if DeviceFP700X.ReceiptIsClosed then begin
//    // Open sale in database. No open receipt in fiscal device
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;
//
//  if DeviceFP700X.NonFiscalReceiptIsOpen then begin
//    // Open sale in database. Non fiscal receipt is open
//    DeviceFP700X.CloseNonFiscalReceipt;
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;
//
//  if DeviceFP700X.OpenReceiptWithoutDue then begin
//    // Open sale in database. Fiscal/reversal receipt is open without due
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;
//
//  if DeviceFP700X.OpenReceiptWithNoPayment then begin
//    // Open sale in database. Fiscal/reversal receipt is open with no payment
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;
//
//  if DeviceFP700X.OpenReceiptWithPartialPayment then begin
//    // Open sale in database. Fiscal/reversal receipt is open with partial payment
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;
//
//  if DeviceFP700X.OpenReceiptWithFullPayment then begin
//    // Open sale in database. Fiscal/reversal receipt is open with full payment
//
//    {TODO -oOwner -cGeneral : ActionItem}
//
//    Exit;
//  end;


//      if LLastSaleFileName = '' then begin
//        if DeviceFP700X.OpenReceiptWithFullPayment then begin
//          // No open sale in database. Fiscal/reversal receipt is open with payment
//
//          LOpenReceiptNumber := DeviceFP700X.OpenReceiptNumber;
//          LOpenReceiptMissingPayment := DeviceFP700X.OpenReceiptMissingPayment;
//          FSale := CreateModelClassSale;
//
//
//        end else begin
//          // No open sale in database. Fiscal/reversal receipt is open without payment
//
//        end;
//
//
//      end;
//
//    end;
//
//
//  end else begin
//    // Open sale in database
//
//  end;


  FSale := CreateModelClassSale;

  FSale.SetupSale;

  DeviceFP700X.SetupSale(FSale);

  DataModuleSale.SetupSale(FSale);
end;

procedure TModelSale.UpdateSaleClient;
begin
  FSale.ClientGID := DataModuleClients.SelectedID.ToString;
  FSale.ClientName := DataModuleClients.SelectedNAME;
  FSale.ClientTaxNumberType := '0';
  FSale.ClientTaxNumber := DataModuleClients.SelectedTAXNUMBER;
  FSale.ClientAddress := '';
  FSale.ClientReceiver := '';
  FSale.ClientBuyer := '';
  FSale.ClientVIPStatus := ''; if DataModuleClients.SelectedVIP then FSale.ClientVIPStatus := '*';
  FSale.ClientSurcharge := FormatFloat('0.00', DataModuleClients.SelectedMARKUP);
  FSale.UpdateInDataSet;
end;

procedure TModelSale.TeardownSale;
begin
// nop
end;


// Sale Actions

procedure TModelSale.OpenSale;
begin
  // Open Fiscal Receipt
  DeviceFP700X.OpenSale(FSale);

  // Open in Model
  FSale.OpenSale;

  // Open in MemTable
  DataModuleSale.OpenSale(FSale);
end;

procedure TModelSale.RegistrationOfSale;
var
  LSaleDetail: IModelClassSaleDetail;
begin
  LSaleDetail := CreateFromSelectedItemModelClassSaleDetail(
    DataModuleItems.SelectedTYPED,
    DataModuleItems.SelectedID.ToString,
    DataModuleItems.SelectedBARCODE,
    DataModuleItems.SelectedNAME,
    DataModuleItems.SelectedCOEFF.ToString,
    DataModuleItems.SelectedMEASURE,
    FormatFloat('0.000', DataModuleItems.SelectedQUANTITY),
    FormatFloat('0.0000', _Round(DataModuleItems.SelectedVENDORPRICE*DataModuleItems.SelectedCOEFF, 0.0001)),
    FormatFloat('0.00', _Round(DataModuleItems.SelectedCLIENTPRICE*DataModuleItems.SelectedCOEFF, 0.01)),
    DataModuleItems.SelectedDISCOUNT.ToString,
    FSale.GID,
    FSale.SaleUniqueID,
    FSale.CreatedDate,
    FSale.CreatedTime,
    FSale.ClientSurcharge,
    FSale.ClientVIPStatus
  );

  if ItemIsValidForSale(LSaleDetail) then begin
    // Fiscalization
    DeviceFP700X.RegistrationOfSale(LSaleDetail);

    // Store in Model
    FSale.RegistrationOfSale(LSaleDetail);

    // Store in MemTable
    DataModuleSale.UpdateSalePayments(FSale);
    DataModuleSale.RegistrationOfSale(LSaleDetail);

  end;
end;

procedure TModelSale.RegistrationOfCancellation;
var
  LCurrentSaleDetailGID: String;
  LCurrentSaleDetail: IModelClassSaleDetail;
  LSaleCancellation: IModelClassSaleCancellation;
begin
  LCurrentSaleDetailGID := DataModuleSale.CurrentSaleDetailGID;
  LCurrentSaleDetail := FSale.GetSaleDetailByGID(LCurrentSaleDetailGID);
  if not Assigned(LCurrentSaleDetail) then Exit;
  LSaleCancellation := LCurrentSaleDetail.ToSaleCancellation;

  if ItemIsValidForCancellation(LSaleCancellation) then begin
    // Fiscalization
    DeviceFP700X.RegistrationOfCancelation(LSaleCancellation);

    // Store in Model
    LCurrentSaleDetail.IsCancelled := 'да';
    LCurrentSaleDetail.UpdateInDataSet;
    FSale.RegistrationOfCancelation(LSaleCancellation);

    // Store in MemTable
    DataModuleSale.UpdateSalePayments(FSale);
    DataModuleSale.RegistrationOfCancelation(LSaleCancellation);

    DataModuleSale.FDMemTableSaleDetails.Last;
  end;
end;

procedure TModelSale.Totals;
begin
  if FSale.VoucherPayment.ToDouble > 0 then begin
    if not FSale.Payments.Include('voucher', FSale.VoucherPayment) then begin
      DeviceFP700X.VoucherTotal(FSale);
      FSale.VoucherTotal;
    end;
  end;

  if FSale.CardPayment.ToDouble > 0 then begin
    if not FSale.Payments.Include('card', FSale.CardPayment) then begin
      DeviceFP700X.CardTotal(FSale);
      FSale.CardTotal;
    end;
  end;

  if FSale.CashPayment.ToDouble > 0 then begin
    if not FSale.Payments.Include('cash', FSale.CashPayment) then begin
      DeviceFP700X.CashTotal(FSale);
      FSale.CashTotal;
    end;
  end;

  DataModuleSale.Totals(FSale);
end;

procedure TModelSale.CloseSale;
begin
  // Fiscalization
  DeviceFP700X.CloseSale(FSale);

  // Close in MemTable
  DataModuleSale.CloseSale(FSale);

  // Close in Model
  FSale.CloseSale;
end;

procedure TModelSale.DiscardSale;
begin
  // Discard in Fiscal Device
  DeviceFP700X.DiscardSale(FSale);

  // Discard in MemTable
  DataModuleSale.DiscardSale(FSale);

  // Discard in Model
  FSale.DiscardSale;
end;

procedure TModelSale.DuplicateReceipt;
begin
  // Duplicate in Fiscal Device
  DeviceFP700X.DuplicateReceipt;
end;


// Sale's Payments Updates

procedure TModelSale.UpdateSaleCashPayment(const ACashPayment: String);
begin
  FSale.CashPayment := ACashPayment;
  FSale.Returned := (FSale.CashPayment.ToDouble + FSale.VoucherPayment.ToDouble + FSale.CardPayment.ToDouble - FSale.Due.ToDouble).ToString;
  DataModuleSale.UpdateSalePayments(FSale);
end;

procedure TModelSale.UpdateSaleVoucherPayment(const AVoucherPayment: String);
begin
  FSale.VoucherPayment := AVoucherPayment;
  FSale.Returned := (FSale.CashPayment.ToDouble + FSale.VoucherPayment.ToDouble + FSale.CardPayment.ToDouble - FSale.Due.ToDouble).ToString;
  DataModuleSale.UpdateSalePayments(FSale);
end;

procedure TModelSale.UpdateSaleCardPayment(const ACardPayment: String);
begin
  FSale.CardPayment := ACardPayment;
  FSale.Returned := (FSale.CashPayment.ToDouble + FSale.VoucherPayment.ToDouble + FSale.CardPayment.ToDouble - FSale.Due.ToDouble).ToString;
  DataModuleSale.UpdateSalePayments(FSale);
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
