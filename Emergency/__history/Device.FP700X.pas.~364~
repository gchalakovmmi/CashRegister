unit Device.FP700X;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  System.SysUtils,
  System.Variants,
  System.Classes,
  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.Dialogs,
  Vcl.OleServer,
  Interfaces.Enums,
  Interfaces.Model.Pattern.Observer,
  Interfaces.Model.Notification,
  FP3530_TLB,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Cancellation,
  Interfaces.Model.Classes.Sale.Reversal;

type
  TDeviceFP700X = class(TForm, IObservable)
    FP700X: TCFD_BGR;

  {$REGION 'Published Methods'}
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FP700XError(ASender: TObject; error_Code: Integer; var error_Message: WideString);
  {$ENDREGION}

  {$REGION 'Private Methods'}
  private
    procedure SendNotification(const AInterfaceActions: TInterfaceActions);

    procedure StartCOMServer;
    procedure OpenConnection;
    procedure CloseConnection;
    procedure StopCOMServer;

    procedure ReadDateAndTime(var ADeviceDateTime: TDateTime);
    procedure SetDateAndTime(const ADateTime: TDateTime);

    procedure CheckTheStatusOfTheFiscalTransaction;

    procedure CheckAndResolve;
    procedure CheckTimeDifference;

    procedure CashInCashOut(const AType, AAmount: WideString);

    procedure DailyReport(const AType: WideString);
    procedure PeriodReport(const APeriodStart, APeriodFinish: TDate; const AShort: Boolean);


//IsOpen
// 0 - Receipt is closed;
// 1 - Normal receipt is open;
// 2 - Storno receipt is open. Reason "mistake by operator";
// 3 - Storno receipt is open. Reason "refund";
// 4 - Storno receipt is open. Reason "tax base reduction";
// 5 - standard non-fiscal receipt is open;
// Number - The number of the current or the last receipt (1...9999999);
// Items - number of sales registered on the current or the last fiscal receipt (0...9999999);
// Amount - The sum from the current or the last fiscal receipt ( 0.00...9999999.99 or 0...999999999
//depending dec point position );
// Payed - The sum payed for the current or the last receipt ( 0.00...9999999.99 or 0...999999999
//depending dec point position );


    procedure OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
    procedure PrintFiscalText(const AText: WideString);
    procedure PrintSeparatingLine;
    procedure SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
    procedure SubTotal(var ASubTotal: WideString);
    procedure Discount(var ASubTotal: WideString);
    procedure Total(const APaidMode, AAmountIn: WideString; var AStatus, AAmount: WideString);
    procedure DrawerKickOut;
    procedure CloseFiscalReceipt;
    procedure CancelFiscalReceipt;

    procedure OpenReversalReceipt(const AOperatorNumber, AOperatorPassword, ATillNumber, ADocNumber, ADocDateTime, AFiscalDeviceID, AUNP: WideString);

    procedure CloseNonFiscalReceipt;
  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FObservable: IObservable;

    FLastErrorCode: Integer;
    FLastErrorMessage: WideString;

    FErrorCode: WideString;
    FSlipNumber: WideString;
    FCash: Double;

    FTransactionIsOpen: WideString;
    FTransactionNumber: WideString;
    FTransactionItems: WideString;
    FTransactionAmount: WideString;
    FTransactionPayed: WideString;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}


  {$REGION 'Private Properties'}
  private

  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetObservable: IObservable;
  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public
    property Observable: IObservable read GetObservable implements IObservable;

		property ErrorCode: WideString read FErrorCode;
    property SlipNumber: WideString read FSlipNumber;
		property Cash: Double read FCash;
  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    procedure CashCheck;
    procedure CashIn(const AAmount: WideString);
    procedure CashOut(const AAmount: WideString);

    procedure XReport;
    procedure ZReport;
    procedure PReport(const APeriodStart, APeriodFinish: TDate; const AShort: Boolean);

    procedure SetupSale(const ASale: IModelClassSale);
    procedure OpenSale(const ASale: IModelClassSale);
    procedure RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
    procedure VoucherTotal(const ASale: IModelClassSale);
    procedure CardTotal(const ASale: IModelClassSale);
    procedure CashTotal(const ASale: IModelClassSale);
    procedure CloseSale(const ASale: IModelClassSale);
    procedure DiscardSale(const ASale: IModelClassSale);
    procedure DuplicateReceipt;

    procedure OpenReversal(const ASale: IModelClassSale);
    procedure RegistrationOfReversal(const ASaleReversal: IModelClassSaleReversal);
    procedure TotalsOnReversal(const ASaleReversal: IModelClassSaleReversal);
    procedure TotalsOnReversalAll(const ADue: WideString);
    procedure CloseReversal(const ASale: IModelClassSale);
    procedure DiscardReversal(const ASale: IModelClassSale);

    function ReceiptIsClosed: Boolean;
    function FiscalReceiptIsOpen: Boolean;
    function StornoReceiptIsOpen: Boolean;
    function NonFiscalReceiptIsOpen: Boolean;
    function OpenReceiptNumber: String;
    function OpenReceiptItems: String;
    function OpenReceiptWithoutItems: Boolean;
    function OpenReceiptAmount: String;
    function OpenReceiptWithoutDue: Boolean;
    function OpenReceiptPayed: String;
    function OpenReceiptWithNoPayment: Boolean;
    function OpenReceiptWithPartialPayment: Boolean;
    function OpenReceiptWithFullPayment: Boolean;
  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}
  end;


var
  DeviceFP700X: TDeviceFP700X;

implementation

uses
  System.DateUtils,
  Helper.MyFuncs,
  Model_FP700X,
  Model.Notification,
  Model.Pattern.Observer.Observable,
  Globals,
  View.Message,
  Model.AppSettings;

{$R *.dfm}

{$REGION 'Published Methods'}

procedure TDeviceFP700X.FormCreate(Sender: TObject);
begin
  FObservable := CreateObservableClass;
  KillTask('FP3530.exe');
  StartCOMServer;
  OpenConnection;
end;

procedure TDeviceFP700X.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  CloseConnection;
  StopCOMServer;
end;

procedure TDeviceFP700X.FP700XError(ASender: TObject; error_Code: Integer; var error_Message: WideString);
begin
//
end;

{$ENDREGION}


{$REGION 'Private Methods'}

procedure TDeviceFP700X.SendNotification(const AInterfaceActions: TInterfaceActions);
var
  LModelNotification: IModelNotification;
begin
  if Assigned(FObservable) then begin
    LModelNotification := CreateNotificationClass;
    LModelNotification.Actions := AInterfaceActions;
    FObservable.NotifyObservers(LModelNotification);
  end;
end;


procedure TDeviceFP700X.StartCOMServer;
begin
  repeat
    FLastErrorCode := -1;
    try
      try
        FP700X.RemoteMachineName := '';
        FP700X.Connect;
        FLastErrorCode := 0;
      except
        ShowMessage('The program can not detect the driver. ' + sLineBreak + 'Please install "FP3530 - COMServer" or call the support team! ');
      end;
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.OpenConnection;
begin
  repeat
  	FLastErrorCode := 0;
    try
      if not FP700X.connected_ToDevice then begin
        FLastErrorCode := -1;

        FLastErrorCode := FP700X.set_TransportType(ctc_RS232);
        if FLastErrorCode <> 0 then Exit;

        FLastErrorCode := FP700X.set_RS232(G.FiscalDeviceCOMPort, G.FiscalDeviceBaudRate);
        if FLastErrorCode <> 0 then Exit;

        FLastErrorCode := FP700X.open_Connection;
        if FLastErrorCode <> 0 then Exit;
      end;
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.CloseConnection;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := FP700X.close_Connection;
      if FLastErrorCode <> 0 then Exit;
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.StopCOMServer;
begin
  repeat
    FLastErrorCode := -1;
		try
      try
        FP700X.Disconnect;
        FLastErrorCode := 0;
      except
        ShowMessage('The program can not stop COM server');
      end;
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;


procedure TDeviceFP700X.ReadDateAndTime(var ADeviceDateTime: TDateTime);
var
  LDay: WideString;
  LMonth: WideString;
  LYear: WideString;
  LHour: WideString;
  LMinute: WideString;
  LSecond: WideString;
  LDST: WideString;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_062_info_Get_DateTime_01(
        FP700X,
        FErrorCode,
        LDay,
        LMonth,
        LYear,
        LHour,
        LMinute,
        LSecond,
        LDST
      );
      ADeviceDateTime := EncodeDateTime(
        StrToInt(LYear),
        StrToInt(LMonth),
        StrToInt(LDay),
        StrToInt(LHour),
        StrToInt(LMinute),
        StrToInt(LSecond),
        0
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.SetDateAndTime(const ADateTime: TDateTime);
var
  LDateTime: WideString;
  LErrorCode: WideString;
  LYear: Word;
  LMonth: Word;
  LDay: Word;
  LHour: Word;
  LMinute: Word;
  LSecond: Word;
  LMilliSecond: Word;
begin
  repeat
    FLastErrorCode := -1;
    try
      DecodeDateTime(ADateTime, LYear, LMonth, LDay, LHour, LMinute, LSecond, LMilliSecond);
      if LYear > 2000 then Dec(LYear, 2000);
      LDateTime := '';
      LDateTime := LDateTime + LDay.ToString.PadLeft(2, '0') + '-';
      LDateTime := LDateTime + LMonth.ToString.PadLeft(2, '0') + '-';
      LDateTime := LDateTime + LYear.ToString.PadLeft(2, '0') + ' ';
      LDateTime := LDateTime + LHour.ToString.PadLeft(2, '0') + ':';
      LDateTime := LDateTime + LMinute.ToString.PadLeft(2, '0') + ':';
      LDateTime := LDateTime + LSecond.ToString.PadLeft(2, '0');

      FLastErrorCode := Model_FP700X.execute_061_config_Set_DateTime(
        FP700X,         //
        LDateTime,      //
        FErrorCode      //
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;


procedure TDeviceFP700X.CheckTheStatusOfTheFiscalTransaction;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_076_info_Get_FTransactionStatus(
        FP700X,
        FErrorCode,
        FTransactionIsOpen,
        FTransactionNumber,
        FTransactionItems,
        FTransactionAmount,
        FTransactionPayed
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;



procedure TDeviceFP700X.CashInCashOut(const AType, AAmount: WideString);
var
  LInput: WideString;
  LOutput: WideString;
  LResults: TArray<String>;
begin
  repeat
    FLastErrorCode := -1;
    try
      LInput := AType+'\t'+AAmount;
      FLastErrorCode := FP700X.execute_Command(
        70,
        LInput,
        LOutput
      );
      if FLastErrorCode = 0 then begin
        LResults := String(LOutput).Split([#9]);
        FCash := StrToFloat(LResults[1]);
        SendNotification([actFiscalDeviceAfterCashCheck]);
      end;
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.DailyReport(const AType: WideString);
var
  LnRep: WideString;
  LTotalSumA: WideString;
  LTotalSumB: WideString;
  LTotalSumC: WideString;
  LTotalSumD: WideString;
  LTotalSumE: WideString;
  LTotalSumF: WideString;
  LTotalSumG: WideString;
  LTotalSumH: WideString;
  LStornoSumA: WideString;
  LStornoSumB: WideString;
  LStornoSumC: WideString;
  LStornoSumD: WideString;
  LStornoSumE: WideString;
  LStornoSumF: WideString;
  LStornoSumG: WideString;
  LStornoSumH: WideString;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_069_report_DailyClosure_01(
        FP700X,
        AType,
        FErrorCode,
        LnRep,
        LTotalSumA,
        LTotalSumB,
        LTotalSumC,
        LTotalSumD,
        LTotalSumE,
        LTotalSumF,
        LTotalSumG,
        LTotalSumH,
        LStornoSumA,
        LStornoSumB,
        LStornoSumC,
        LStornoSumD,
        LStornoSumE,
        LStornoSumF,
        LStornoSumG,
        LStornoSumH
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.PeriodReport(const APeriodStart, APeriodFinish: TDate; const AShort: Boolean);
var
  LInput: WideString;
  LOutput: WideString;
begin
  repeat
    FLastErrorCode := -1;
    try
      if AShort then begin
        LInput := '0\t'+
          DayOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
          MonthOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
          (YearOf(APeriodStart)-2000).ToString.PadLeft(2, '0')+'\t'+
          DayOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
          MonthOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
          (YearOf(APeriodFinish)-2000).ToString.PadLeft(2, '0')+'\t';
      end else begin
        LInput := '1\t'+
          DayOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
          MonthOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
          (YearOf(APeriodStart)-2000).ToString.PadLeft(2, '0')+'\t'+
          DayOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
          MonthOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
          (YearOf(APeriodFinish)-2000).ToString.PadLeft(2, '0')+'\t';
      end;
      FLastErrorCode := FP700X.execute_Command(
        94,
        LInput,
        LOutput
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;



{TODO -oOwner -cGeneral : ActionItem}
procedure TDeviceFP700X.CheckAndResolve;
begin
  // Check connectivity

  // Check if Fiscal Device ID is same


  // Check if there is time difference
//  CheckTimeDifference;

  // Check Status

  // Check Transaction status

  // Resolve Device issues

  // Resolve transaction issues

end;

procedure TDeviceFP700X.CheckTimeDifference;
var
  LDeviceDateTime: TDateTime;
begin
  ReadDateAndTime(LDeviceDateTime);
  if SecondsBetween(Now, LDeviceDateTime) > 10 then begin
    SetDateAndTime(Now);
  end;
end;





procedure TDeviceFP700X.OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_048_receipt_Fiscal_Open(
        FP700X,
        AOperatorNumber,
        AOperatorPassword,
        AUNP,
        ATillNumber,
        FErrorCode,
        FSlipNumber
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.PrintFiscalText(const AText: WideString);
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_054_receipt_Fiscal_Text(
        FP700X,
        AText,
        '0',
        '0',
        '0',
        '0',
        '0',
        FErrorCode
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.PrintSeparatingLine;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_092_receipt_Separating_Line(
        FP700X,
        '1',
        FErrorCode
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
var
  LQuantity: String;
  LPrice: String;
  LDiscountValue: String;
begin
  repeat
    FLastErrorCode := -1;
    try
      LQuantity := AQuantity;
      LPrice := APrice;
      LDiscountValue := ADiscountValue;
      if LQuantity.ToDouble < 0 then begin
        LPrice := FormatFloat('0.00', -LPrice.ToDouble);
        LQuantity := FormatFloat('0.000', -LQuantity.ToDouble);
        LDiscountValue := FormatFloat('0.00', -LDiscountValue.ToDouble);
      end;
      FLastErrorCode := Model_FP700X.execute_049_receipt_Sale_Un(
        FP700X,
        AItem,
        ATaxCode,
        LPrice,
        LQuantity,
        ADiscountType,
        LDiscountValue,
        '0',
        AMeasure,
        FErrorCode,
        FSlipNumber
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.SubTotal(var ASubTotal: WideString);
var
  LTaxA: WideString;
  LTaxB: WideString;
  LTaxC: WideString;
  LTaxD: WideString;
  LTaxE: WideString;
  LTaxF: WideString;
  LTaxG: WideString;
  LTaxH: WideString;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,
        '0',
        '0',
        '0',
        '0',
        FErrorCode,
        FSlipNumber,
        ASubtotal,
        LTaxA,
        LTaxB,
        LTaxC,
        LTaxD,
        LTaxE,
        LTaxF,
        LTaxG,
        LTaxH
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.Discount(var ASubTotal: WideString);
var
  LTaxA: WideString;
  LTaxB: WideString;
  LTaxC: WideString;
  LTaxD: WideString;
  LTaxE: WideString;
  LTaxF: WideString;
  LTaxG: WideString;
  LTaxH: WideString;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,
        '1',
        '0',
        '4',
        ASubtotal,
        FErrorCode,
        FSlipNumber,
        ASubtotal,
        LTaxA,
        LTaxB,
        LTaxC,
        LTaxD,
        LTaxE,
        LTaxF,
        LTaxG,
        LTaxH
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.Total(const APaidMode, AAmountIn: WideString; var AStatus, AAmount: WideString);
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_053_receipt_Total(
        FP700X,
        APaidMode,
        AAmountIn,
        '',
        FErrorCode,
        AStatus,
        AAmount
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.DrawerKickOut;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_106_receipt_Drawer_KickOut(
        FP700X,
        '100',
        FErrorCode
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.CloseFiscalReceipt;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_056_receipt_Fiscal_Close(
        FP700X,
        FErrorCode,
        FSlipNumber
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.CancelFiscalReceipt;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_060_receipt_Fiscal_Cancel(
        FP700X,
        FErrorCode
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;

procedure TDeviceFP700X.DuplicateReceipt;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_109_receipt_Print_Duplicate(
        FP700X,
        FErrorCode
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;


procedure TDeviceFP700X.OpenReversalReceipt(const AOperatorNumber, AOperatorPassword, ATillNumber, ADocNumber, ADocDateTime, AFiscalDeviceID, AUNP: WideString);
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_043_receipt_StornoOpen_C01(
        FP700X,
        AOperatorNumber,
        AOperatorPassword,
        ATillNumber,
        '1',
        ADocNumber,
        ADocDateTime,
        AFiscalDeviceID,
        '',
        '',
        AUNP,
        FErrorCode,
        FSlipNumber
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;


procedure TDeviceFP700X.CloseNonFiscalReceipt;
begin
  repeat
    FLastErrorCode := -1;
    try
      FLastErrorCode := Model_FP700X.execute_039_receipt_NonFiscal_Close(
        FP700X,
        FErrorCode,
        FSlipNumber
      );
    finally
      if FLastErrorCode <> 0 then begin
        FLastErrorMessage := FP700X.get_ErrorMessageByCode(FLastErrorCode);
        ViewMessage.ShowBadMessagePlus(FLastErrorMessage);
      end;
    end;
  until FLastErrorCode = 0;
end;


{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TDeviceFP700X.GetObservable: IObservable;
begin
  Result := FObservable;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TDeviceFP700X.CashCheck;
begin
  CashInCashOut('0', '0.00');
end;

procedure TDeviceFP700X.CashIn(const AAmount: WideString);
begin
  CashInCashOut('0', AAmount);
end;

procedure TDeviceFP700X.CashOut(const AAmount: WideString);
begin
  CashInCashOut('1', AAmount);
end;


procedure TDeviceFP700X.XReport;
begin
  DailyReport('X');
end;

procedure TDeviceFP700X.ZReport;
begin
  DailyReport('Z');
end;

procedure TDeviceFP700X.PReport(const APeriodStart, APeriodFinish: TDate; const AShort: Boolean);
begin
  PeriodReport(APeriodStart, APeriodFinish, AShort);
end;


procedure TDeviceFP700X.SetupSale(const ASale: IModelClassSale);
begin
  CheckAndResolve;
end;

procedure TDeviceFP700X.OpenSale(const ASale: IModelClassSale);
begin
  OpenFiscalReceipt(
    ASale.UserGID,
    '0000',
    ASale.SaleUniqueID,
    ASale.WorkstationID
  );

  ASale.ReceiptID := SlipNumber;

  PrintFiscalText('КАСИЕР: ' + G.UserName + '     КАСА: ' + ASale.WorkstationID);

  if ASale.ClientGID <> TAppSettings.GetSetting('CommonClientGID') then begin
    PrintFiscalText('КЛИЕНТ: ' + ASale.ClientName);
    PrintFiscalText('БУЛСТАТ: ' + ASale.ClientTaxNumber);
  end;

  PrintSeparatingLine;
end;

procedure TDeviceFP700X.RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleDetails.ItemName,
    '2',
    ASaleDetails.ClientPrice,
    ASaleDetails.Quantity,
    ASaleDetails.DiscountType,
    ASaleDetails.DiscountValue,
    ASaleDetails.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ПРОДАЖБАТА НЕ Е ФИСКАЛИЗИРАНА . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
  LDiscount: WideString;
begin
  SubTotal(LSubTotalBefore);

  LDiscount := FormatFloat('0.00', - ASaleDetails.Quantity.ToDouble * ASaleDetails.ClientPrice.ToDouble);
  Discount(LDiscount);

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ПРОДАЖБАТА НЕ Е ФИСКАЛИЗИРАНА . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleCancellation.ItemName,
    '2',
    ASaleCancellation.ClientPrice,
    ASaleCancellation.Quantity,
    ASaleCancellation.DiscountType,
    ASaleCancellation.DiscountValue,
    ASaleCancellation.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ПРЕМАХВАНЕТО НЕ Е ФИСКАЛИЗИРАНО . . .');
  end;
end;

procedure TDeviceFP700X.VoucherTotal(const ASale: IModelClassSale);
var
  LStatus: WideString;
  LAmount: WideString;
begin
  ASale.Due := OpenReceiptAmount;
  Total('3', ASale.VoucherPayment, LStatus, LAmount);
end;

procedure TDeviceFP700X.CardTotal(const ASale: IModelClassSale);
var
  LStatus: WideString;
  LAmount: WideString;
begin
  ASale.Due := OpenReceiptAmount;
  Total('2', ASale.CardPayment, LStatus, LAmount);
end;

procedure TDeviceFP700X.CashTotal(const ASale: IModelClassSale);
var
  LStatus: WideString;
  LAmount: WideString;
begin
  ASale.Due := OpenReceiptAmount;
  if OpenReceiptAmount.ToDouble > OpenReceiptPayed.ToDouble then begin
    if OpenReceiptAmount.ToDouble > (ASale.CashPayment.ToDouble + OpenReceiptPayed.ToDouble) then begin
      ASale.CashPayment := FormatFloat('0.00', OpenReceiptAmount.ToDouble - OpenReceiptPayed.ToDouble);
    end;
  end;
  ASale.Returned := FormatFloat('0.00', ASale.VoucherPayment.ToDouble + ASale.CardPayment.ToDouble + ASale.CashPayment.ToDouble - ASale.Due.ToDouble);
  ASale.UpdateInDataSet;

  if OpenReceiptAmount.ToDouble > OpenReceiptPayed.ToDouble then begin
    Total('0', ASale.CashPayment, LStatus, LAmount);
  end;
end;

procedure TDeviceFP700X.CloseSale(const ASale: IModelClassSale);
begin
  DrawerKickOut;

  CloseFiscalReceipt;
end;

procedure TDeviceFP700X.DiscardSale(const ASale: IModelClassSale);
begin
  CancelFiscalReceipt;
end;


procedure TDeviceFP700X.OpenReversal(const ASale: IModelClassSale);
begin
  OpenReversalReceipt(
    ASale.UserGID,
    '0000',
    ASale.WorkstationID,
    ASale.SaleID,
    ASale.CreatedDate + ' ' + ASale.CreatedTime,
    ASale.FiscalDeviceID,
    ASale.SaleUniqueID
  );

  PrintFiscalText('КАСИЕР: ' + G.UserName + '     КАСА: ' + ASale.WorkstationID);

  PrintSeparatingLine;
end;

procedure TDeviceFP700X.RegistrationOfReversal(const ASaleReversal: IModelClassSaleReversal);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleReversal.ItemName,
    '2',
    ASaleReversal.ClientPrice,
    ASaleReversal.Quantity,
    ASaleReversal.DiscountType,
    ASaleReversal.DiscountValue,
    ASaleReversal.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('СТОРНИРАНЕТО НЕ Е ФИСКАЛИЗИРАНО . . .');
  end;
end;

procedure TDeviceFP700X.TotalsOnReversal(const ASaleReversal: IModelClassSaleReversal);
var
  LStatus: WideString;
  LAmount: WideString;
begin
  Total('0', ASaleReversal.Total, LStatus, LAmount);
end;

procedure TDeviceFP700X.TotalsOnReversalAll(const ADue: WideString);
var
  LStatus: WideString;
  LAmount: WideString;
begin
  Total('0', ADue, LStatus, LAmount);
end;

procedure TDeviceFP700X.CloseReversal(const ASale: IModelClassSale);
begin
  DrawerKickOut;

  CloseFiscalReceipt;
end;

procedure TDeviceFP700X.DiscardReversal(const ASale: IModelClassSale);
begin
  CancelFiscalReceipt;
end;


function TDeviceFP700X.ReceiptIsClosed: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result := (FTransactionIsOpen = '0');
end;

function TDeviceFP700X.FiscalReceiptIsOpen: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result := (FTransactionIsOpen = '1');
end;

function TDeviceFP700X.StornoReceiptIsOpen: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result :=
    (FTransactionIsOpen = '2') or
    (FTransactionIsOpen = '3') or
    (FTransactionIsOpen = '4');
end;

function TDeviceFP700X.NonFiscalReceiptIsOpen: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result := (FTransactionIsOpen = '5');
end;

function TDeviceFP700X.OpenReceiptNumber: String;
begin
  CheckTheStatusOfTheFiscalTransaction;
  if (FTransactionIsOpen <> '0') then begin
    Result := FTransactionNumber;
  end else begin
    Result := '-1';
  end;
end;

function TDeviceFP700X.OpenReceiptItems: String;
begin
  CheckTheStatusOfTheFiscalTransaction;
  if (FTransactionIsOpen <> '0') then begin
    Result := FTransactionItems;
  end else begin
    Result := '-1';
  end;
end;

function TDeviceFP700X.OpenReceiptWithoutItems: Boolean;
begin
  Result := (OpenReceiptItems = '0');
end;

function TDeviceFP700X.OpenReceiptAmount: String;
begin
  CheckTheStatusOfTheFiscalTransaction;
  if (FTransactionIsOpen <> '0') then begin
    Result := FTransactionAmount;
  end else begin
    Result := '-1';
  end;
end;

function TDeviceFP700X.OpenReceiptWithoutDue: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result :=
    (FTransactionIsOpen <> '0') and
    (FTransactionAmount = '0.00');
end;

function TDeviceFP700X.OpenReceiptPayed: String;
begin
  CheckTheStatusOfTheFiscalTransaction;
  if (FTransactionIsOpen <> '0') then begin
    Result := FTransactionPayed;
  end else begin
    Result := '-1';
  end;
end;

function TDeviceFP700X.OpenReceiptWithNoPayment: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result :=
    (FTransactionIsOpen <> '0') and
    (FTransactionPayed = '0.00');
end;

function TDeviceFP700X.OpenReceiptWithPartialPayment: Boolean;
begin
  ShowMessage('101');
  CheckTheStatusOfTheFiscalTransaction;
  ShowMessage('102');
  Result :=
    (FTransactionIsOpen <> '0') and
    (FTransactionAmount <> FTransactionPayed) and
    (FTransactionPayed <> '0.00');
  ShowMessage('103');
end;

function TDeviceFP700X.OpenReceiptWithFullPayment: Boolean;
begin
  CheckTheStatusOfTheFiscalTransaction;
  Result :=
    (FTransactionIsOpen <> '0') and
    (FTransactionAmount = FTransactionPayed) and
    (FTransactionPayed <> '0.00');
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
