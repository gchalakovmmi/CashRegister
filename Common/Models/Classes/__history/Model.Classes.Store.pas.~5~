unit Model.Classes.Store;

interface

uses
  System.JSON,
  FireDAC.Comp.DataSet,
  Interfaces.Model.Classes.Store;

  function CreateModelClassStore: IModelClassStore;
  function CreateFromDataSetModelClassStore: IModelClassStore;
  function CreateFromJSONModelClassStore(const AJSONObject: TJSONObject): IModelClassStore;
  procedure AssignDataSetModelClassStore(const ADataSet: TFDDataSet);

implementation

uses
  System.IOUtils,
  System.SysUtils,
  System.DateUtils,
  Helper.MyFuncs,
  Model.Generator.GIDs,
  Model.AppSettings,
  Globals,
  View.Message;

type
  TModelClassStore = class(TInterfacedObject, IModelClassStore)

  {$REGION 'Class Properties'}
  private class var
    FDataSet: TFDDataSet;
  public
    class property DataSet: TFDDataSet read FDataSet write FDataSet;
  {$ENDREGION}

  {$REGION 'Private Methods'}
  private
    procedure SaveToFile;
  {$ENDREGION}

  {$REGION 'Private Fields'}
  private
    FGID: String;
    FName: String;
    FAddress: String;
    FAttachedAt: String;
    FModifiedAt: String;
    FDetachedAt: String;
  {$ENDREGION}

  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}

  {$REGION 'Private Properties'}
  private

  {$ENDREGION}

  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetGID: String;
    procedure SetGID(const AValue: String);
    function GetName: String;
    procedure SetName(const AValue: String);
    function GetAddress: String;
    procedure SetAddress(const AValue: String);
    function GetWorkstationID: String;
    procedure SetWorkstationID(const AValue: String);
    function GetAttachedAt: String;
    procedure SetAttachedAt(const AValue: String);
    function GetModifiedAt: String;
    procedure SetModifiedAt(const AValue: String);
    function GetDetachedAt: String;
    procedure SetDetachedAt(const AValue: String);
  {$ENDREGION}

  {$REGION 'Interfaced Properties'}
  public
    ///<sumarry>код на търговския обект в системата</summary>
    property GID: String read GetGID write SetGID;
    ///<sumarry>наименование на търговския обект</summary>
    property Name: String read GetName write SetName;
    ///<sumarry>местонахождение на търговския обект</summary>
    property Address: String read GetAddress write SetAddress;
    ///<sumarry>код на работно място</summary>
    property WorkstationID: String read GetWorkstationID write SetWorkstationID;
    ///<sumarry>дата и час на първоначално конфигуриране на търговския обект в системата</summary>
    property AttachedAt: String read GetAttachedAt write SetAttachedAt;
    ///<sumarry>дата и час на на последна промяна на търговския обект</summary>
    property ModifiedAt: String read GetModifiedAt write SetModifiedAt;
    ///<sumarry>пореден номер на продажбата</summary>
    property DetachedAt: String read GetDetachedAt write SetDetachedAt;
  {$ENDREGION}

  {$REGION 'Interfaced Methods'}
  public
    procedure UpdateFromDataSet;
    procedure UpdateInDataSet;
    function ToJSON: TJSONObject;
  {$ENDREGION}

  {$REGION 'Constructors/Destructors'}
  public
    constructor Create;
    constructor CreateFromJSON(const AJSONObject: TJSONObject);
    destructor Destroy; override;
  {$ENDREGION}
  end;

function CreateModelClassStore: IModelClassStore;
begin
  Result := TModelClassStore.Create;
end;

function CreateFromDataSetModelClassStore: IModelClassStore;
begin
  Result := TModelClassStore.Create;
  Result.UpdateFromDataSet;
end;

function CreateFromJSONModelClassStore(const AJSONObject: TJSONObject): IModelClassStore;
begin
  Result := TModelClassStore.CreateFromJSON(AJSONObject);
end;


procedure AssignDataSetModelClassStore(const ADataSet: TFDDataSet);
begin
  TModelClassStore.DataSet := ADataSet;
end;

{ TModelClassStore }

{$REGION 'Private Methods'}

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TModelClassStore.GetGID: String;
begin
  Result := FGID;
end;

procedure TModelClassStore.SetGID(const AValue: String);
begin
  FGID := AValue;
end;

function TModelClassStore.GetName: String;
begin
  Result := FName;
end;

procedure TModelClassStore.SetName(const AValue: String);
begin
  FName := AValue;
end;

function TModelClassStore.GetAddress: String;
begin
  Result := FAddress;
end;

procedure TModelClassStore.SetAddress(const AValue: String);
begin
  FAddress := AValue;
end;

function TModelClassStore.GetAttachedAt: String;
begin
  Result := FAttachedAt;
end;

procedure TModelClassStore.SetAttachedAt(const AValue: String);
begin
  FAttachedAt := AValue;
end;

function TModelClassStore.GetModifiedAt: String;
begin
  Result := FModifiedAt;
end;

procedure TModelClassStore.SetModifiedAt(const AValue: String);
begin
  FModifiedAt := AValue;
end;

function TModelClassStore.GetDetachedAt: String;
begin
  Result := FDetachedAt;
end;

procedure TModelClassStore.SetDetachedAt(const AValue: String);
begin
  FDetachedAt := AValue;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TModelClassStore.UpdateFromDataSet;
begin
  GID := DataSet.FieldByName('GID').AsString;
  Name := DataSet.FieldByName('Name').AsString;
  AttachedAt := DataSet.FieldByName('AttachedAt').AsString;
  AttachedAt := DataSet.FieldByName('AttachedAt').AsString;
  ModifiedAt := DataSet.FieldByName('ModifiedAt').AsString;
  DetachedAt := DataSet.FieldByName('DetachedAt').AsString;
end;

procedure TModelClassStore.UpdateInDataSet;
begin
  if DataSet.Locate('gid', GID) then begin
    DataSet.Edit;
  end else begin
    DataSet.Append;
  end;

  DataSet.FieldByName('GID').AsString := GID;
  DataSet.FieldByName('Name').AsString := Name;
  DataSet.FieldByName('AttachedAt').AsString := AttachedAt;
  DataSet.FieldByName('WorkstationID').AsString := WorkstationID;
  DataSet.FieldByName('ModifiedAt').AsString := ModifiedAt;
  DataSet.FieldByName('DetachedAt').AsString := DetachedAt;

  DataSet.Post;
end;

function TModelClassStore.ToJSON: TJSONObject;
begin
  Result := TJSONObject.Create;
  Result.AddPair('GID', GID);
  Result.AddPair('Name', Name);
  Result.AddPair('Address', Address);
  Result.AddPair('AttachedAt', AttachedAt);
  Result.AddPair('ModifiedAt', ModifiedAt);
  Result.AddPair('DetachedAt', DetachedAt);
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

constructor TModelClassStore.Create;
begin
  inherited;
  //
end;

constructor TModelClassStore.CreateFromJSON(const AJSONObject: TJSONObject);
begin
  GID := (AJSONObject.GetValue('GID') as TJSONString).Value;
  Name := (AJSONObject.GetValue('Name') as TJSONString).Value;
  Address := (AJSONObject.GetValue('Address') as TJSONString).Value;
  AttachedAt := (AJSONObject.GetValue('AttachedAt') as TJSONString).Value;
  ModifiedAt := (AJSONObject.GetValue('ModifiedAt') as TJSONString).Value;
  DetachedAt := (AJSONObject.GetValue('DetachedAt') as TJSONString).Value;
end;

destructor TModelClassStore.Destroy;
begin
  //
  inherited;
end;

{$ENDREGION}

end.
