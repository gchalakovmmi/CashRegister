unit Model.Classes.Permissions;

interface

uses
  System.JSON,
  FireDAC.Comp.DataSet,
  Interfaces.Model.Classes.Permissions;

  procedure AssignDataSetModelClassPermissions(const ADataSet: TFDDataSet);
  procedure AssignFileNameModelClassPermissions(const AFileName: String);
  function CreateModelClassPermissions: IModelClassPermissions;
  function CreateFromJSONModelClassPermissions(const AJSONArray: TJSONArray): IModelClassPermissions;
  function CreateFromFileModelClassPermissions: IModelClassPermissions; overload;
  function CreateFromFileModelClassPermissions(const AFileName: String): IModelClassPermissions; overload;

implementation

uses
  Globals,
  System.IOUtils,
  System.SysUtils,
  System.Generics.Collections,
  Interfaces.Model.Classes.Permission,
  Model.Classes.Permission;

type
  ///<summary>Таблица - права (разрешения)</summary>
  TModelClassPermissions = class(TInterfacedObject, IModelClassPermissions)

  {$REGION 'Class Properties'}
  private class var
    FDataSet: TFDDataSet;
  public
    class property DataSet: TFDDataSet read FDataSet write FDataSet;
  {$ENDREGION}

  {$REGION 'Private Methods'}
  private
    procedure SaveToFile;
  {$ENDREGION}

  {$REGION 'Private Fields'}
  private
    FList: TList<IModelClassPermission>;
  {$ENDREGION}

  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}

  {$REGION 'Private Properties'}
  private

  {$ENDREGION}

  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetList: TList<IModelClassPermission>;
  {$ENDREGION}

  {$REGION 'Interfaced Properties'}
  public
    property List: TList<IModelClassPermission> read GetList;
  {$ENDREGION}

  {$REGION 'Interfaced Methods'}
  public
    procedure UpdateFromDataSet;
    procedure UpdateInDataSet;
    function ToJSON: TJSONArray;

    procedure Add(const APermission: IModelClassPermission);
    function GetByGID(const AGID: String): IModelClassPermission;
    function GetByName(const AName: String): IModelClassPermission;
  {$ENDREGION}

  {$REGION 'Constructors/Destructors'}
  public
    constructor Create;
    constructor CreateFromJSON(const AJSONArray: TJSONArray);
    destructor Destroy; override;
  {$ENDREGION}
  end;

function CreateModelClassPermissions: IModelClassPermissions;
begin
  Result := TModelClassPermissions.Create;
end;

function CreateFromJSONModelClassPermissions(const AJSONArray: TJSONArray): IModelClassPermissions;
begin
  Result := TModelClassPermissions.CreateFromJSON(AJSONArray);
end;

function CreateFromFileModelClassPermissions(const AFileName: String): IModelClassPermissions;
var
  LText: String;
begin
  if not TFile.Exists(AFileName) then Exit(nil);

  LText := TFile.ReadAllText(AFileName, TEncoding.UTF8);
  Result := CreateFromJSONModelClassPermissions(TJSONObject.ParseJSONValue(LText) as TJSONArray);
end;

procedure AssignDataSetModelClassPermissions(const ADataSet: TFDDataSet);
begin
  TModelClassPermissions.DataSet := ADataSet;
end;

{ TModelClassPermissions }

{$REGION 'Private Methods'}

{$ENDREGION}

{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}

{$REGION 'Interfaced Properties Getters/Setters'}

function TModelClassPermissions.GetList: TList<IModelClassPermission>;
begin
  Result := FList;
end;

{$ENDREGION}

{$REGION 'Interfaced Methods'}

procedure TModelClassPermissions.UpdateFromDataSet;
var
  LPermission: IModelClassPermission;
  LFound: Boolean;
begin
  DataSet.First;
  while not DataSet.Eof do begin
    LFound := False;
    for LPermission in List do begin
      if LPermission.GID = DataSet.FieldByName('gid').Value then begin
        LPermission.UpdateFromDataSet;
        LFound := True;
        Break;
      end;
    end;
    if not LFound then begin
      LPermission := CreateFromDataSetModelClassPermission;
      List.Add(LPermission);
    end;
    DataSet.Next;
  end;
end;

procedure TModelClassPermissions.UpdateInDataSet;
var
  LPermission: IModelClassPermission;
begin
  for LPermission in List do begin
    LPermission.UpdateInDataSet;
  end;
end;

function TModelClassPermissions.ToJSON: TJSONArray;
var
  LPermission: IModelClassPermission;
begin
  Result := TJSONArray.Create;
  for LPermission in List do begin
    Result.Add(LPermission.ToJSON);
  end;
end;

procedure TModelClassPermissions.Add(const APermission: IModelClassPermission);
begin
  List.Add(APermission);
  SaveToFile;
end;

function TModelClassPermissions.GetByGID(const AGID: String): IModelClassPermission;
var
  LPermission: IModelClassPermission;
begin
  Result := nil;
  for LPermission in List do begin
    if LPermission.GID = AGID then begin
      Result := LPermission;
    end;
  end;
end;

function TModelClassPermissions.GetByName(const AName: String): IModelClassPermission;
var
  LPermission: IModelClassPermission;
begin
  Result := nil;
  for LPermission in List do begin
    if LPermission.Name = AName then begin
      Result := LPermission;
    end;
  end;
end;

procedure TModelClassPermissions.SaveToFile;
begin
  TFile.WriteAllText(G.PermissionsFileName, ToJSON.ToString, TEncoding.UTF8);
end;

{$ENDREGION}

{$REGION 'Constructors/Destructors'}

constructor TModelClassPermissions.Create;
begin
  inherited;
  FList := TList<IModelClassPermission>.Create;
end;

constructor TModelClassPermissions.CreateFromJSON(const AJSONArray: TJSONArray);
var
  LJSONValue: TJSONValue;
begin
  inherited;
  FList := TList<IModelClassPermission>.Create;

  for LJSONValue in AJSONArray do begin
    Add(CreateFromJSONModelClassPermission(LJSONValue as TJSONObject));
  end;
end;

destructor TModelClassPermissions.Destroy;
begin
  FList.DisposeOf;
  inherited;
end;

{$ENDREGION}

end.