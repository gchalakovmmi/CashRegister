unit Device.FP700X;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  System.SysUtils,
  System.Variants,
  System.Classes,
  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.Dialogs,
  Vcl.OleServer,
  Interfaces.Enums,
  Interfaces.Model.Pattern.Observer,
  Interfaces.Model.Notification,
  FP3530_TLB,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Cancellation,
  Interfaces.Model.Classes.Sale.Reversal;

type
  TDeviceFP700X = class(TForm, IObservable)
    FP700X: TCFD_BGR;

  {$REGION 'Published Methods'}
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FP700XError(ASender: TObject; error_Code: Integer;
      var error_Message: WideString);
  {$ENDREGION}

  {$REGION 'Private Methods'}
  private
    procedure SendNotification(const AInterfaceActions: TInterfaceActions);

    procedure StartCOMServer;
    procedure OpenConnection;
    procedure CloseConnection;
    procedure StopCOMServer;

    procedure CheckAndResolve;
    procedure CheckTimeDifference;

    procedure OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
    procedure PrintFiscalText(const AText: WideString);
    procedure PrintSeparatingLine;
    procedure SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
    procedure SubTotal(var ASubTotal: WideString);
    procedure Discount(var ASubTotal: WideString);
    procedure Total(const APaidMode, AAmountIn, APinPadPaidMode: WideString);
    procedure DrawerKickOut;
    procedure CloseFiscalReceipt;
    procedure CancelFiscalReceipt;

    procedure OpenReversalReceipt(const AOperatorNumber, AOperatorPassword, ATillNumber, ADocNumber, ADocDateTime, AFiscalDeviceID, AUNP: WideString);


  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FObservable: IObservable;

    FErrorCode: WideString;
    FCash: Double;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private
    function GetErrorCodeI: Integer;
    procedure SetErrorCodeI(AValue: Integer);
  {$ENDREGION}


  {$REGION 'Private Properties'}
  private
		property ErrorCodeI: Integer read GetErrorCodeI write SetErrorCodeI;
  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetObservable: IObservable;
    function GetCash: Double;
  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public
    property Observable: IObservable read GetObservable implements IObservable;

		property ErrorCode: WideString read FErrorCode write FErrorCode;
		property Cash: Double read GetCash;
  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    procedure CashCheck;
    procedure CashIn(const AAmount: WideString);
    procedure CashOut(const AAmount: WideString);

    procedure XReport;
    procedure ZReport;
    procedure PReport(const APeriodStart, APeriodFinish: TDate);

    procedure SetupSale(const ASale: IModelClassSale);
    procedure OpenSale(const ASale: IModelClassSale);
    procedure RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
    procedure Totals(const ASale: IModelClassSale);
    procedure CloseSale(const ASale: IModelClassSale);
    procedure DiscardSale(const ASale: IModelClassSale);
    procedure DuplicateReceipt;

    procedure OpenReversal(const ASale: IModelClassSale);
    procedure RegistrationOfReversal(const ASaleReversal: IModelClassSaleReversal);
    procedure TotalsOnReversal(const ASaleReversal: IModelClassSaleReversal);
    procedure TotalsOnReversalAll(const ADue: WideString);
    procedure CloseReversal(const ASale: IModelClassSale);
    procedure DiscardReversal(const ASale: IModelClassSale);

  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}
  end;


var
  DeviceFP700X: TDeviceFP700X;

implementation

uses
  System.DateUtils,
  Helper.MyFuncs,
  Model_FP700X,
  Model.Notification,
  Model.Pattern.Observer.Observable,
  Globals,
  View.Message;

{$R *.dfm}

{$REGION 'Published Methods'}

procedure TDeviceFP700X.FormCreate(Sender: TObject);
begin
  FObservable := CreateObservableClass;
  KillTask('FP3530.exe');
  StartCOMServer;
  OpenConnection;
end;

procedure TDeviceFP700X.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  CloseConnection;
  StopCOMServer;
end;

procedure TDeviceFP700X.FP700XError(ASender: TObject; error_Code: Integer; var error_Message: WideString);
begin
//
end;

{$ENDREGION}


{$REGION 'Private Methods'}

procedure TDeviceFP700X.SendNotification(const AInterfaceActions: TInterfaceActions);
var
  LModelNotification: IModelNotification;
begin
  if Assigned(FObservable) then begin
    LModelNotification := CreateNotificationClass;
    LModelNotification.Actions := AInterfaceActions;
    FObservable.NotifyObservers(LModelNotification);
  end;
end;


procedure TDeviceFP700X.StartCOMServer;
begin
  if not G.FiscalDevicePresent then Exit;

  try
    try
      FP700X.RemoteMachineName := '';
      FP700X.Connect;
      SendNotification([actFiscalDeviceAfterStartCOMServer]);
    except
      ShowMessage('The program can not detect the driver. ' + sLineBreak + 'Please install "FP3530 - COMServer" or call the support team! ');
      SendNotification([actFiscalDeviceErrorStartCOMServer]);
      Exit;
    end;
  finally
    if FP700X.connected_ToDevice then begin
      SendNotification([actFiscalDeviceAfterOpenConnection]);
    end;
  end;
end;

procedure TDeviceFP700X.OpenConnection;
begin
  if not G.FiscalDevicePresent then Exit;

	ErrorCodeI := 0;
	try
		if not FP700X.connected_ToDevice then begin
      ErrorCodeI := -1;
      try
        try
          ErrorCodeI := FP700X.set_TransportType(ctc_RS232);
          if ErrorCodeI <> 0 then Exit;

          ErrorCodeI := FP700X.set_RS232(G.FiscalDeviceCOMPort, G.FiscalDeviceBaudRate);
          if ErrorCodeI <> 0 then Exit;
          ErrorCodeI := 0;
        except
          On E: Exception do begin
            ShowMessage(E.Message);
            SendNotification([actFiscalDeviceErrorSettingsChange]);
          end;
        end;
      finally
        SendNotification([actFiscalDeviceAfterSettingsChange]);
      end;

			ErrorCodeI := FP700X.open_Connection;
			if ErrorCodeI <> 0 then Exit;
		end;
	finally
		if ErrorCodeI <> 0 then begin
			ShowMessage(FP700X.lastError_Message);
      SendNotification([actFiscalDeviceErrorOpenConnection]);
		end else begin
			if FP700X.connected_ToDevice then begin
				if not FP700X.Active_OnAfterOpenConnection then begin
          SendNotification([actFiscalDeviceAfterOpenConnection]);
        end;
      end;
		end;
	end;
end;

procedure TDeviceFP700X.CloseConnection;
begin
  if not G.FiscalDevicePresent then Exit;

	ErrorCodeI := FP700X.close_Connection;
	if ErrorCodeI <> 0 then begin
    ShowMessage(FP700X.lastError_Message);
    SendNotification([actFiscalDeviceErrorCloseConnection]);
  end;
	if not FP700X.Active_OnAfterCloseConnection then begin
    SendNotification([actFiscalDeviceAfterCloseConnection]);
  end;
end;

procedure TDeviceFP700X.StopCOMServer;
begin
  if not G.FiscalDevicePresent then Exit;

	try
		try
			FP700X.Disconnect;
		except
      SendNotification([actFiscalDeviceErrorStopCOMServer]);
		end;
	finally
    SendNotification([actFiscalDeviceAfterStopCOMServer]);
	end;
end;

{TODO -oOwner -cGeneral : ActionItem}
procedure TDeviceFP700X.CheckAndResolve;
begin
  // Check connectivity

  // Check if Fiscal Device ID is same


  // Check if there is time difference
  CheckTimeDifference;

  // Check Status

  // Check Transaction status

  // Resolve Device issues

  // Resolve transaction issues

end;

procedure TDeviceFP700X.CheckTimeDifference;
var
  LDeviceDateTime: TDateTime;                  //


  function GetDeviceDateTime(var ADeviceDateTime: TDateTime): Integer;
  var
    LResult: Integer;                 //
    ErrorCode: WideString;            //
    Day: WideString;                  //
    Month: WideString;                //
    Year: WideString;                 //
    Hour: WideString;                 //
    Minute: WideString;               //
    Second: WideString;               //
    DST: WideString;
  begin
    if not G.FiscalDevicePresent then Exit;
    Result := -1;

    SendNotification([actFiscalDeviceBeforeCheckTimeDifference]);
    try
      LResult := Model_FP700X.execute_062_info_Get_DateTime_01(
        FP700X,         //
        ErrorCode,      //
        Day,            //
        Month,          //
        Year,           //
        Hour,           //
        Minute,         //
        Second,         //
        DST             //
      );
      if LResult <> 0 then begin
        ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
        SendNotification([actFiscalDeviceErrorCheckTimeDifference]);
      end;
    finally
      ADeviceDateTime := EncodeDateTime(
        StrToInt(Year),
        StrToInt(Month),
        StrToInt(Day),
        StrToInt(Hour),
        StrToInt(Minute),
        StrToInt(Second),
        0
      );
      Result := 0;
      SendNotification([actFiscalDeviceAfterCheckTimeDifference]);
    end;
  end;


begin

  SendNotification([actFiscalDeviceBeforeCheckTimeDifference]);
	try
    if GetDeviceDateTime(LDeviceDateTime) <> 0 then begin
    end;

      LDeviceDateTime := EncodeDateTime(
        StrToInt(Year),
        StrToInt(Month),
        StrToInt(Day),
        StrToInt(Hour),
        StrToInt(Minute),
        StrToInt(Second),
        0
      );

      if SecondsBetween(Now, LDeviceDateTime) > 10 then begin

      end;


      DecodeDateTime(Now, LYear, LMonth, LDay, LHour, LMinute, LSecond, LMilliSecond);
      if LYear > 2000 then Dec(LYear, 2000);
      LDateTime := '';
      LDateTime := LDateTime + Day.ToString.PadLeft(2, '0') + '-';
      LDateTime := LDateTime + Month.ToString.PadLeft(2, '0') + '-';
      LDateTime := LDateTime + Year.ToString.PadLeft(2, '0') + ' ';
      LDateTime := LDateTime + Hour.ToString.PadLeft(2, '0') + ':';
      LDateTime := LDateTime + Minute.ToString.PadLeft(2, '0') + ':';
      LDateTime := LDateTime + Second.ToString.PadLeft(2, '0');

      LResult := Model_FP700X.execute_061_config_Set_DateTime(
        FP700X,         //
        ErrorCode,      //
        Day,            //
        Month,          //
        Year,           //
        Hour,           //
        Minute,         //
        Second,         //
        DST             //
      );
      if LResult <> 0 then begin
        ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
        SendNotification([actFiscalDeviceErrorCheckTimeDifference]);
      end else begin

      end;
    end;
	finally
    SendNotification([actFiscalDeviceAfterCheckTimeDifference]);
	end;
end;





procedure TDeviceFP700X.OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
var
  ErrorCode: WideString;         //
  SlipNumber: WideString;        //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeOpenFiscalCheck]);
	try
    if
      Model_FP700X.execute_048_receipt_Fiscal_Open(
        FP700X,           //
        AOperatorNumber,  //
        AOperatorPassword,//
        AUNP,             //
        ATillNumber,      //
        ErrorCode,        //
        SlipNumber        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorOpenFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterOpenFiscalCheck]);
	end;
end;

procedure TDeviceFP700X.PrintFiscalText(const AText: WideString);
var
  InputText: WideString;         //
  Bold: WideString;              //
  Italic: WideString;            //
  DoubleHeight: WideString;      //
  UnderLine: WideString;         //
  Alignment: WideString;         //
  ErrorCode: WideString;         //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeFiscalText]);
	try
    InputText := AText;
    Bold := '0';
    Italic := '0';
    DoubleHeight := '0';
    UnderLine := '0';
    Alignment := '0';
    if
      Model_FP700X.execute_054_receipt_Fiscal_Text(
        FP700X,       //
        InputText,    //
        Bold,         //
        Italic,       //
        DoubleHeight, //
        UnderLine,    //
        Alignment,    //
        ErrorCode     //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorFiscalText]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterFiscalText]);
	end;
end;

procedure TDeviceFP700X.PrintSeparatingLine;
var
  LineType: WideString;     //
  ErrorCode: WideString;    //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeSeparatingLine]);
	try
    LineType := '1';        //
    if
      Model_FP700X.execute_092_receipt_Separating_Line(
        FP700X,             //
        LineType,           //
        ErrorCode           //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSeparatingLine]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSeparatingLine]);
	end;
end;

procedure TDeviceFP700X.SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
var
  TextRow1: WideString;       //
  TaxGroup: WideString;       //
  SinglePrice: WideString;    //
  Quantity: WideString;       //
  Discount_Type: WideString;  //
  Discount_Value: WideString; //
  Department: WideString;     //
  Measure: WideString;        //
  ErrorCode: WideString;      //
  SlipNumber: WideString;     //

  LResult: Integer;
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeSale]);
	try
    TextRow1 := AItem;                //
    TaxGroup := ATaxCode;             //
    SinglePrice := APrice;            //
    Quantity := AQuantity;            //
    Discount_Type := ADiscountType;   //
    Discount_Value := ADiscountValue; //
    Department := '0';                //
    Measure := AMeasure;
//    ShowMessage(
//      ' | '+
//      TextRow1
//      +' | '+
//      TaxGroup
//      +' | '+
//      SinglePrice
//      +' | '+
//      Quantity
//      +' | '+
//      Discount_Type
//      +' | '+
//      Discount_Value
//      +' | '+
//      Department
//      +' | '+
//      Measure
//      +' | '
//    );
    LResult := Model_FP700X.execute_049_receipt_Sale_Un(
      FP700X,                     //
      TextRow1,                   //
      TaxGroup,                   //
      SinglePrice,                //
      Quantity,                   //
      Discount_Type,              //
      Discount_Value,             //
      Department,                 //
      Measure,                    //
      ErrorCode,                  //
      SlipNumber                  //
    );
    if LResult <> 0 then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSale]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSale]);
	end;
end;

procedure TDeviceFP700X.SubTotal(var ASubTotal: WideString);
var
   ToPrint: WideString;          //
   ToDisplay: WideString;        //
   Discount_Type: WideString;    //
   Discount_Value: WideString;   //
   ErrorCode: WideString;        //
   SlipNumber: WideString;       //
   TaxA: WideString;             //
   TaxB: WideString;             //
   TaxC: WideString;             //
   TaxD: WideString;             //
   TaxE: WideString;             //
   TaxF: WideString;             //
   TaxG: WideString;             //
   TaxH: WideString;             //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeSubTotal]);
	try
    ToPrint := '0';
    ToDisplay := '0';
    Discount_Type := '0';
    Discount_Value := '0';
    if
      Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,               //
        ToPrint,              //
        ToDisplay,            //
        Discount_Type,        //
        Discount_Value,       //
        ErrorCode,            //
        SlipNumber,           //
        ASubtotal,            //
        TaxA,                 //
        TaxB,                 //
        TaxC,                 //
        TaxD,                 //
        TaxE,                 //
        TaxF,                 //
        TaxG,                 //
        TaxH                  //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSubTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSubTotal]);
	end;
end;

procedure TDeviceFP700X.Discount(var ASubTotal: WideString);
var
   ToPrint: WideString;          //
   ToDisplay: WideString;        //
   Discount_Type: WideString;    //
   Discount_Value: WideString;   //
   ErrorCode: WideString;        //
   SlipNumber: WideString;       //
   TaxA: WideString;             //
   TaxB: WideString;             //
   TaxC: WideString;             //
   TaxD: WideString;             //
   TaxE: WideString;             //
   TaxF: WideString;             //
   TaxG: WideString;             //
   TaxH: WideString;             //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeSubTotal]);
	try
    ToPrint := '1';
    ToDisplay := '0';
    Discount_Type := '4';
    Discount_Value := '0';
    if
      Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,               //
        ToPrint,              //
        ToDisplay,            //
        Discount_Type,        //
        ASubtotal,            //
        ErrorCode,            //
        SlipNumber,           //
        ASubtotal,            //
        TaxA,                 //
        TaxB,                 //
        TaxC,                 //
        TaxD,                 //
        TaxE,                 //
        TaxF,                 //
        TaxG,                 //
        TaxH                  //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSubTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSubTotal]);
	end;
end;

procedure TDeviceFP700X.Total(const APaidMode, AAmountIn, APinPadPaidMode: WideString);
var
  ErrorCode: WideString;       //
  AnswerField_01: WideString;  //
  AnswerField_02: WideString;  //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeTotal]);
	try
    if
      Model_FP700X.execute_053_receipt_Total(
        FP700X,               //
        APaidMode,            //
        AAmountIn,            //
        APinPadPaidMode,      //
        ErrorCode,            //
        AnswerField_01,       //
        AnswerField_02        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterTotal]);
	end;
end;

procedure TDeviceFP700X.DrawerKickOut;
var
  LmSec: WideString;
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeDrawerKickOut]);
	try
    LmSec := '100';
    if
      Model_FP700X.execute_106_receipt_Drawer_KickOut(
        FP700X,                //
        LmSec,                 //
        FErrorCode             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorDrawerKickOut]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterDrawerKickOut]);
	end;
end;

procedure TDeviceFP700X.CloseFiscalReceipt;
var
  ErrorCode: WideString;      //
  SlipNumber: WideString;     //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeCloseFiscalCheck]);
	try
    if
      Model_FP700X.execute_056_receipt_Fiscal_Close(
        FP700X,           //
        ErrorCode,        //
        SlipNumber        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCloseFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCloseFiscalCheck]);
	end;
end;

procedure TDeviceFP700X.CancelFiscalReceipt;
var
  ErrorCode: WideString;      //

begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeCancelFiscalCheck]);
	try
    if
      Model_FP700X.execute_060_receipt_Fiscal_Cancel(
        FP700X,           //
        ErrorCode        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCancelFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCancelFiscalCheck]);
	end;
end;

procedure TDeviceFP700X.DuplicateReceipt;
var
  ErrorCode: WideString;      //

begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeDuplicateReceipt]);
	try
    if
      Model_FP700X.execute_109_receipt_Print_Duplicate(
        FP700X,           //
        ErrorCode        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorDuplicateReceipt]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterDuplicateReceipt]);
	end;
end;


procedure TDeviceFP700X.OpenReversalReceipt(const AOperatorNumber, AOperatorPassword, ATillNumber, ADocNumber, ADocDateTime, AFiscalDeviceID, AUNP: WideString);
var
  ErrorCode: WideString;         //
  SlipNumber: WideString;        //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeOpenReversalCheck]);
	try
//    ShowMessage(
//      ' | '+
//      AOperatorNumber
//      +' | '+
//      AOperatorPassword
//      +' | '+
//      ATillNumber
//      +' | '+
//      '1'
//      +' | '+
//      ADocNumber
//      +' | '+
//      ADocDateTime
//      +' | '+
//      AFiscalDeviceID
//      +' | '+
//      ''
//      +' | '+
//      ''
//      +' | '+
//      AUNP
//      +' | '
//    );
    if
      Model_FP700X.execute_043_receipt_StornoOpen_C01(
        FP700X,           //
        AOperatorNumber,  //
        AOperatorPassword,//
        ATillNumber,      //
        '1',              //
        ADocNumber,       //
        ADocDateTime,     //
        AFiscalDeviceID,  //
        '',               //
        '',               //
        AUNP,             //
        ErrorCode,        //
        SlipNumber        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorOpenReversalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterOpenReversalCheck]);
	end;
end;



{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

function TDeviceFP700X.GetErrorCodeI: Integer;
begin
  Result := StrToInt(FErrorCode);
end;

procedure TDeviceFP700X.SetErrorCodeI(AValue: Integer);
begin
  FErrorCode := IntToStr(AValue);
end;

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TDeviceFP700X.GetObservable: IObservable;
begin
  Result := FObservable;
end;

function TDeviceFP700X.GetCash: Double;
begin
  Result := FCash;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TDeviceFP700X.CashCheck;
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeCashCheck]);
	try
    AmountType := '0'; //
    Amount := '0';     // If Amount=0,the only Answer is returned, and receipt does not print.
    if
      Model_FP700X.execute_070_info_Get_CashIn_CashOut(
        FP700X,                                              //
        AmountType,                                          //
        Amount,                                              //
        ErrorCode,                                           //
        CashSum,                                             //
        ServIn,                                              //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashCheck]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashCheck]);
	end;
end;

procedure TDeviceFP700X.CashIn(const AAmount: WideString);
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeCashIn]);
	try
    AmountType := '0'; //
    Amount := AAmount;
    if
      Model_FP700X.execute_070_receipt_CashIn_CashOut(
        FP700X,                                   //
        AmountType,                                      //
        Amount,                                          //
        ErrorCode,                                       //
        CashSum,                                         //
        ServIn,                                          //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashIn]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashIn]);
	end;
end;

procedure TDeviceFP700X.CashOut(const AAmount: WideString);
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeCashOut]);
	try
    AmountType := '1'; //
    Amount := AAmount;
    if
      Model_FP700X.execute_070_receipt_CashIn_CashOut(
        FP700X,                                   //
        AmountType,                                      //
        Amount,                                          //
        ErrorCode,                                       //
        CashSum,                                         //
        ServIn,                                          //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashOut]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashOut]);
	end;
end;


procedure TDeviceFP700X.XReport;
var
   Option: WideString;                 //
   ErrorCode: WideString;              //
   nRep: WideString;                   //
   TotalSum_A: WideString;             //
   TotalSum_B: WideString;             //
   TotalSum_C: WideString;             //
   TotalSum_D: WideString;             //
   TotalSum_E: WideString;             //
   TotalSum_F: WideString;             //
   TotalSum_G: WideString;             //
   TotalSum_H: WideString;             //
   StornoSum_A: WideString;            //
   StornoSum_B: WideString;            //
   StornoSum_C: WideString;            //
   StornoSum_D: WideString;            //
   StornoSum_E: WideString;            //
   StornoSum_F: WideString;            //
   StornoSum_G: WideString;            //
   StornoSum_H: WideString;            //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeXReport]);
	try
    Option := 'X'; //
    if
      Model_FP700X.execute_069_report_DailyClosure_01(
        FP700X,                 //
        Option,                 //
        ErrorCode,              //
        nRep,                   //
        TotalSum_A,             //
        TotalSum_B,             //
        TotalSum_C,             //
        TotalSum_D,             //
        TotalSum_E,             //
        TotalSum_F,             //
        TotalSum_G,             //
        TotalSum_H,             //
        StornoSum_A,            //
        StornoSum_B,            //
        StornoSum_C,            //
        StornoSum_D,            //
        StornoSum_E,            //
        StornoSum_F,            //
        StornoSum_G,            //
        StornoSum_H             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorXReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterXReport]);
	end;
end;

procedure TDeviceFP700X.ZReport;
var
   Option: WideString;                 //
   ErrorCode: WideString;              //
   nRep: WideString;                   //
   TotalSum_A: WideString;             //
   TotalSum_B: WideString;             //
   TotalSum_C: WideString;             //
   TotalSum_D: WideString;             //
   TotalSum_E: WideString;             //
   TotalSum_F: WideString;             //
   TotalSum_G: WideString;             //
   TotalSum_H: WideString;             //
   StornoSum_A: WideString;            //
   StornoSum_B: WideString;            //
   StornoSum_C: WideString;            //
   StornoSum_D: WideString;            //
   StornoSum_E: WideString;            //
   StornoSum_F: WideString;            //
   StornoSum_G: WideString;            //
   StornoSum_H: WideString;            //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforeZReport]);
	try
    Option := 'Z'; //
    if
      Model_FP700X.execute_069_report_DailyClosure_01(
        FP700X,                 //
        Option,                 //
        ErrorCode,              //
        nRep,                   //
        TotalSum_A,             //
        TotalSum_B,             //
        TotalSum_C,             //
        TotalSum_D,             //
        TotalSum_E,             //
        TotalSum_F,             //
        TotalSum_G,             //
        TotalSum_H,             //
        StornoSum_A,            //
        StornoSum_B,            //
        StornoSum_C,            //
        StornoSum_D,            //
        StornoSum_E,            //
        StornoSum_F,            //
        StornoSum_G,            //
        StornoSum_H             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorZReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterZReport]);
	end;
end;

procedure TDeviceFP700X.PReport(const APeriodStart, APeriodFinish: TDate);
var
  From_DateTime: WideString;
  To_DateTime: WideString;
  Input_DocType: WideString;
  ErrorCode: WideString;
  Start_DateTime: WideString;
  End_DateTime: WideString;
  First_DocumentNumber: WideString;
  Last_DocumentNumber: WideString;

  ReportType: WideString;        //
  StartNumber: WideString;       //
  EndNumber: WideString;         //
begin
  if not G.FiscalDevicePresent then Exit;

  SendNotification([actFiscalDeviceBeforePReport]);

  try
    From_DateTime :=
      DayOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
      MonthOf(APeriodStart).ToString.PadLeft(2, '0')+'-'+
      (YearOf(APeriodStart)-2000).ToString.PadLeft(2, '0')+' '+
      HourOf(APeriodStart).ToString.PadLeft(2, '0')+':'+
      MinuteOf(APeriodStart).ToString.PadLeft(2, '0')+':'+
      SecondOf(APeriodStart).ToString.PadLeft(2, '0')+' DST';
    To_DateTime :=
      DayOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
      MonthOf(APeriodFinish).ToString.PadLeft(2, '0')+'-'+
      (YearOf(APeriodFinish)-2000).ToString.PadLeft(2, '0')+' '+
      HourOf(APeriodFinish).ToString.PadLeft(2, '0')+':'+
      MinuteOf(APeriodFinish).ToString.PadLeft(2, '0')+':'+
      SecondOf(APeriodFinish).ToString.PadLeft(2, '0')+' DST';
    Input_DocType := '2';

    ShowMessage(
      ' | '+
      From_DateTime
      +' | '+
      To_DateTime
      +' | '+
      Input_DocType
      +' | '
    );
    if
      Model_FP700X.execute_124_klen_Documents_InRange(
        FP700X,                 //
        From_DateTime,          //
        To_DateTime,            //
        Input_DocType,          //
        ErrorCode,              //
        Start_DateTime,         //
        End_DateTime,           //
        First_DocumentNumber,   //
        Last_DocumentNumber     //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorPReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterPReport]);
  end;

	try
    ReportType := '0';
    StartNumber := First_DocumentNumber;
    EndNumber := Last_DocumentNumber;
    StartNumber := '1';
    EndNumber := '1';
    ShowMessage(
      ' | '+
      ReportType
      +' | '+
      StartNumber
      +' | '+
      EndNumber
      +' | '
    );
    if
      Model_FP700X.execute_095_report_FMByNumRange(
        FP700X,       //
        ReportType,   //
        StartNumber,  //
        EndNumber,    //
        ErrorCode     //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorPReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterPReport]);
	end;
end;


procedure TDeviceFP700X.SetupSale(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  CheckAndResolve;
end;

procedure TDeviceFP700X.OpenSale(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  // Open Fiscal Check
  OpenFiscalReceipt(
    ASale.UserGID,
    '0000',
    ASale.SaleUniqueID,
    ASale.WorkstationID
  );

  // Print Cashier Info
  PrintFiscalText(' ¿—»≈–: ' + G.UserName + '      ¿—¿: ' + ASale.WorkstationID);

  // Print Separator
  PrintSeparatingLine;
end;

procedure TDeviceFP700X.RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  if not G.FiscalDevicePresent then Exit;

  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleDetails.ItemName,
    '2',
    ASaleDetails.ClientPrice,
    ASaleDetails.Quantity,
    ASaleDetails.DiscountType,
    ASaleDetails.DiscountValue,
    ASaleDetails.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('œ–Œƒ¿∆¡¿“¿ Õ≈ ≈ ‘»— ¿À»«»–¿Õ¿ . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
  LDiscount: WideString;
begin
  if not G.FiscalDevicePresent then Exit;

  SubTotal(LSubTotalBefore);

  LDiscount := FormatFloat('0.00', - ASaleDetails.Quantity.ToDouble * ASaleDetails.ClientPrice.ToDouble);
  Discount(LDiscount);

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('œ–Œƒ¿∆¡¿“¿ Õ≈ ≈ ‘»— ¿À»«»–¿Õ¿ . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  if not G.FiscalDevicePresent then Exit;

  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleCancellation.ItemName,
    '2',
    ASaleCancellation.ClientPrice,
    ASaleCancellation.Quantity,
    ASaleCancellation.DiscountType,
    ASaleCancellation.DiscountValue,
    ASaleCancellation.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('œ–≈Ã¿’¬¿Õ≈“Œ Õ≈ ≈ ‘»— ¿À»«»–¿ÕŒ . . .');
  end;
end;

procedure TDeviceFP700X.Totals(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  // Fiscalize Voucher Payment
  if ASale.VoucherPayment.ToDouble > 0 then begin
    Total('3', ASale.VoucherPayment, '');
  end;

  // Fiscalize Card Payment
  if ASale.CardPayment.ToDouble > 0 then begin
    Total('2', ASale.CardPayment, '');
  end;

  // Fiscalize Cash Payment
  if ASale.CashPayment.ToDouble > 0 then begin
    Total('0', ASale.CashPayment, '');
  end;
end;

procedure TDeviceFP700X.CloseSale(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  // Open Till
  DrawerKickOut;

  // Close Fiscal Check
  CloseFiscalReceipt;
end;

procedure TDeviceFP700X.DiscardSale(const ASale: IModelClassSale);
begin
  CancelFiscalReceipt;
end;


procedure TDeviceFP700X.OpenReversal(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  // Open Fiscal Check
  OpenReversalReceipt(
    ASale.UserGID,
    '0000',
    ASale.WorkstationID,
    ASale.SaleID,
    ASale.CreatedDate + ' ' + ASale.CreatedTime + ' DST',
    ASale.FiscalDeviceID,
    ASale.SaleUniqueID
  );

  // Print Cashier Info
  PrintFiscalText(' ¿—»≈–: ' + G.UserName + '      ¿—¿: ' + ASale.WorkstationID);

  // Print Separator
  PrintSeparatingLine;
end;

procedure TDeviceFP700X.RegistrationOfReversal(const ASaleReversal: IModelClassSaleReversal);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  if not G.FiscalDevicePresent then Exit;

  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleReversal.ItemName,
    '2',
    ASaleReversal.ClientPrice,
    ASaleReversal.Quantity,
    ASaleReversal.DiscountType,
    ASaleReversal.DiscountValue,
    ASaleReversal.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('—“Œ–Õ»–¿Õ≈“Œ Õ≈ ≈ ‘»— ¿À»«»–¿ÕŒ . . .');
  end;
end;

procedure TDeviceFP700X.TotalsOnReversal(const ASaleReversal: IModelClassSaleReversal);
begin
  if not G.FiscalDevicePresent then Exit;

  Total('0', ASaleReversal.Total, '');
end;

procedure TDeviceFP700X.TotalsOnReversalAll(const ADue: WideString);
begin
  if not G.FiscalDevicePresent then Exit;

  Total('0', ADue, '');
end;

procedure TDeviceFP700X.CloseReversal(const ASale: IModelClassSale);
begin
  if not G.FiscalDevicePresent then Exit;

  // Open Till
  DrawerKickOut;

  // Close Fiscal Check
  CloseFiscalReceipt;
end;

procedure TDeviceFP700X.DiscardReversal(const ASale: IModelClassSale);
begin
  CancelFiscalReceipt;
end;


{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
