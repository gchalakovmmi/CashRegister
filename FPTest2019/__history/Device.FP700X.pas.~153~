unit Device.FP700X;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  System.SysUtils,
  System.Variants,
  System.Classes,
  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.Dialogs,
  Vcl.OleServer,
  Interfaces.Enums,
  Interfaces.Model.Pattern.Observer,
  Interfaces.Model.Notification,
  FP3530_TLB,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Cancellation;

type
  TDeviceFP700X = class(TForm, IObservable)
    FP700X: TCFD_BGR;

  {$REGION 'Published Methods'}
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  {$ENDREGION}

  {$REGION 'Private Methods'}
  private
    procedure SendNotification(const AInterfaceActions: TInterfaceActions);

    procedure StartCOMServer;
    procedure OpenConnection;
    procedure CloseConnection;
    procedure StopCOMServer;

    procedure CheckAndResolve;
    procedure OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
    procedure PrintFiscalText(const AText: WideString);
    procedure PrintSeparatingLine;
    procedure SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
    procedure SubTotal(var ASubTotal: WideString);
    procedure Discount(var ASubTotal: WideString);
    procedure Total(const APaidMode, AAmountIn, APinPadPaidMode: WideString);
    procedure DrawerKickOut;
    procedure CloseFiscalReceipt;
    procedure CancelFiscalReceipt;

  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FObservable: IObservable;

    FErrorCode: WideString;
    FCash: Double;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private
    function GetErrorCodeI: Integer;
    procedure SetErrorCodeI(AValue: Integer);
  {$ENDREGION}


  {$REGION 'Private Properties'}
  private
		property ErrorCodeI: Integer read GetErrorCodeI write SetErrorCodeI;
  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetObservable: IObservable;
    function GetCash: Double;
  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public
    property Observable: IObservable read GetObservable implements IObservable;

		property ErrorCode: WideString read FErrorCode write FErrorCode;
		property Cash: Double read GetCash;
  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    procedure CashCheck;
    procedure CashIn;
    procedure CashOut;

    procedure XReport;
    procedure ZReport;
    procedure PReport(const APeriodStart, APeriodFinish: TDate);

    procedure SetupSale(const ASale: IModelClassSale);
    procedure OpenSale(const ASale: IModelClassSale);
    procedure RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
    procedure RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
    procedure Totals(const ASale: IModelClassSale);
    procedure CloseSale(const ASale: IModelClassSale);
    procedure DiscardSale(const ASale: IModelClassSale);
  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}
  end;


var
  DeviceFP700X: TDeviceFP700X;

implementation

uses
  Helper.MyFuncs,
  Model_FP700X,
  Model.Notification,
  Model.Pattern.Observer.Observable,
  Globals,
  View.Message;

{$R *.dfm}

{$REGION 'Published Methods'}

procedure TDeviceFP700X.FormCreate(Sender: TObject);
begin
  FObservable := CreateObservableClass;
  KillTask('FP3530.exe');
  StartCOMServer;
  OpenConnection;
end;

procedure TDeviceFP700X.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  CloseConnection;
  StopCOMServer;
end;

{$ENDREGION}


{$REGION 'Private Methods'}

procedure TDeviceFP700X.SendNotification(const AInterfaceActions: TInterfaceActions);
var
  LModelNotification: IModelNotification;
begin
  if Assigned(FObservable) then begin
    LModelNotification := CreateNotificationClass;
    LModelNotification.Actions := AInterfaceActions;
    FObservable.NotifyObservers(LModelNotification);
  end;
end;


procedure TDeviceFP700X.StartCOMServer;
begin
  try
    try
      FP700X.RemoteMachineName := '';
      FP700X.Connect;
      SendNotification([actFiscalDeviceAfterStartCOMServer]);
    except
      ShowMessage('The program can not detect the driver. ' + sLineBreak + 'Please install "FP3530 - COMServer" or call the support team! ');
      SendNotification([actFiscalDeviceErrorStartCOMServer]);
      Exit;
    end;
  finally
    if FP700X.connected_ToDevice then begin
      SendNotification([actFiscalDeviceAfterOpenConnection]);
    end;
  end;
end;

procedure TDeviceFP700X.OpenConnection;
begin
	ErrorCodeI := 0;
	try
		if not FP700X.connected_ToDevice then begin
      ErrorCodeI := -1;
      try
        try
          ErrorCodeI := FP700X.set_TransportType(ctc_RS232);
          if ErrorCodeI <> 0 then Exit;

          ErrorCodeI := FP700X.set_RS232(G.FiscalDeviceCOMPort, G.FiscalDeviceBaudRate);
          if ErrorCodeI <> 0 then Exit;
          ErrorCodeI := 0;
        except
          On E: Exception do begin
            ShowMessage(E.Message);
            SendNotification([actFiscalDeviceErrorSettingsChange]);
          end;
        end;
      finally
        SendNotification([actFiscalDeviceAfterSettingsChange]);
      end;

			ErrorCodeI := FP700X.open_Connection;
			if ErrorCodeI <> 0 then Exit;
		end;
	finally
		if ErrorCodeI <> 0 then begin
			ShowMessage(FP700X.lastError_Message);
      SendNotification([actFiscalDeviceErrorOpenConnection]);
		end else begin
			if FP700X.connected_ToDevice then begin
				if not FP700X.Active_OnAfterOpenConnection then begin
          SendNotification([actFiscalDeviceAfterOpenConnection]);
        end;
      end;
		end;
	end;
end;

procedure TDeviceFP700X.CloseConnection;
begin
	ErrorCodeI := FP700X.close_Connection;
	if ErrorCodeI <> 0 then begin
    ShowMessage(FP700X.lastError_Message);
    SendNotification([actFiscalDeviceErrorCloseConnection]);
  end;
	if not FP700X.Active_OnAfterCloseConnection then begin
    SendNotification([actFiscalDeviceAfterCloseConnection]);
  end;
end;

procedure TDeviceFP700X.StopCOMServer;
begin
	try
		try
			FP700X.Disconnect;
		except
      SendNotification([actFiscalDeviceErrorStopCOMServer]);
		end;
	finally
    SendNotification([actFiscalDeviceAfterStopCOMServer]);
	end;
end;


{TODO -oOwner -cGeneral : ActionItem}
procedure TDeviceFP700X.CheckAndResolve;
begin
//  Model.CheckAndResolve;
end;

procedure TDeviceFP700X.OpenFiscalReceipt(const AOperatorNumber, AOperatorPassword, AUNP, ATillNumber: WideString);
var
  ErrorCode: WideString;         //
  SlipNumber: WideString;        //
begin
  SendNotification([actFiscalDeviceBeforeOpenFiscalCheck]);
	try
    if
      Model_FP700X.execute_048_receipt_Fiscal_Open(
        FP700X,           //
        AOperatorNumber,  //
        AOperatorPassword,//
        AUNP,             //
        ATillNumber,      //
        ErrorCode,        //
        SlipNumber        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorOpenFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterOpenFiscalCheck]);
	end;
end;

procedure TDeviceFP700X.PrintFiscalText(const AText: WideString);
var
  InputText: WideString;         //
  Bold: WideString;              //
  Italic: WideString;            //
  DoubleHeight: WideString;      //
  UnderLine: WideString;         //
  Alignment: WideString;         //
  ErrorCode: WideString;         //
begin
  SendNotification([actFiscalDeviceBeforeFiscalText]);
	try
    InputText := AText;
    Bold := '0';
    Italic := '0';
    DoubleHeight := '0';
    UnderLine := '0';
    Alignment := '0';
    if
      Model_FP700X.execute_054_receipt_Fiscal_Text(
        FP700X,       //
        InputText,    //
        Bold,         //
        Italic,       //
        DoubleHeight, //
        UnderLine,    //
        Alignment,    //
        ErrorCode     //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorFiscalText]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterFiscalText]);
	end;
end;

procedure TDeviceFP700X.PrintSeparatingLine;
var
  LineType: WideString;     //
  ErrorCode: WideString;    //
begin
  SendNotification([actFiscalDeviceBeforeSeparatingLine]);
	try
    LineType := '1';        //
    if
      Model_FP700X.execute_092_receipt_Separating_Line(
        FP700X,             //
        LineType,           //
        ErrorCode           //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSeparatingLine]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSeparatingLine]);
	end;
end;

procedure TDeviceFP700X.SellItem(const AItem, ATaxCode, APrice, AQuantity, ADiscountType, ADiscountValue, AMeasure: WideString);
var
  TextRow1: WideString;       //
  TaxGroup: WideString;       //
  SinglePrice: WideString;    //
  Quantity: WideString;       //
  Discount_Type: WideString;  //
  Discount_Value: WideString; //
  Department: WideString;     //
  Measure: WideString;        //
  ErrorCode: WideString;      //
  SlipNumber: WideString;     //

  LResult: Integer;
begin
  SendNotification([actFiscalDeviceBeforeSale]);
	try
    TextRow1 := AItem;                //
    TaxGroup := ATaxCode;             //
    SinglePrice := APrice;            //
    Quantity := AQuantity;            //
    Discount_Type := ADiscountType;   //
    Discount_Value := ADiscountValue; //
    Department := '0';                //
    Measure := AMeasure;
//    ShowMessage(
//      ' | '+
//      TextRow1
//      +' | '+
//      TaxGroup
//      +' | '+
//      SinglePrice
//      +' | '+
//      Quantity
//      +' | '+
//      Discount_Type
//      +' | '+
//      Discount_Value
//      +' | '+
//      Department
//      +' | '+
//      Measure
//      +' | '
//    );
    LResult := Model_FP700X.execute_049_receipt_Sale_Un(
      FP700X,                     //
      TextRow1,                   //
      TaxGroup,                   //
      SinglePrice,                //
      Quantity,                   //
      Discount_Type,              //
      Discount_Value,             //
      Department,                 //
      Measure,                    //
      ErrorCode,                  //
      SlipNumber                  //
    );
    if LResult <> 0 then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSale]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSale]);
	end;
end;

procedure TDeviceFP700X.SubTotal(var ASubTotal: WideString);
var
   ToPrint: WideString;          //
   ToDisplay: WideString;        //
   Discount_Type: WideString;    //
   Discount_Value: WideString;   //
   ErrorCode: WideString;        //
   SlipNumber: WideString;       //
   TaxA: WideString;             //
   TaxB: WideString;             //
   TaxC: WideString;             //
   TaxD: WideString;             //
   TaxE: WideString;             //
   TaxF: WideString;             //
   TaxG: WideString;             //
   TaxH: WideString;             //
begin
  SendNotification([actFiscalDeviceBeforeSubTotal]);
	try
    ToPrint := '0';
    ToDisplay := '0';
    Discount_Type := '0';
    Discount_Value := '0';
    if
      Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,               //
        ToPrint,              //
        ToDisplay,            //
        Discount_Type,        //
        Discount_Value,       //
        ErrorCode,            //
        SlipNumber,           //
        ASubtotal,            //
        TaxA,                 //
        TaxB,                 //
        TaxC,                 //
        TaxD,                 //
        TaxE,                 //
        TaxF,                 //
        TaxG,                 //
        TaxH                  //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSubTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSubTotal]);
	end;
end;

procedure TDeviceFP700X.Discount(var ASubTotal: WideString);
var
   ToPrint: WideString;          //
   ToDisplay: WideString;        //
   Discount_Type: WideString;    //
   Discount_Value: WideString;   //
   ErrorCode: WideString;        //
   SlipNumber: WideString;       //
   TaxA: WideString;             //
   TaxB: WideString;             //
   TaxC: WideString;             //
   TaxD: WideString;             //
   TaxE: WideString;             //
   TaxF: WideString;             //
   TaxG: WideString;             //
   TaxH: WideString;             //
begin
  SendNotification([actFiscalDeviceBeforeSubTotal]);
	try
    ToPrint := '1';
    ToDisplay := '0';
    Discount_Type := '4';
    Discount_Value := '0';
    if
      Model_FP700X.execute_051_receipt_Subtotal(
        FP700X,               //
        ToPrint,              //
        ToDisplay,            //
        Discount_Type,        //
        ASubtotal,            //
        ErrorCode,            //
        SlipNumber,           //
        ASubtotal,            //
        TaxA,                 //
        TaxB,                 //
        TaxC,                 //
        TaxD,                 //
        TaxE,                 //
        TaxF,                 //
        TaxG,                 //
        TaxH                  //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorSubTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterSubTotal]);
	end;
end;

procedure TDeviceFP700X.Total(const APaidMode, AAmountIn, APinPadPaidMode: WideString);
var
  ErrorCode: WideString;       //
  AnswerField_01: WideString;  //
  AnswerField_02: WideString;  //
begin
  SendNotification([actFiscalDeviceBeforeTotal]);
	try
    if
      Model_FP700X.execute_053_receipt_Total(
        FP700X,               //
        APaidMode,            //
        AAmountIn,            //
        APinPadPaidMode,      //
        ErrorCode,            //
        AnswerField_01,       //
        AnswerField_02        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorTotal]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterTotal]);
	end;
end;

procedure TDeviceFP700X.DrawerKickOut;
var
  LmSec: WideString;
begin
  SendNotification([actFiscalDeviceBeforeDrawerKickOut]);
	try
    LmSec := '100';
    if
      Model_FP700X.execute_106_receipt_Drawer_KickOut(
        FP700X,                //
        LmSec,                 //
        FErrorCode             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorDrawerKickOut]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterDrawerKickOut]);
	end;
end;

procedure TDeviceFP700X.CloseFiscalReceipt;
var
  ErrorCode: WideString;      //
  SlipNumber: WideString;     //
begin
  SendNotification([actFiscalDeviceBeforeCloseFiscalCheck]);
	try
    if
      Model_FP700X.execute_056_receipt_Fiscal_Close(
        FP700X,           //
        ErrorCode,        //
        SlipNumber        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCloseFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCloseFiscalCheck]);
	end;
end;

procedure TDeviceFP700X.CancelFiscalReceipt;
var
  ErrorCode: WideString;      //

begin
  SendNotification([actFiscalDeviceBeforeCancelFiscalCheck]);
	try
    if
      Model_FP700X.execute_060_receipt_Fiscal_Cancel(
        FP700X,           //
        ErrorCode        //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCancelFiscalCheck]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCancelFiscalCheck]);
	end;
end;

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

function TDeviceFP700X.GetErrorCodeI: Integer;
begin
  Result := StrToInt(FErrorCode);
end;

procedure TDeviceFP700X.SetErrorCodeI(AValue: Integer);
begin
  FErrorCode := IntToStr(AValue);
end;

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TDeviceFP700X.GetObservable: IObservable;
begin
  Result := FObservable;
end;

function TDeviceFP700X.GetCash: Double;
begin
  Result := FCash;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TDeviceFP700X.CashCheck;
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  SendNotification([actFiscalDeviceBeforeCashCheck]);
	try
    AmountType := '0'; //
    Amount := '0';     // If Amount=0,the only Answer is returned, and receipt does not print.
    if
      Model_FP700X.execute_070_info_Get_CashIn_CashOut(
        FP700X,                                              //
        AmountType,                                          //
        Amount,                                              //
        ErrorCode,                                           //
        CashSum,                                             //
        ServIn,                                              //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashCheck]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashCheck]);
	end;
end;

procedure TDeviceFP700X.CashIn;
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  SendNotification([actFiscalDeviceBeforeCashIn]);
	try
    AmountType := '0'; //
    Amount := '250.00';
    if
      Model_FP700X.execute_070_receipt_CashIn_CashOut(
        FP700X,                                   //
        AmountType,                                      //
        Amount,                                          //
        ErrorCode,                                       //
        CashSum,                                         //
        ServIn,                                          //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashIn]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashIn]);
	end;
end;

procedure TDeviceFP700X.CashOut;
var
	ErrorCode : WideString; //
	CashSum   : WideString; //
	ServIn    : WideString; //
	ServOut   : WideString; //
	AmountType: WideString; //
	Amount    : WideString; //
begin
  SendNotification([actFiscalDeviceBeforeCashOut]);
	try
    AmountType := '1'; //
    Amount := Format('%.2f', [Cash]);
    if
      Model_FP700X.execute_070_receipt_CashIn_CashOut(
        FP700X,                                   //
        AmountType,                                      //
        Amount,                                          //
        ErrorCode,                                       //
        CashSum,                                         //
        ServIn,                                          //
        ServOut
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorCashOut]);
    end else begin
      FCash := StrToFloat(CashSum);
    end;
	finally
    SendNotification([actFiscalDeviceAfterCashOut]);
	end;
end;


procedure TDeviceFP700X.XReport;
var
   Option: WideString;                 //
   ErrorCode: WideString;              //
   nRep: WideString;                   //
   TotalSum_A: WideString;             //
   TotalSum_B: WideString;             //
   TotalSum_C: WideString;             //
   TotalSum_D: WideString;             //
   TotalSum_E: WideString;             //
   TotalSum_F: WideString;             //
   TotalSum_G: WideString;             //
   TotalSum_H: WideString;             //
   StornoSum_A: WideString;            //
   StornoSum_B: WideString;            //
   StornoSum_C: WideString;            //
   StornoSum_D: WideString;            //
   StornoSum_E: WideString;            //
   StornoSum_F: WideString;            //
   StornoSum_G: WideString;            //
   StornoSum_H: WideString;            //
begin
  SendNotification([actFiscalDeviceBeforeXReport]);
	try
    Option := 'X'; //
    if
      Model_FP700X.execute_069_report_DailyClosure_01(
        FP700X,                 //
        Option,                 //
        ErrorCode,              //
        nRep,                   //
        TotalSum_A,             //
        TotalSum_B,             //
        TotalSum_C,             //
        TotalSum_D,             //
        TotalSum_E,             //
        TotalSum_F,             //
        TotalSum_G,             //
        TotalSum_H,             //
        StornoSum_A,            //
        StornoSum_B,            //
        StornoSum_C,            //
        StornoSum_D,            //
        StornoSum_E,            //
        StornoSum_F,            //
        StornoSum_G,            //
        StornoSum_H             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorXReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterXReport]);
	end;
end;

procedure TDeviceFP700X.ZReport;
var
   Option: WideString;                 //
   ErrorCode: WideString;              //
   nRep: WideString;                   //
   TotalSum_A: WideString;             //
   TotalSum_B: WideString;             //
   TotalSum_C: WideString;             //
   TotalSum_D: WideString;             //
   TotalSum_E: WideString;             //
   TotalSum_F: WideString;             //
   TotalSum_G: WideString;             //
   TotalSum_H: WideString;             //
   StornoSum_A: WideString;            //
   StornoSum_B: WideString;            //
   StornoSum_C: WideString;            //
   StornoSum_D: WideString;            //
   StornoSum_E: WideString;            //
   StornoSum_F: WideString;            //
   StornoSum_G: WideString;            //
   StornoSum_H: WideString;            //
begin
  SendNotification([actFiscalDeviceBeforeZReport]);
	try
    Option := 'Z'; //
    if
      Model_FP700X.execute_069_report_DailyClosure_01(
        FP700X,                 //
        Option,                 //
        ErrorCode,              //
        nRep,                   //
        TotalSum_A,             //
        TotalSum_B,             //
        TotalSum_C,             //
        TotalSum_D,             //
        TotalSum_E,             //
        TotalSum_F,             //
        TotalSum_G,             //
        TotalSum_H,             //
        StornoSum_A,            //
        StornoSum_B,            //
        StornoSum_C,            //
        StornoSum_D,            //
        StornoSum_E,            //
        StornoSum_F,            //
        StornoSum_G,            //
        StornoSum_H             //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorZReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterZReport]);
	end;
end;

procedure TDeviceFP700X.PReport(const APeriodStart, APeriodFinish: TDate);
var
  ReportType: WideString;        //
  StartNumber: WideString;       //
  EndNumber: WideString;         //
  ErrorCode: WideString;         //
begin
  SendNotification([actFiscalDeviceBeforePReport]);
	try
    ReportType := '0';          //
    StartNumber := '';          //
    EndNumber := '';            //
    if
      Model_FP700X.execute_095_report_FMByNumRange(
        FP700X,       //
        ReportType,   //
        StartNumber,  //
        EndNumber,    //
        ErrorCode     //
      ) <> 0
    then begin
      ShowMessage(FP700X.get_ErrorMessageByCode(StrToInt(ErrorCode)));
      SendNotification([actFiscalDeviceErrorPReport]);
    end;
	finally
    SendNotification([actFiscalDeviceAfterPReport]);
	end;
//  OpenFiscalReceipt;
//  PrintFiscalText('---');
//  SellItem('Ïðîáà', '2.000', '0.01');
//  Total('0', '0.02', '');
//  DrawerKickOut;
//  CloseFiscalReceipt;
end;


procedure TDeviceFP700X.SetupSale(const ASale: IModelClassSale);
begin
  CheckAndResolve;
end;

procedure TDeviceFP700X.OpenSale(const ASale: IModelClassSale);
begin
  // Open Fiscal Check
  OpenFiscalReceipt(
    ASale.UserGID,
    '0000',
    ASale.SaleUniqueID,
    ASale.WorkstationID
  );

  // Print Cashier Info
  PrintFiscalText('ÊÀÑÈÅÐ: ' + G.UserName + '     ÊÀÑÀ: ' + ASale.WorkstationID);

  // Print Separator
  PrintSeparatingLine;
end;

procedure TDeviceFP700X.RegistrationOfSale(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleDetails.ItemName,
    '2',
    ASaleDetails.ClientPrice,
    ASaleDetails.Quantity,
    ASaleDetails.DiscountType,
    ASaleDetails.DiscountValue,
    ASaleDetails.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ÏÐÎÄÀÆÁÀÒÀ ÍÅ Å ÔÈÑÊÀËÈÇÈÐÀÍÀ . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfDiscount(const ASaleDetails: IModelClassSaleDetail);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
  LDiscount: WideString;
begin
  SubTotal(LSubTotalBefore);

  LDiscount := FormatFloat('0.00', - ASaleDetails.Quantity.ToDouble * ASaleDetails.ClientPrice.ToDouble);
  Discount(LDiscount);

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ÏÐÎÄÀÆÁÀÒÀ ÍÅ Å ÔÈÑÊÀËÈÇÈÐÀÍÀ . . .');
  end;
end;

procedure TDeviceFP700X.RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
var
  LSubTotalBefore: WideString;
  LSubTotalAfter: WideString;
begin
  SubTotal(LSubTotalBefore);

  SellItem(
    ASaleCancellation.ItemName,
    '2',
    ASaleCancellation.ClientPrice,
    ASaleCancellation.Quantity,
    ASaleCancellation.DiscountType,
    ASaleCancellation.DiscountValue,
    ASaleCancellation.Measure
  );

  SubTotal(LSubTotalAfter);

  if LSubTotalAfter = LSubTotalBefore then begin
    ViewMessage.ShowBadMessagePlus('ÏÐÅÌÀÕÂÀÍÅÒÎ ÍÅ Å ÔÈÑÊÀËÈÇÈÐÀÍÎ . . .');
  end;
end;

procedure TDeviceFP700X.Totals(const ASale: IModelClassSale);
begin
  // Fiscalize Voucher Payment
  if ASale.VoucherPayment.ToDouble > 0 then begin
    Total('3', ASale.VoucherPayment, '');
  end;

  // Fiscalize Card Payment
  if ASale.CardPayment.ToDouble > 0 then begin
    Total('2', ASale.CardPayment, '');
  end;

  // Fiscalize Cash Payment
  if ASale.CashPayment.ToDouble > 0 then begin
    Total('0', ASale.CashPayment, '');
  end;
end;

procedure TDeviceFP700X.CloseSale(const ASale: IModelClassSale);
begin
  // Open Till
  DrawerKickOut;

  // Close Fiscal Check
  CloseFiscalReceipt;
end;

procedure TDeviceFP700X.DiscardSale(const ASale: IModelClassSale);
begin
  CancelFiscalReceipt;
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
