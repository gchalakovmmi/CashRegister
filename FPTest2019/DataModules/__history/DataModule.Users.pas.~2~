unit DataModule.Users;

interface

uses
  System.SysUtils,
  System.Classes;

type
  TDataModuleUsers = class(TDataModule)
  private
    { Private declarations }
  public
    procedure TryToLogin(const APassword: String);
  end;

var
  DataModuleUsers: TDataModuleUsers;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

{$R *.dfm}

uses
  Bde.DBTables,
  Globals;

{ TDataModuleUsers }

procedure TDataModuleUsers.TryToLogin(const APassword: String);
var
  q: TQuery;
begin
  q := TQuery.Create(Self);
  try
    q.DatabaseName := dmMain.folder[ftStructure];
    q.SQL.Add('SELECT DISTINCT Machineinfopacks.ServerID, Users.ID, Users.NAME FROM Users');
    q.SQL.Add('INNER JOIN Userjobs ON (Users.ID = Userjobs.UserID)');
    q.SQL.Add('INNER JOIN Jobinfopacks ON (Userjobs.JobID = Jobinfopacks.JobID)');
    q.SQL.Add('INNER JOIN Machineinfopacks ON (Jobinfopacks.InfoPackID = Machineinfopacks.InfoPackID)');
    q.SQL.Add('WHERE (Machineinfopacks.MachineID = '+IntToStr(dmMain.MachineID)+') AND (Users.PASS = '''+Pass+''')');
    q.Open;
    if q.RecordCount > 0 then begin
      G.UserGID := q.FieldByName('ID').AsString;
      G.UserName := q.FieldByName('NAME').AsString;
      G.IsLoggedUser := True;
    end else begin
      G.IsLoggedUser := False;
    end;
    q.Close;
  finally
    q.Free;
  end;
end;

end.
