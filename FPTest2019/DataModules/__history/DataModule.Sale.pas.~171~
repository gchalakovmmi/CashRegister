unit DataModule.Sale;

interface

uses
  System.SysUtils,
  System.Classes,
  Data.DB,
  Datasnap.DBClient,
  FireDAC.Stan.Intf,
  FireDAC.Stan.Option,
  FireDAC.Stan.Param,
  FireDAC.Stan.Error,
  FireDAC.DatS,
  FireDAC.Phys.Intf,
  FireDAC.DApt.Intf,
  FireDAC.Stan.StorageBin,
  FireDAC.Comp.DataSet,
  FireDAC.Comp.Client,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Cancellation,
  Interfaces.Model.Classes.Sale.Payment,
  Model.Classes.Sale.Detail,
  Model.Classes.Sale.Cancellation,
  Model.Classes.Sale.Payment;

const
  cMaxPayment = 1000;

type
  TDataModuleSale = class(TDataModule)
    DataSourceSale: TDataSource;
      FDMemTableSale: TFDMemTable;
        FDMemTableSaleGID: TStringField;
        FDMemTableSaleStoreID: TStringField;
        FDMemTableSaleStoreName: TStringField;
        FDMemTableSaleWorkstationID: TStringField;
        FDMemTableSaleFiscalDeviceID: TStringField;
        FDMemTableSaleUserGID: TStringField;
        FDMemTableSaleUserName: TStringField;
        FDMemTableSaleSaleID: TStringField;
        FDMemTableSaleSaleUniqueID: TStringField;
        FDMemTableSaleClientGID: TStringField;
        FDMemTableSaleClientName: TStringField;
        FDMemTableSaleClientTaxNumberType: TStringField;
        FDMemTableSaleClientTaxNumber: TStringField;
        FDMemTableSaleClientAddress: TStringField;
        FDMemTableSaleClientReceiver: TStringField;
        FDMemTableSaleClientBuyer: TStringField;
        FDMemTableSaleClientVIPStatus: TStringField;
        FDMemTableSaleClientSurcharge: TStringField;
        FDMemTableSaleInvoiceID: TStringField;
        FDMemTableSaleInvoiceDate: TStringField;
        FDMemTableSaleCreatedDate: TStringField;
        FDMemTableSaleCreatedTime: TStringField;
        FDMemTableSaleCompletedDate: TStringField;
        FDMemTableSaleCompletedTime: TStringField;
        FDMemTableSaleTotalBase: TStringField;
        FDMemTableSaleDiscount: TStringField;
        FDMemTableSaleTotalVAT: TStringField;
        FDMemTableSaleDue: TFloatField;
        FDMemTableSaleCashPayment: TFloatField;
        FDMemTableSaleVoucherPayment: TFloatField;
        FDMemTableSaleCardPayment: TFloatField;
        FDMemTableSaleReturned: TFloatField;
        FDMemTableSaleStage: TStringField;
        FDMemTableSaleLastItemName: TStringField;
    DataSourceSaleDetails: TDataSource;
      FDMemTableSaleDetails: TFDMemTable;
        FDMemTableSaleDetailsGID: TStringField;
        FDMemTableSaleDetailsParentGID: TStringField;
        FDMemTableSaleDetailsSaleUniqueID: TStringField;
        FDMemTableSaleDetailsUserGID: TStringField;
        FDMemTableSaleDetailsUserName: TStringField;
        FDMemTableSaleDetailsCreatedDate: TStringField;
        FDMemTableSaleDetailsCreatedTime: TStringField;
        FDMemTableSaleDetailsSaleDate: TStringField;
        FDMemTableSaleDetailsSaleTime: TStringField;
        FDMemTableSaleDetailsTyped: TStringField;
        FDMemTableSaleDetailsItemGID: TStringField;
        FDMemTableSaleDetailsBarCode: TStringField;
        FDMemTableSaleDetailsBaseItemName: TStringField;
        FDMemTableSaleDetailsPackCoeff: TStringField;
        FDMemTableSaleDetailsItemName: TStringField;
        FDMemTableSaleDetailsMeasure: TStringField;
        FDMemTableSaleDetailsQuantity: TStringField;
        FDMemTableSaleDetailsVendorPrice: TStringField;
        FDMemTableSaleDetailsClientSurcharge: TStringField;
        FDMemTableSaleDetailsClientPrice: TStringField;
        FDMemTableSaleDetailsPackDiscount: TStringField;
        FDMemTableSaleDetailsClientPriceBase: TStringField;
        FDMemTableSaleDetailsPrice: TStringField;
        FDMemTableSaleDetailsDiscountValue: TStringField;
        FDMemTableSaleDetailsDiscountType: TStringField;
        FDMemTableSaleDetailsTotalBase: TStringField;
        FDMemTableSaleDetailsVATRate: TStringField;
        FDMemTableSaleDetailsTotalVAT: TStringField;
        FDMemTableSaleDetailsTotal: TStringField;
        FDMemTableSaleDetailsIsCancelled: TStringField;
    DataSourceSaleCancellations: TDataSource;
      FDMemTableSaleCancellations: TFDMemTable;
        FDMemTableSaleCancellationsGID: TStringField;
        FDMemTableSaleCancellationsParentGID: TStringField;
        FDMemTableSaleCancellationsSaleUniqueID: TStringField;
        FDMemTableSaleCancellationsUserGID: TStringField;
        FDMemTableSaleCancellationsUserName: TStringField;
        FDMemTableSaleCancellationsCreatedDate: TStringField;
        FDMemTableSaleCancellationsCreatedTime: TStringField;
        FDMemTableSaleCancellationsCancellationDate: TStringField;
        FDMemTableSaleCancellationsCancellationTime: TStringField;
        FDMemTableSaleCancellationsItemGID: TStringField;
        FDMemTableSaleCancellationsBarCode: TStringField;
        FDMemTableSaleCancellationsBaseItemName: TStringField;
        FDMemTableSaleCancellationsPackCoeff: TStringField;
        FDMemTableSaleCancellationsItemName: TStringField;
        FDMemTableSaleCancellationsMeasure: TStringField;
        FDMemTableSaleCancellationsQuantity: TStringField;
        FDMemTableSaleCancellationsVendorPrice: TStringField;
        FDMemTableSaleCancellationsClientSurcharge: TStringField;
        FDMemTableSaleCancellationsClientPrice: TStringField;
        FDMemTableSaleCancellationsPackDiscount: TStringField;
        FDMemTableSaleCancellationsClientPriceBase: TStringField;
        FDMemTableSaleCancellationsPrice: TStringField;
        FDMemTableSaleCancellationsDiscountValue: TStringField;
        FDMemTableSaleCancellationsDiscountType: TStringField;
        FDMemTableSaleCancellationsTotalBase: TStringField;
        FDMemTableSaleCancellationsVATRate: TStringField;
        FDMemTableSaleCancellationsTotalVAT: TStringField;
        FDMemTableSaleCancellationsTotal: TStringField;
    DataSourceSalePayments: TDataSource;
      FDMemTableSalePayments: TFDMemTable;
        FDMemTableSalePaymentsGID: TStringField;
        FDMemTableSalePaymentsParentGID: TStringField;
        FDMemTableSalePaymentsSaleUniqueID: TStringField;
        FDMemTableSalePaymentsFiscalDeviceID: TStringField;
        FDMemTableSalePaymentsUserGID: TStringField;
        FDMemTableSalePaymentsCreatedDate: TStringField;
        FDMemTableSalePaymentsCompletedDate: TStringField;
        FDMemTableSalePaymentsPaymentDate: TStringField;
        FDMemTableSalePaymentsPaymentType: TStringField;
        FDMemTableSalePaymentsPaymentBase: TStringField;
        FDMemTableSalePaymentsPaymentVAT: TStringField;
        FDMemTableSalePaymentsPayment: TStringField;
    procedure FDMemTableSaleDetailsFilterRecord(DataSet: TDataSet;
      var Accept: Boolean);
    procedure FDMemTableSaleAfterScroll(DataSet: TDataSet);

  {$REGION 'Published Methods'}

  {$ENDREGION}

  {$REGION 'Private Methods'}
  private

  {$ENDREGION}

  {$REGION 'Private Fields'}
  private

  {$ENDREGION}

  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}

  {$REGION 'Private Properties'}
  private

  {$ENDREGION}

  {$REGION 'Interfaced Properties Getters/Setters'}
  public
    function GetCurrentSaleDetailGID: String;
  {$ENDREGION}

  {$REGION 'Interfaced Properties'}
  public
    property CurrentSaleDetailGID: String read GetCurrentSaleDetailGID;
  {$ENDREGION}

  {$REGION 'Interfaced Methods'}
  public
    procedure SetupSale(const ASale: IModelClassSale);
    procedure OpenSale(const ASale: IModelClassSale);
    procedure RegistrationOfSale(const ASaleDetail: IModelClassSaleDetail);
    procedure RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
    procedure Totals(const ASale: IModelClassSale);
    procedure CloseSale(const ASale: IModelClassSale);
    procedure DiscardSale(const ASale: IModelClassSale);

    procedure UpdateSalePayments(const ASale: IModelClassSale);

    procedure RefreshData(const ADate: TDate);
  {$ENDREGION}

  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}

  end;

var
  DataModuleSale: TDataModuleSale;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

uses
  System.DateUtils,
  System.Types,
  System.IOUtils,
  Globals,
  Model.Generator.GIDs,
  Model.AppSettings,
  DataModule.Clients,
  DataModule.Items,
  View.Message,
  Helper.MyFuncs,
  Model.Classes.Sale;

{$R *.dfm}

{ TDataModuleSale }

{$REGION 'Published Methods'}

procedure TDataModuleSale.FDMemTableSaleAfterScroll(DataSet: TDataSet);
begin
  FDMemTableSaleDetails.Filter := 'ParentGID = '+QuotedStr(DataSet.FieldByName('GID').AsString);
end;

{$ENDREGION}


{$REGION 'Private Methods'}

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

function TDataModuleSale.GetCurrentSaleDetailGID: String;
begin
  Result := '-1';
  if FDMemTableSaleDetails.RecordCount > 0 then begin
    if FDMemTableSaleDetailsIsCancelled.AsString = 'не' then begin
      Result := FDMemTableSaleDetailsGID.AsString;
    end;
  end;
end;

{$ENDREGION}


{$REGION 'Interfaced Methods'}

// Sale Actions

procedure TDataModuleSale.SetupSale(const ASale: IModelClassSale);
begin
  FDMemTableSale.DisableControls;
  FDMemTableSale.Close;
  FDMemTableSale.CreateDataSet;
  ASale.UpdateInDataSet;
  FDMemTableSale.EnableControls;
  FDMemTableSale.First;

  FDMemTableSaleDetails.DisableControls;
  FDMemTableSaleDetails.Close;
  FDMemTableSaleDetails.CreateDataSet;
  FDMemTableSaleDetails.Filtered := False;
  FDMemTableSaleDetails.EnableControls;
  FDMemTableSaleDetails.First;
end;

procedure TDataModuleSale.OpenSale(const ASale: IModelClassSale);
begin

  if FDMemTableSale.State in [dsEdit, dsInsert] then FDMemTableSale.Post;
  FDMemTableSale.Edit;
  FDMemTableSaleLastItemName.AsString := '';
  FDMemTableSale.Post;
end;

procedure TDataModuleSale.RegistrationOfSale(const ASaleDetail: IModelClassSaleDetail);
begin
  FDMemTableSaleDetails.DisableControls;
  ASaleDetail.UpdateInDataSet;
  FDMemTableSaleDetails.EnableControls;

  if FDMemTableSale.State in [dsEdit, dsInsert] then FDMemTableSale.Post;
  FDMemTableSale.Edit;
  FDMemTableSaleLastItemName.AsString := ASaleDetail.ItemName;
  FDMemTableSale.Post;
end;

procedure TDataModuleSale.RegistrationOfCancelation(const ASaleCancellation: IModelClassSaleCancellation);
begin
  FDMemTableSaleCancellations.DisableControls;
  ASaleCancellation.UpdateInDataSet;
  FDMemTableSaleDetails.EnableControls;

  if FDMemTableSale.State in [dsEdit, dsInsert] then FDMemTableSale.Post;
  FDMemTableSale.Edit;
  FDMemTableSaleLastItemName.AsString := ASaleCancellation.ItemName;
  FDMemTableSale.Post;
end;

procedure TDataModuleSale.Totals(const ASale: IModelClassSale);
begin

  if FDMemTableSale.State in [dsEdit, dsInsert] then FDMemTableSale.Post;
  FDMemTableSale.Edit;
  FDMemTableSaleLastItemName.AsString := '';
  FDMemTableSale.Post;
// nop
end;

procedure TDataModuleSale.CloseSale(const ASale: IModelClassSale);
begin
  FDMemTableSale.DisableControls;
  FDMemTableSale.Close;
  FDMemTableSale.CreateDataSet;
  FDMemTableSale.EnableControls;

  FDMemTableSaleDetails.DisableControls;
  FDMemTableSaleDetails.Close;
  FDMemTableSaleDetails.CreateDataSet;
  FDMemTableSaleDetails.EnableControls;

  FDMemTableSaleCancellations.DisableControls;
  FDMemTableSaleCancellations.Close;
  FDMemTableSaleCancellations.CreateDataSet;
  FDMemTableSaleCancellations.EnableControls;

  FDMemTableSalePayments.DisableControls;
  FDMemTableSalePayments.Close;
  FDMemTableSalePayments.CreateDataSet;
  FDMemTableSalePayments.EnableControls;
end;

procedure TDataModuleSale.DiscardSale(const ASale: IModelClassSale);
begin
  FDMemTableSale.DisableControls;
  FDMemTableSale.Close;
  FDMemTableSale.CreateDataSet;
  FDMemTableSale.EnableControls;

  FDMemTableSaleDetails.DisableControls;
  FDMemTableSaleDetails.Close;
  FDMemTableSaleDetails.CreateDataSet;
  FDMemTableSaleDetails.EnableControls;

  FDMemTableSaleCancellations.DisableControls;
  FDMemTableSaleCancellations.Close;
  FDMemTableSaleCancellations.CreateDataSet;
  FDMemTableSaleCancellations.EnableControls;

  FDMemTableSalePayments.DisableControls;
  FDMemTableSalePayments.Close;
  FDMemTableSalePayments.CreateDataSet;
  FDMemTableSalePayments.EnableControls;
end;

procedure TDataModuleSale.UpdateSalePayments(const ASale: IModelClassSale);
begin
  if FDMemTableSale.State in [dsEdit, dsInsert] then FDMemTableSale.Post;
  FDMemTableSale.Edit;
  FDMemTableSaleDue.AsString := ASale.Due;
  FDMemTableSaleCashPayment.AsString := ASale.CashPayment;
  FDMemTableSaleVoucherPayment.AsString := ASale.VoucherPayment;
  FDMemTableSaleCardPayment.AsString := ASale.CardPayment;
  FDMemTableSaleReturned.AsString := ASale.Returned;
  FDMemTableSale.Post;
end;


{TODO -oOwner -cGeneral : ActionItem}
procedure TDataModuleSale.RefreshData(const ADate: TDate);
var
  LFolderName: String;
  LSearchOption: TSearchOption;
  LList: TStringDynArray;
  I: Integer;
  LSale: IModelClassSale;
  LSaleDetail: IModelClassSaleDetail;
begin
  LFolderName := G.SalesFolder;
  LFolderName := TPath.Combine(LFolderName, YearOf(ADate).ToString);
  LFolderName := TPath.Combine(LFolderName, MonthOf(ADate).ToString.PadLeft(2, '0'));
  LFolderName := TPath.Combine(LFolderName, DayOf(ADate).ToString.PadLeft(2, '0'));

  { Select the search option }
  LSearchOption := TSearchOption.soTopDirectoryOnly;

  if not TDirectory.Exists(LFolderName) then Exit;

  LList := TDirectory.GetFiles(LFolderName, 'Sale*.json', LSearchOption);

  { Populate the table with the results }
  FDMemTableSale.DisableControls;
  FDMemTableSale.Close;
  FDMemTableSale.CreateDataSet;

  FDMemTableSaleDetails.DisableControls;
  FDMemTableSaleDetails.Close;
  FDMemTableSaleDetails.CreateDataSet;

  for I := 0 to Length(LList) - 1 do begin
    LSale := CreateFromFileModelClassSale(LList[i]);
    LSale.UpdateInDataSet;
    for LSaleDetail in LSale.Details.List do begin
      LSaleDetail.UpdateInDataSet;
    end;
  end;

  FDMemTableSaleDetails.Filtered := True;

  FDMemTableSaleDetails.EnableControls;
  FDMemTableSale.EnableControls;
  FDMemTableSale.First;
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
