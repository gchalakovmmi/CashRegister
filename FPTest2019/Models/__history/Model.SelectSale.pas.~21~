unit Model.SelectSale;

interface

uses
  Interfaces.Model.SelectSale;

  function CreateModelSelectSale: IModelSelectSale;

implementation

uses
  System.SysUtils,
  Vcl.Controls,
  Vcl.Dialogs,
  Device.FP700X,
  View.Message,
  Helper.MyFuncs,
  DataModule.Clients,
  View.SelectClient,
  Model.Classes.Sale,
  Interfaces.Model.Classes.Sale,
  Interfaces.Model.Classes.Sale.Detail,
  Interfaces.Model.Classes.Sale.Reversal, DataModule.Sale;

type
  TModelSelectSale = class(TInterfacedObject, IModelSelectSale)

  {$REGION 'Private Methods'}
  private
    function SaleIsValidForReversal: Boolean;
    procedure RegistrationOfReversalAll;
    procedure UpdateSaleClient;
    procedure RegistrationOfSaleAll;
  {$ENDREGION}


  {$REGION 'Private Fields'}
  private
    FSale: IModelClassSale;
  {$ENDREGION}


  {$REGION 'Private Properties Getters/Setters'}
  private

  {$ENDREGION}


  {$REGION 'Private Properties'}
  private

  {$ENDREGION}


  {$REGION 'Interfaced Properties Getters/Setters'}
  public

  {$ENDREGION}


  {$REGION 'Interfaced Properties'}
  public

  {$ENDREGION}


  {$REGION 'Interfaced Methods'}
  public
    procedure AssignNewClient;
  {$ENDREGION}


  {$REGION 'Constructors/Destructors'}
  public

  {$ENDREGION}
  end;

function CreateModelSelectSale: IModelSelectSale;
begin
  Result := TModelSelectSale.Create;
end;

{ TModelSelectSale }

{$REGION 'Private Methods'}

function TModelSelectSale.SaleIsValidForReversal: Boolean;
begin
  Result := False;

  DeviceFP700X.CashCheck;

  if DeviceFP700X.Cash < FSale.Due.ToDouble then begin
    ViewMessage.ShowBadMessagePlus('НЯМА ДОСТАТЪЧНО НАЛИЧНИ СРЕДСТВА ЗА СТОРНИРАНЕ!');
    Exit(False);
  end;

  if not
    (MessageDlg(
      Format('Потвърдете сторниране на продажба на стойност %.2fлв.', [FSale.Due.ToDouble]),
      mtConfirmation,
      [mbYes, mbNo],
      0,
      mbYes
    ) = mrYes)
  then begin
    Exit(False);
  end;

  Result := True;
end;

procedure TModelSelectSale.RegistrationOfReversalAll;
var
  LCurrentSaleDetail: IModelClassSaleDetail;
  LSaleReversal: IModelClassSaleReversal;
  LDue: String;
begin
  if SaleIsValidForReversal then begin
    LDue := FSale.Due;

    // Open Reversal
    DeviceFP700X.OpenReversal(FSale);

    for LCurrentSaleDetail in FSale.Details.List do begin
      if LCurrentSaleDetail.IsCancelled <> 'да' then begin
        LSaleReversal := LCurrentSaleDetail.ToSaleReversal;
        LSaleReversal.FiscalDeviceID := FSale.FiscalDeviceID;
        LSaleReversal.CompletedDate := FSale.CompletedDate;
        LSaleReversal.CompletedTime := FSale.CompletedTime;

        // Fiscalization
        DeviceFP700X.RegistrationOfReversal(LSaleReversal);

        // Store in Model
        LCurrentSaleDetail.IsCancelled := 'да';
        FSale.Due := FormatFloat('0.00', _Round(FSale.Due.ToDouble - LSaleReversal.Total.ToDouble, 0.01));
        FSale.RegistrationOfReversal(LSaleReversal);
        FSale.ReversalToFile(LSaleReversal);
      end;
    end;

    // Total on Reversal
    DeviceFP700X.TotalsOnReversalAll(LDue);

    // Close Reversal
    DeviceFP700X.CloseReversal(FSale);
  end;
end;

procedure TModelSelectSale.UpdateSaleClient;
begin
  FSale.ClientGID := DataModuleClients.SelectedID.ToString;
  FSale.ClientName := DataModuleClients.SelectedNAME;
  FSale.ClientTaxNumberType := '0';
  FSale.ClientTaxNumber := DataModuleClients.SelectedTAXNUMBER;
  FSale.ClientAddress := '';
  FSale.ClientReceiver := '';
  FSale.ClientBuyer := '';
  FSale.ClientVIPStatus := ''; if DataModuleClients.SelectedVIP then FSale.ClientVIPStatus := '*';
  FSale.ClientSurcharge := FormatFloat('0.00', DataModuleClients.SelectedMARKUP);
  FSale.UpdateInDataSet;
end;

procedure TModelSelectSale.RegistrationOfSaleAll;
var
  LCurrentSaleDetail: IModelClassSaleDetail;
  LSaleReversal: IModelClassSaleReversal;
  LDue: String;
begin
  LDue := FSale.Due;

  // Open Sale
  DeviceFP700X.OpenSale(FSale);

  for LCurrentSaleDetail in FSale.Details.List do begin
    if LCurrentSaleDetail.IsCancelled <> 'да' then begin
      LSaleReversal := LCurrentSaleDetail.ToSaleReversal;
      LSaleReversal.FiscalDeviceID := FSale.FiscalDeviceID;
      LSaleDeReversal.CompletedDate := FSale.CompletedDate;
      LSaleReversal.CompletedTime := FSale.CompletedTime;

      // Fiscalization
      DeviceFP700X.RegistrationOfSale(LCurrentSaleDetail);

      // Store in Model
      LCurrentSaleDetail.IsCancelled := 'да';
      FSale.Due := FormatFloat('0.00', _Round(FSale.Due.ToDouble - LSaleReversal.Total.ToDouble, 0.01));
      FSale.RegistrationOfReversal(LSaleReversal);
      FSale.ReversalToFile(LSaleReversal);
    end;
  end;

  // Total on Sale
  DeviceFP700X.TotalsOnReversalAll(LDue);

  // Close Sale
  DeviceFP700X.CloseSale(FSale);
end;

{$ENDREGION}


{$REGION 'Private Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Properties Getters/Setters'}

{$ENDREGION}


{$REGION 'Interfaced Methods'}

procedure TModelSelectSale.AssignNewClient;
begin
  DataModuleClients.RefreshData;
  SelectClient('!');
  if DataModuleClients.SelectedID > 0 then begin
    FSale := CreateFromFileModelClassSale(DataModuleSale.FDMemTableSaleGID.AsString, DataModuleSale.FDMemTableSaleCreatedDate.AsString);
    RegistrationOfReversalAll;
    UpdateSaleClient;
    RegistrationOfSaleAll;
  end;
end;

{$ENDREGION}


{$REGION 'Constructors/Destructors'}

{$ENDREGION}

end.
